<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <%= render 'shared/meta' %>

  <!-- Favicon -->
  <%= favicon_link_tag 'favicon.ico' %>
  <%= favicon_link_tag 'favicon.svg', type: 'image/svg+xml' %>
  <link rel="apple-touch-icon" href="/favicon.ico">

  <!-- Preconnect para recursos externos (mejora Core Web Vitals) -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <%# Preload LCP (home y producto show) usando helpers %>
  <%= lcp_preload_home_image if controller_path == 'home' && action_name == 'index' %>
  <%= lcp_preload_product_image(@product) if controller_path == 'products' && action_name == 'show' %>

  <!-- Font Awesome: carga directa para garantizar iconos visibles en mobile/nav -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

  <%= stylesheet_link_tag "application", media: "all", "data-turbo-track": "reload" %>
  <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>

  <%# JSON-LD Structured Data from views %>
  <%= yield(:head) if content_for?(:head) %>
</head>


<body>
  <!-- Incluir el partial del banner (movido dentro de body) -->
  <%= render 'layouts/cookies_banner'%>

  <!-- ✅ NAVBAR -->
  <header id="site-header" data-turbo-permanent>
    <%= render 'customers/partials/navbar' %>
  </header>

  <!-- ✅ Main Content con transición (sin skeleton) -->
  <main class="container mt-4 page-main" data-page-transition>
    <%= render 'layouts/flash' %>
    <%= yield %>
  </main>

  <!-- ✅ Floating WhatsApp Button -->
  <%= render 'layouts/floating_whatsapp' %>

  <!-- ✅ Footer (persistente) -->
  <footer id="site-footer" data-turbo-permanent>
    <%= render 'customers/partials/footer' %>
  </footer>

  <script>
    (function(){
      if(window.__layoutSpacingInit) return;
      window.__layoutSpacingInit = true;
      function recalcLayout(){
        const nav = document.querySelector('.site-navbar');
        if(!nav) return;
        requestAnimationFrame(()=>{
          const navH = nav.offsetHeight;
          document.documentElement.style.setProperty('--nav-height', navH + 'px');
          document.body.style.paddingTop = navH + 'px';
        });
      }
      ['turbo:load','turbo:render'].forEach(ev=>document.addEventListener(ev,recalcLayout));
      window.addEventListener('resize', recalcLayout, {passive:true});
      recalcLayout();
    })();
  </script>

  <script>
  // Transición básica de desvanecido sin skeleton
  (function(){
    if(window.__pageTransitionsInit) return; window.__pageTransitionsInit = true;
    document.addEventListener('turbo:visit', () => {
      const main = document.querySelector('main.page-main');
      if(main){ main.classList.add('is-leaving'); }
    });
    document.addEventListener('turbo:before-render', (e)=>{
      const newMain = e.detail.newBody && e.detail.newBody.querySelector('main.page-main');
      if(newMain){ newMain.classList.add('will-enter'); }
    });
    function finalizeEnter(){
      const main = document.querySelector('main.page-main');
      if(!main) return;
      main.classList.remove('is-leaving');
      main.classList.add('is-entering');
      setTimeout(()=> main.classList.remove('is-entering','will-enter'), 200);
    }
    document.addEventListener('turbo:render', finalizeEnter);
    document.addEventListener('turbo:load', finalizeEnter);
  })();
  </script>

</body>
</html>
