<%# Recursive partial for rendering a location node in the tree %>
<% depth ||= 0 %>
<%
  # Contar inventario directo en esta ubicación
  direct_count = Inventory.where(inventory_location_id: location.id, status: %i[available reserved]).count
  # Contar inventario total incluyendo sub-ubicaciones
  all_ids = [location.id] + location.descendants.pluck(:id)
  total_count = Inventory.where(inventory_location_id: all_ids, status: %i[available reserved]).count
%>
<div class="location-node" data-location-id="<%= location.id %>" data-depth="<%= depth %>">
  <div class="location-row" style="padding-left: <%= 1 + (depth * 1.5) %>rem;">
    <%# Toggle button for expand/collapse %>
    <div class="location-toggle <%= 'no-children' unless location.has_children? %>"
         data-action="click->inventory-locations#toggle"
         data-expanded="true"
         style="cursor: <%= location.has_children? ? 'pointer' : 'default' %>;">
      <% if location.has_children? %>
        <i class="fas fa-chevron-down toggle-icon"></i>
      <% end %>
    </div>

    <%# Location info %>
    <div class="location-info">
      <span class="badge location-type-badge bg-<%= location_type_color(location.location_type) %>">
        <%= location.type_name %>
      </span>
      <strong><%= location.name %></strong>
      <span class="location-code">(<%= location.code %>)</span>
      <% unless location.active? %>
        <span class="badge bg-danger">Inactivo</span>
      <% end %>

      <%# Mostrar contadores de inventario %>
      <% if total_count > 0 %>
        <span class="ms-2">
          <% if location.has_children? && total_count != direct_count %>
            <span class="badge bg-info" title="Piezas en esta ubicación">
              <i class="fas fa-box"></i> <%= direct_count %>
            </span>
            <span class="badge bg-secondary" title="Total incluyendo sub-ubicaciones">
              <i class="fas fa-boxes"></i> <%= total_count %>
            </span>
          <% else %>
            <span class="badge bg-info" title="Piezas en esta ubicación">
              <i class="fas fa-box"></i> <%= direct_count %>
            </span>
          <% end %>
        </span>
      <% elsif !location.has_children? %>
        <span class="badge bg-light text-muted ms-2" title="Sin inventario">
          <i class="fas fa-box-open"></i> 0
        </span>
      <% end %>
    </div>

    <%# Actions %>
    <div class="location-actions">
      <%= link_to new_admin_inventory_location_path(parent_id: location.id),
                  class: 'btn btn-sm btn-outline-success me-1',
                  title: 'Agregar sub-ubicación' do %>
        <i class="fas fa-plus"></i>
      <% end %>
      <%= link_to admin_inventory_location_path(location),
                  class: 'btn btn-sm btn-outline-info me-1',
                  title: 'Ver detalles' do %>
        <i class="fas fa-eye"></i>
      <% end %>
      <%= link_to edit_admin_inventory_location_path(location),
                  class: 'btn btn-sm btn-outline-primary me-1',
                  title: 'Editar' do %>
        <i class="fas fa-pencil-alt"></i>
      <% end %>
      <% if location.leaf? && !Inventory.where(inventory_location_id: location.id).exists? %>
        <%= link_to admin_inventory_location_path(location),
                    data: { turbo_method: :delete, turbo_confirm: "¿Eliminar '#{location.name}'?" },
                    class: 'btn btn-sm btn-outline-danger',
                    title: 'Eliminar' do %>
          <i class="fas fa-trash"></i>
        <% end %>
      <% end %>
    </div>
  </div>

  <%# Children (recursive) %>
  <% if location.children.any? %>
    <div class="location-children">
      <%= render partial: 'location_node', collection: location.children.ordered, as: :location, locals: { depth: depth + 1 } %>
    </div>
  <% end %>
</div>
