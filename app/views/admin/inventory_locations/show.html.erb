<div class="container mt-3">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to 'Ubicaciones', admin_inventory_locations_path %></li>
      <% @inventory_location.ancestors.each do |ancestor| %>
        <li class="breadcrumb-item"><%= link_to ancestor.name, admin_inventory_location_path(ancestor) %></li>
      <% end %>
      <li class="breadcrumb-item active"><%= @inventory_location.name %></li>
    </ol>
  </nav>

  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <span class="badge bg-<%= location_type_color(@inventory_location.location_type) %> me-2">
          <%= @inventory_location.type_name %>
        </span>
        <strong class="fs-5"><%= @inventory_location.name %></strong>
        <span class="text-muted ms-2">(<%= @inventory_location.code %>)</span>
      </div>
      <div class="btn-group">
        <%= link_to new_admin_inventory_location_path(parent_id: @inventory_location.id), class: 'btn btn-success' do %>
          <i class="fas fa-plus"></i> Agregar Sub-ubicación
        <% end %>
        <%= link_to edit_admin_inventory_location_path(@inventory_location), class: 'btn btn-primary' do %>
          <i class="fas fa-pencil-alt"></i> Editar
        <% end %>
      </div>
    </div>

    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6 class="text-muted">Información General</h6>
          <table class="table table-sm">
            <tr>
              <th width="150">Código:</th>
              <td><code><%= @inventory_location.code %></code></td>
            </tr>
            <tr>
              <th>Tipo:</th>
              <td><%= @inventory_location.type_name %></td>
            </tr>
            <tr>
              <th>Estado:</th>
              <td>
                <% if @inventory_location.active? %>
                  <span class="badge bg-success">Activo</span>
                <% else %>
                  <span class="badge bg-danger">Inactivo</span>
                <% end %>
              </td>
            </tr>
            <tr>
              <th>Nivel de profundidad:</th>
              <td><%= @inventory_location.depth %></td>
            </tr>
            <tr>
              <th>Ruta completa:</th>
              <td><small><%= @inventory_location.full_path %></small></td>
            </tr>
            <% if @inventory_location.description.present? %>
              <tr>
                <th>Descripción:</th>
                <td><%= @inventory_location.description %></td>
              </tr>
            <% end %>
          </table>
        </div>

        <div class="col-md-6">
          <h6 class="text-muted">Estadísticas</h6>
          <table class="table table-sm">
            <tr>
              <th width="200">Sub-ubicaciones directas:</th>
              <td><%= @children.count %></td>
            </tr>
            <tr>
              <th>Total sub-ubicaciones:</th>
              <td><%= @inventory_location.descendants.count %></td>
            </tr>
            <tr>
              <th>Inventario en esta ubicación:</th>
              <td>
                <% inv_count = Inventory.where(inventory_location_id: @inventory_location.id).count %>
                <%= inv_count %>
                <% if inv_count > 0 %>
                  <%= link_to '(ver)', admin_inventory_path(inventory_location_id: @inventory_location.id), class: 'ms-1' %>
                <% end %>
              </td>
            </tr>
            <tr>
              <th>Inventario total (incluyendo sub-ubicaciones):</th>
              <td><%= @inventories_count %></td>
            </tr>
          </table>
        </div>
      </div>

      <% if @children.any? %>
        <hr>
        <h6 class="text-muted"><i class="fas fa-sitemap"></i> Sub-ubicaciones (<%= @children.count %>)</h6>
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Nombre</th>
              <th>Código</th>
              <th>Sub-ubicaciones</th>
              <th>Inventario</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @children.each do |child| %>
              <% 
                child_ids = [child.id] + child.descendants.pluck(:id)
                child_inv_count = Inventory.where(inventory_location_id: child_ids, status: %i[available reserved]).count
              %>
              <tr>
                <td><span class="badge bg-<%= location_type_color(child.location_type) %>"><%= child.type_name %></span></td>
                <td><%= link_to child.name, admin_inventory_location_path(child) %></td>
                <td><code><%= child.code %></code></td>
                <td><%= child.children.count %></td>
                <td>
                  <% if child_inv_count > 0 %>
                    <span class="badge bg-info"><i class="fas fa-box"></i> <%= child_inv_count %></span>
                  <% else %>
                    <span class="text-muted">0</span>
                  <% end %>
                </td>
                <td>
                  <% if child.active? %>
                    <span class="badge bg-success">Activo</span>
                  <% else %>
                    <span class="badge bg-danger">Inactivo</span>
                  <% end %>
                </td>
                <td class="text-end">
                  <%= link_to edit_admin_inventory_location_path(child), class: 'btn btn-sm btn-outline-primary' do %>
                    <i class="fas fa-pencil-alt"></i>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>

      <%# Tabla de Inventario en esta ubicación %>
      <hr>
      <h6 class="text-muted">
        <i class="fas fa-boxes"></i> Inventario en esta Ubicación 
        <span class="badge bg-secondary"><%= @direct_inventories.size %></span>
      </h6>
      
      <% if @direct_inventories.any? %>
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
          <table class="table table-sm table-hover">
            <thead class="table-light sticky-top">
              <tr>
                <th>ID</th>
                <th>Producto</th>
                <th>SKU</th>
                <th>Estado</th>
                <th class="text-end">Costo</th>
                <th>Orden de Compra</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody>
              <% @direct_inventories.group_by(&:product).each do |product, items| %>
                <% items.each_with_index do |inv, idx| %>
                  <tr>
                    <td><code>#<%= inv.id %></code></td>
                    <td>
                      <% if idx == 0 %>
                        <div class="d-flex align-items-center">
                          <% if product.product_images.attached? %>
                            <%= image_tag product.product_images.first.variant(resize_to_limit: [30, 30]), class: 'me-2 rounded' %>
                          <% end %>
                          <div>
                            <%= link_to product.product_name, admin_product_path(product), class: 'text-decoration-none' %>
                            <span class="badge bg-light text-dark ms-1">×<%= items.size %></span>
                          </div>
                        </div>
                      <% else %>
                        <small class="text-muted ms-4">└ pieza adicional</small>
                      <% end %>
                    </td>
                    <td><small class="text-muted"><%= product.product_sku %></small></td>
                    <td>
                      <span class="badge bg-<%= inv.status == 'available' ? 'success' : 'info' %>">
                        <%= inv.status %>
                      </span>
                    </td>
                    <td class="text-end"><%= number_to_currency(inv.purchase_cost, unit: '$') %></td>
                    <td>
                      <% if inv.purchase_order %>
                        <%= link_to inv.purchase_order.id, admin_purchase_order_path(inv.purchase_order), class: 'text-decoration-none' %>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                    <td><small class="text-muted"><%= inv.created_at.strftime('%d/%m/%Y') %></small></td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="text-center py-4 text-muted">
          <i class="fas fa-inbox fa-2x mb-2"></i>
          <p class="mb-0">No hay inventario directamente en esta ubicación</p>
          <% if @inventories_count > 0 %>
            <small>Hay <%= @inventories_count %> piezas en las sub-ubicaciones</small>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="card-footer text-muted">
      Creado: <%= @inventory_location.created_at.strftime('%d/%m/%Y %H:%M') %> |
      Última actualización: <%= @inventory_location.updated_at.strftime('%d/%m/%Y %H:%M') %>
    </div>
  </div>

  <div class="mt-3">
    <%= link_to '← Volver a Ubicaciones', admin_inventory_locations_path, class: 'btn btn-outline-secondary' %>
  </div>
</div>
