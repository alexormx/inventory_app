<%# locals: title:, users:, new_path:, edit_path:, include_offline_column:, purchase_stats: {}, sales_stats: {}, last_visits: {} %>
<% purchase_stats ||= {} %>
<% sales_stats ||= {} %>
<% last_visits ||= {} %>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="h5 mb-0"><%= title %></h2>
  <% if new_path.present? %>
    <%= link_to "New", new_path, class: "btn btn-primary btn-sm" %>
  <% end %>

</div>

<div class="table-responsive">
  <table class="table table-sm table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th><%= sort_link('ID', :created) %></th>
        <th><%= sort_link('Usuario', :name) %></th>
        <th>Contacto</th>
        <th>Rol</th>
        <th>Estado</th>
        <th class="text-end"><%= sort_link('Compras', :total_purchases) %></th>
        <th class="text-end"><%= sort_link('Ventas', :total_sales) %></th>
        <th class="text-end"><%= sort_link('Adeudo', :debt) %></th>
        <th><%= sort_link('√öltima Actividad', :last_visit) %></th>
        <th class="text-center">Acciones</th>
      </tr>
    </thead>
    <tbody>
      <% users.each do |u| %>
        <% pstat = (purchase_stats || {})[u.id] || {} %>
        <% sstat = (sales_stats || {})[u.id] || {} %>
        <% last_visit = (last_visits || {})[u.id] %>
        <%# Calcular m√©tricas %>
        <% total_purch = (u.attributes["purchases_total_mxn"] || pstat[:total_value] || 0).to_d %>
        <% total_sales = (u.attributes["sales_total_mxn"] || sstat[:total_value] || 0).to_d %>
        <% balance_due = (u.attributes["balance_due_mxn"] || 0).to_d %>
        <% lv_raw = u.attributes["last_visit_at"] || last_visit %>
        <% lv_time = lv_raw.is_a?(String) ? Time.zone.parse(lv_raw) rescue nil : lv_raw %>
        <% days_since_visit = lv_time ? ((Time.zone.now - lv_time) / 1.day).floor : nil %>
        <% days_since_created = ((Time.zone.now - u.created_at) / 1.day).floor rescue 999 %>
        <% is_vip = total_sales >= 10000 %>
        <% is_new = days_since_created <= 14 %>
        <% is_inactive = days_since_visit.nil? || days_since_visit > 90 %>
        <% has_debt = balance_due > 0 %>
        <tr class="<%= 'table-warning' if has_debt && balance_due > 1000 %>">
          <%# ID %>
          <td class="text-muted small"><%= u.id %></td>
          
          <%# Usuario: Nombre + iniciales/avatar %>
          <td>
            <div class="d-flex align-items-center gap-2">
              <div class="rounded-circle bg-<%= u.role == 'admin' ? 'secondary' : u.role == 'supplier' ? 'primary' : 'success' %> text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 0.75rem;">
                <%= u.name.to_s.split.map(&:first).join.upcase.first(2) %>
              </div>
              <div>
                <div class="fw-medium"><%= u.name %></div>
                <% if is_new %>
                  <span class="badge text-bg-info" style="font-size: 0.65rem;">üÜï Nuevo</span>
                <% end %>
                <% if is_vip %>
                  <span class="badge text-bg-warning" style="font-size: 0.65rem;">‚≠ê VIP</span>
                <% end %>
              </div>
            </div>
          </td>
          
          <%# Contacto: Email + Phone como iconos %>
          <td>
            <div class="d-flex flex-column gap-1">
              <% if u.email.present? %>
                <a href="mailto:<%= u.email %>" class="text-decoration-none small" title="<%= u.email %>">
                  <i class="fa fa-envelope text-muted"></i>
                  <span class="text-truncate" style="max-width: 120px; display: inline-block; vertical-align: middle;"><%= u.email.split('@').first %></span>
                </a>
              <% end %>
              <% if u.phone.present? %>
                <a href="tel:<%= u.phone %>" class="text-decoration-none small" title="<%= u.phone %>">
                  <i class="fa fa-phone text-muted"></i>
                  <%= u.phone %>
                </a>
              <% end %>
            </div>
          </td>
          
          <%# Rol %>
          <td>
            <% role_class = case u.role.to_s
              when 'customer' then 'success'
              when 'supplier' then 'primary'
              when 'admin' then 'secondary'
              else 'secondary'
            end %>
            <span class="badge text-bg-<%= role_class %>"><%= u.role.to_s.capitalize %></span>
            <% if u.respond_to?(:created_offline?) && u.created_offline? %>
              <span class="badge text-bg-warning" title="Cliente offline">üì¥</span>
            <% end %>
            <% if u.respond_to?(:credit_enabled) && u.credit_enabled %>
              <span class="badge text-bg-info" title="Cr√©dito habilitado">üí≥</span>
            <% end %>
          </td>
          
          <%# Estado: Badges de actividad %>
          <td>
            <div class="d-flex flex-wrap gap-1">
              <% if has_debt %>
                <span class="badge text-bg-danger" title="Adeudo pendiente">‚ö†Ô∏è Debe</span>
              <% end %>
              <% if is_inactive %>
                <span class="badge text-bg-secondary" title="Sin actividad > 90 d√≠as">üí§ Inactivo</span>
              <% elsif total_sales > 0 || total_purch > 0 %>
                <span class="badge text-bg-success" title="Usuario activo">‚úì Activo</span>
              <% else %>
                <span class="badge text-bg-light" title="Sin transacciones">Sin actividad</span>
              <% end %>
            </div>
          </td>
          
          <%# Compras %>
          <td class="text-end">
            <% if total_purch > 0 %>
              <span class="fw-medium"><%= number_to_currency(total_purch, precision: 0) %></span>
            <% else %>
              <span class="text-muted">‚Äî</span>
            <% end %>
          </td>
          
          <%# Ventas %>
          <td class="text-end">
            <% if total_sales > 0 %>
              <span class="fw-medium text-success"><%= number_to_currency(total_sales, precision: 0) %></span>
            <% else %>
              <span class="text-muted">‚Äî</span>
            <% end %>
          </td>
          
          <%# Adeudo %>
          <td class="text-end">
            <% if has_debt %>
              <span class="fw-bold text-danger"><%= number_to_currency(balance_due, precision: 0) %></span>
            <% else %>
              <span class="text-muted">‚Äî</span>
            <% end %>
          </td>
          
          <%# √öltima Actividad (combinada) %>
          <td>
            <% if lv_time.present? %>
              <% visit_class = days_since_visit <= 30 ? 'text-bg-success' : days_since_visit <= 90 ? 'text-bg-warning' : 'text-bg-secondary' %>
              <span class="badge <%= visit_class %>" title="<%= lv_time.strftime('%Y-%m-%d %H:%M') %>">
                <i class="fa fa-clock"></i> <%= distance_of_time_in_words_to_now(lv_time) %>
              </span>
            <% else %>
              <span class="badge text-bg-light">Nunca</span>
            <% end %>
            <%# Mostrar √∫ltima compra/venta en tooltip %>
            <% ld = u.attributes["last_purchase_date"] || pstat[:last_date] %>
            <% sd = u.attributes["last_sale_date"] || sstat[:last_date] %>
            <% if ld || sd %>
              <div class="small text-muted mt-1">
                <% if sd %><span title="√öltima venta">üõí <%= sd.is_a?(String) ? sd : sd.strftime('%d/%m') %></span><% end %>
                <% if ld %><span title="√öltima compra" class="ms-1">üì¶ <%= ld.is_a?(String) ? ld : ld.strftime('%d/%m') %></span><% end %>
              </div>
            <% end %>
          </td>
          
          <%# Acciones: Dropdown con quick actions %>
          <td class="text-center">
            <div class="btn-group">
              <% if edit_path %>
                <%= link_to edit_path.call(u), class: "btn btn-outline-secondary btn-sm", data: { turbo_frame: "_top" }, title: "Editar" do %>
                  <i class="fa fa-edit"></i>
                <% end %>
              <% end %>
              <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <%= link_to admin_user_path(u), class: "dropdown-item" do %>
                    <i class="fa fa-eye text-muted"></i> Ver detalle
                  <% end %>
                </li>
                <li>
                  <%= link_to admin_user_shipping_addresses_path(u), class: "dropdown-item" do %>
                    <i class="fa fa-map-marker-alt text-muted"></i> Direcciones
                  <% end %>
                </li>
                <% if u.role == 'customer' %>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <%= link_to admin_sale_orders_path(user_id: u.id), class: "dropdown-item" do %>
                      <i class="fa fa-shopping-cart text-success"></i> Ver ventas
                    <% end %>
                  </li>
                <% end %>
                <% if u.role == 'supplier' %>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <%= link_to admin_purchase_orders_path(supplier_id: u.id), class: "dropdown-item" do %>
                      <i class="fa fa-truck text-primary"></i> Ver compras
                    <% end %>
                  </li>
                <% end %>
                <% if u.email.present? %>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a href="mailto:<%= u.email %>" class="dropdown-item">
                      <i class="fa fa-envelope text-muted"></i> Enviar email
                    </a>
                  </li>
                <% end %>
              </ul>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div class="d-flex justify-content-center">
  <%= paginate users if users.respond_to?(:current_page) %>

</div>

