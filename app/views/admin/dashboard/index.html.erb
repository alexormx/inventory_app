<div class="container">
  <h2 class="mb-3"><i class="fa-solid fa-chart-line"></i> Dashboard</h2>

  <!-- Filtros globales -->
  <div class="card mb-3">
    <div class="card-body py-2">
      <%= form_with url: admin_dashboard_path, method: :get, local: true, class: "row gy-2 gx-2 align-items-end" do |f| %>
        <div class="col-auto">
          <label class="form-label mb-0 small">Rango</label>
          <%= f.select :range,
              options_for_select([
                ['YTD (año en curso)', 'ytd'],
                ['Últimos 30 días', 'last_30'],
                ['Últimos 90 días', 'last_90'],
                ['Este año', 'this_year'],
                ['Personalizado', 'custom']
              ], @range_key),
              {}, class: 'form-select form-select-sm' %>
        </div>
        <div class="col-auto" data-range-custom>
          <label class="form-label mb-0 small">Inicio</label>
          <%= f.date_field :start_date, value: @start_date, class: 'form-control form-control-sm' %>
        </div>
        <div class="col-auto" data-range-custom>
          <label class="form-label mb-0 small">Fin</label>
          <%= f.date_field :end_date, value: @end_date.to_date, class: 'form-control form-control-sm' %>
        </div>
        <div class="col-auto">
          <div class="form-check mt-4">
            <%= f.check_box :exclude_canceled, { checked: @exclude_canceled, class: 'form-check-input' }, 'true', 'false' %>
            <label class="form-check-label">Excluir cancelados</label>
          </div>
        </div>
        <div class="col-auto">
          <%= f.submit 'Aplicar', class: 'btn btn-primary btn-sm' %>
          <%= link_to 'Limpiar filtros', admin_dashboard_path, class: 'btn btn-outline-secondary btn-sm' %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-globe"></i> Mapa mundial: accesos y ventas</span>
          <small class="text-muted">Fuente: Visitor Logs (accesos); Ventas por enviar (placeholder)</small>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
        <!-- KPIs -->
        <div class="row g-3">
          <div class="col-md-2 col-6">
            <div class="card text-bg-light h-100">
              <div class="card-body">
                <div class="small text-muted">Productos</div>
                <div class="fs-4 fw-bold"><%= number_with_delimiter(@total_products) %></div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6">
            <div class="card text-bg-light h-100">
              <div class="card-body">
                <div class="small text-muted">Usuarios</div>
                <div class="fs-4 fw-bold"><%= number_with_delimiter(@total_users) %></div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6">
            <div class="card text-bg-success-subtle h-100">
              <div class="card-body">
                <div class="small text-muted">Ventas YTD</div>
                <div class="fs-5 fw-bold">$ <%= number_with_precision(@sales_ytd, precision: 2, delimiter: ',') %></div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6">
            <div class="card text-bg-warning-subtle h-100">
              <div class="card-body">
                <div class="small text-muted">Compras YTD</div>
                <div class="fs-5 fw-bold">$ <%= number_with_precision(@purchases_ytd, precision: 2, delimiter: ',') %></div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6">
            <div class="card text-bg-primary-subtle h-100">
              <div class="card-body">
                <div class="small text-muted">Ganancia YTD</div>
                <div class="fs-5 fw-bold">$ <%= number_with_precision(@profit_ytd, precision: 2, delimiter: ',') %></div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6">
            <div class="card text-bg-info-subtle h-100">
              <div class="card-body">
                <div class="small text-muted">Margen YTD</div>
                <div class="fs-4 fw-bold"><%= number_to_percentage(@margin_ytd * 100, precision: 1) %></div>
              </div>
            </div>
          </div>
        </div>
              <div id="world-map-visits" style="height: 360px;"></div>
            </div>
            <div class="col-md-6">
              <h6 class="mb-2">Ventas por país</h6>
              <div id="world-map-sales" style="height: 360px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ECharts CDN and world geojson loader -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/map/js/world.js"></script>
<script>
    // Mostrar campos de fecha solo si rango == custom
    document.addEventListener('turbo:load', () => {
      const rangeSel = document.querySelector('select[name="range"]');
      const customFields = document.querySelectorAll('[data-range-custom]');
      const sync = () => {
        const isCustom = rangeSel && rangeSel.value === 'custom';
        customFields.forEach(el => el.style.display = isCustom ? '' : 'none');
      };
      if (rangeSel) {
        rangeSel.addEventListener('change', sync);
      }
      sync();
    });

  document.addEventListener('turbo:load', () => {
    const visitsEl = document.getElementById('world-map-visits');
    const salesEl  = document.getElementById('world-map-sales');
    if (!visitsEl || !salesEl || !(window.echarts)) return;

    Promise.resolve().then(async () => {
      const res = await fetch('<%= admin_dashboard_geo_path(format: :json) %>');
      if (!res.ok) return;
      const data = await res.json();

      const visitsChart = echarts.init(visitsEl);
      const salesChart  = echarts.init(salesEl);

      const commonOpts = (title) => ({
        tooltip: { trigger: 'item', formatter: ({name, value}) => `${name}: ${value?.toLocaleString?.() || value || 0}` },
        visualMap: { min: 0, max: 100, left: 'left', top: 'bottom', text: ['Alto','Bajo'], calculable: true },
        series: [{
          name: title,
          type: 'map',
          map: 'world',
          roam: true,
          emphasis: { label: { show: false } },
          data: []
        }]
      });

      const visitsOpts = commonOpts('Accesos');
      visitsOpts.series[0].data = (data.visits || []).map(d => ({ name: d.name, value: d.value }));
      // Ajustar el rango visual con base en datos
      if (visitsOpts.series[0].data.length) {
        const maxVal = Math.max(...visitsOpts.series[0].data.map(d => d.value));
        visitsOpts.visualMap.max = Math.max(10, maxVal);
      }
      visitsChart.setOption(visitsOpts);

      const salesOpts = commonOpts('Ventas');
      salesOpts.series[0].data = (data.sales_by_country || []).map(d => ({ name: d.name, value: d.value }));
      if (salesOpts.series[0].data.length) {
        const maxVal = Math.max(...salesOpts.series[0].data.map(d => d.value));
        salesOpts.visualMap.max = Math.max(10, maxVal);
      }
      salesChart.setOption(salesOpts);

      // Responsivo
      window.addEventListener('resize', () => { visitsChart.resize(); salesChart.resize(); });
    });
  });
</script>
