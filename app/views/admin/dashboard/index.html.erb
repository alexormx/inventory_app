<div class="container-fluid">
  <!-- ========== 1 · HEADER ========== -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h2 class="mb-0"><i class="fa-solid fa-chart-line"></i> Dashboard</h2>
    <div class="d-flex align-items-center gap-2">
      <span class="badge bg-secondary"><i class="fa-solid fa-calendar"></i> YTD <%= Time.zone.now.year %></span>
      <span class="text-muted small d-none d-md-inline">Actualizado: <%= Time.zone.now.strftime('%d/%m/%Y %H:%M') %></span>
    </div>
  </div>

  <!-- ========== 2 · ACCIONES RÁPIDAS ========== -->
  <div class="d-flex flex-wrap gap-2 mb-3">
    <%= link_to new_admin_sale_order_path, class: 'btn btn-success btn-sm' do %>
      <i class="fa-solid fa-plus"></i> Nueva Venta
    <% end %>
    <%= link_to new_admin_purchase_order_path, class: 'btn btn-primary btn-sm' do %>
      <i class="fa-solid fa-plus"></i> Nueva Compra
    <% end %>
    <%= link_to admin_products_path(filter: 'low_stock'), class: 'btn btn-outline-danger btn-sm' do %>
      <i class="fa-solid fa-box-open"></i> Stock Crítico
    <% end %>
    <%= link_to admin_sale_orders_path(status: 'Confirmed'), class: 'btn btn-outline-warning btn-sm' do %>
      <i class="fa-solid fa-truck"></i> Pendientes Envío
    <% end %>
  </div>

  <!-- ========== 3 · ALERTAS ========== -->
  <% if @alerts.present? %>
    <div class="d-flex flex-wrap gap-2 mb-3">
      <% @alerts.each do |alert| %>
        <div class="alert alert-<%= alert[:type] %> py-2 px-3 mb-0 d-flex align-items-center gap-2 small" role="alert">
          <i class="fa-solid <%= alert[:icon] %>"></i>
          <span><%= alert[:message] %></span>
          <%= link_to alert[:link_text], alert[:link], class: "alert-link ms-2 fw-semibold" %>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- ========== 4 · ACTIVIDAD RECIENTE ========== -->
  <div class="card bg-light border-0 mb-3">
    <div class="card-body py-2">
      <div class="d-flex flex-wrap gap-4 small">
        <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-receipt text-success"></i>
          <span class="text-muted">Última venta:</span>
          <% if @last_sale %>
            <%= link_to @last_sale.id, edit_admin_sale_order_path(@last_sale), class: 'fw-semibold text-decoration-none' %>
            <span class="text-muted">(<%= time_ago_in_words(@last_sale.created_at) %>)</span>
          <% else %>
            <span class="text-muted">—</span>
          <% end %>
        </div>
        <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-box text-primary"></i>
          <span class="text-muted">Última compra recibida:</span>
          <% if @last_purchase_received %>
            <%= link_to @last_purchase_received.id, edit_admin_purchase_order_path(@last_purchase_received), class: 'fw-semibold text-decoration-none' %>
            <span class="text-muted">(<%= time_ago_in_words(@last_purchase_received.updated_at) %>)</span>
          <% else %>
            <span class="text-muted">—</span>
          <% end %>
        </div>
        <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-truck text-warning"></i>
          <span class="text-muted">Próximo envío:</span>
          <% if @next_shipment %>
            <%= link_to @next_shipment.id, edit_admin_sale_order_path(@next_shipment), class: 'fw-semibold text-decoration-none' %>
            <span class="text-muted">(pendiente desde <%= @next_shipment.order_date&.strftime('%d/%m') %>)</span>
          <% else %>
            <span class="text-success">Sin pendientes</span>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Leyenda de indicadores -->
  <div class="d-flex align-items-center gap-3 mb-3 small text-muted">
    <span><i class="fa-solid fa-circle text-success"></i> Buen rendimiento</span>
    <span><i class="fa-solid fa-circle text-warning"></i> Atención</span>
    <span><i class="fa-solid fa-circle text-danger"></i> Crítico</span>
    <span class="ms-auto" data-bs-toggle="tooltip" title="Los bordes coloreados indican el estado de cada métrica según umbrales predefinidos.">
      <i class="fa-solid fa-circle-question"></i> ¿Qué significan los colores?
    </span>
  </div>

  <!-- ========== 5 · KPIs PRIMARIOS ========== -->
  <div class="row g-3 mb-3">
    <div class="col-md-6 col-xl-3">
      <%= render "kpi_card",
        title: "Ingresos YTD",
        value: fmt_currency(@sales_ytd),
        ly: fmt_currency(@sales_prev),
        delta: @kpi_deltas&.dig(:sales),
        spark_id: "sparkline-revenue",
        variant: "text-bg-success-subtle",
        tooltip: "Total de ventas del año actual vs mismo periodo del año anterior.",
        health: @kpi_deltas&.dig(:sales).to_f >= 0 ? 'good' : 'warning'
      %>
    </div>
    <div class="col-md-6 col-xl-3">
      <%= render "kpi_card",
        title: "Utilidad Bruta YTD",
        value: fmt_currency(@profit_ytd),
        ly: fmt_currency(@profit_prev),
        delta: @kpi_deltas&.dig(:profit),
        variant: "text-bg-primary-subtle",
        tooltip: "Ganancia = Ventas - COGS.",
        health: @kpi_deltas&.dig(:profit).to_f >= 0 ? 'good' : 'danger'
      %>
    </div>
    <div class="col-md-6 col-xl-3">
      <%= render "kpi_card",
        title: "Margen Bruto YTD",
        value: number_to_percentage(@margin_ytd * 100, precision: 1),
        ly: number_to_percentage(@margin_prev * 100, precision: 1),
        delta: @kpi_deltas&.dig(:margin_pp),
        variant: "text-bg-warning-subtle",
        tooltip: "Porcentaje de utilidad sobre ventas. Meta > 30%.",
        health: @margin_ytd >= 0.30 ? 'good' : (@margin_ytd >= 0.20 ? 'warning' : 'danger')
      %>
    </div>
    <div class="col-md-6 col-xl-3">
      <%= render "kpi_card",
        title: "Flujo de Caja YTD",
        value: fmt_currency(@cashflow_ytd),
        ly: fmt_currency(@cashflow_prev),
        delta: @kpi_deltas&.dig(:cashflow),
        variant: "text-bg-secondary-subtle",
        tooltip: "Ingresos cobrados menos salidas pagadas.",
        health: @cashflow_ytd.to_f >= 0 ? 'good' : 'danger'
      %>
    </div>
  </div>

  <!-- ========== 6 · KPIs SECUNDARIOS ========== -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-4 col-xl">
      <%= render 'kpi_stat', title: 'Valor Inventario', value: fmt_currency(@inventory_total_value), tooltip: "Valor del inventario disponible. Rotación: #{@inventory_turnover_ytd.nil? ? '—' : number_with_precision(@inventory_turnover_ytd, precision: 2, delimiter: ',')}", health: @inventory_turnover_ytd.to_f >= 2 ? 'good' : (@inventory_turnover_ytd.to_f >= 1 ? 'warning' : 'danger') %>
    </div>
    <div class="col-6 col-md-4 col-xl">
      <%= render 'kpi_stat', title: 'Órdenes Venta YTD', value: number_with_delimiter(@orders_count_ytd), tooltip: 'Cantidad de Sale Orders confirmadas este año.', health: @kpi_deltas&.dig(:orders).to_f >= 0 ? 'good' : 'warning' %>
    </div>
    <div class="col-6 col-md-4 col-xl">
      <%= render 'kpi_stat', title: 'Ticket Promedio', value: fmt_currency(@avg_ticket_ytd), tooltip: 'Valor promedio por orden de venta.', health: @avg_ticket_ytd.to_f >= 500 ? 'good' : (@avg_ticket_ytd.to_f >= 200 ? nil : 'warning') %>
    </div>
    <div class="col-6 col-md-4 col-xl">
      <%= render 'kpi_stat', title: 'Clientes Activos', value: fmt_number(@active_customers_ytd), tooltip: 'Clientes con al menos una orden YTD.', health: @kpi_deltas&.dig(:customers).to_f >= 0 ? 'good' : 'warning' %>
    </div>
    <div class="col-6 col-md-4 col-xl">
      <%= render 'kpi_stat', title: 'Conversión', value: fmt_percentage_ratio(@conversion_rate_ytd, precision: 2), tooltip: 'Porcentaje de visitas → órdenes.', health: @conversion_rate_ytd.to_f >= 0.03 ? 'good' : (@conversion_rate_ytd.to_f >= 0.01 ? 'warning' : 'danger') %>
    </div>
    <div class="col-6 col-md-4 col-xl">
      <%= render 'kpi_stat', title: 'Stock Crítico', value: (@critical_stock_count.nil? ? '—' : fmt_number(@critical_stock_count)), tooltip: 'Productos por debajo del punto de reorden.', health: @critical_stock_count.to_i > 5 ? 'danger' : (@critical_stock_count.to_i > 0 ? 'warning' : 'good') %>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <%= render 'kpi_stat', title: 'Inversión Total', value: fmt_currency(@purchases_total_mxn), tooltip: 'Total invertido en compras desde el inicio.' %>
    </div>
    <div class="col-6 col-md-3">
      <%= render 'kpi_stat', title: 'Ventas Históricas', value: fmt_currency(@sales_total_mxn), tooltip: 'Total de ventas acumuladas históricas.' %>
    </div>
    <div class="col-6 col-md-3">
      <%= render 'kpi_stat', title: 'Clientes Recurrentes', value: fmt_percentage_ratio(@recurring_customers_ratio, precision: 1), tooltip: 'Clientes que han comprado más de una vez.', health: @recurring_customers_ratio.to_f >= 0.3 ? 'good' : (@recurring_customers_ratio.to_f >= 0.15 ? 'warning' : nil) %>
    </div>
    <div class="col-6 col-md-3">
      <%= render 'kpi_stat', title: 'Órdenes Compra YTD', value: number_with_delimiter(@po_count_ytd), tooltip: 'Purchase Orders creadas este año.', health: @kpi_deltas&.dig(:po_count).to_f >= 0 ? 'good' : nil %>
    </div>
  </div>

  <!-- ========== 7 · GRÁFICOS PRINCIPALES (Tendencia + Status Donuts) ========== -->
  <div class="row g-3 mb-4">
    <!-- Tendencia de Ventas 12 meses -->
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header py-2">
          <span class="fw-semibold"><i class="fa-solid fa-chart-line"></i> Tendencia de Ventas (12 meses)</span>
        </div>
        <div class="card-body">
          <% trend = @chart_sales_trend || {} %>
          <% trend_values = [trend[:revenue], trend[:cogs], trend[:profit]].flatten.compact %>
          <% has_trend_data = trend_values.any? { |v| v.to_f != 0 } %>
          <% if has_trend_data %>
            <div
              data-controller="chart"
              data-chart-type="line"
              data-chart-x="<%= (trend[:months] || []).to_json %>"
              data-chart-series="<%= [
                { name: 'Ingresos', data: (trend[:revenue] || []).map(&:to_f) },
                { name: 'COGS',     data: (trend[:cogs] || []).map(&:to_f) },
                { name: 'Utilidad', data: (trend[:profit] || []).map(&:to_f) }
              ].to_json %>"
              style="height:300px"
            ></div>
          <% else %>
            <div class="text-muted text-center py-5">Sin datos de ventas para el periodo.</div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Status Donuts: SO y PO -->
    <div class="col-lg-4">
      <div class="card mb-3">
        <div class="card-header py-2">
          <span class="fw-semibold"><i class="fa-solid fa-receipt"></i> Órdenes de Venta</span>
        </div>
        <div class="card-body p-2">
          <% if @so_status_pie.present? && @so_status_pie.any? { |s| s[:value].to_i > 0 } %>
            <div
              data-controller="chart"
              data-chart-type="pie"
              data-chart-series="<%= @so_status_pie.to_json %>"
              style="height:165px"
            ></div>
          <% else %>
            <div class="text-muted text-center py-3 small">Sin órdenes de venta.</div>
          <% end %>
        </div>
      </div>
      <div class="card">
        <div class="card-header py-2">
          <span class="fw-semibold"><i class="fa-solid fa-box"></i> Órdenes de Compra</span>
        </div>
        <div class="card-body p-2">
          <% if @po_status_pie.present? && @po_status_pie.any? { |s| s[:value].to_i > 0 } %>
            <div
              data-controller="chart"
              data-chart-type="pie"
              data-chart-series="<%= @po_status_pie.to_json %>"
              style="height:165px"
            ></div>
          <% else %>
            <div class="text-muted text-center py-3 small">Sin órdenes de compra.</div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== 8 · COMPARATIVA YTD vs AÑO ANTERIOR ========== -->
  <div class="card mb-4">
    <div class="card-header py-2">
      <span class="fw-semibold"><i class="fa-solid fa-scale-balanced"></i> Comparativa YTD vs Año Anterior</span>
    </div>
    <div class="card-body py-3">
      <div class="row g-3">
        <!-- Ventas -->
        <div class="col-md-4">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="small text-muted">Ventas</span>
            <span class="small fw-semibold <%= @kpi_deltas&.dig(:sales).to_f >= 0 ? 'text-success' : 'text-danger' %>">
              <% if @kpi_deltas&.dig(:sales) %>
                <i class="fa-solid fa-arrow-<%= @kpi_deltas&.dig(:sales).to_f >= 0 ? 'up' : 'down' %>"></i>
                <%= number_to_percentage(@kpi_deltas&.dig(:sales).to_f * 100, precision: 1) %>
              <% else %>—<% end %>
            </span>
          </div>
          <div class="progress" style="height: 24px;">
            <% sales_pct_ytd = @sales_prev.to_f.positive? ? [(@sales_ytd.to_f / [@sales_prev.to_f * 1.5, @sales_ytd.to_f].max) * 100, 100].min : 50 %>
            <div class="progress-bar bg-success" role="progressbar" style="width: <%= sales_pct_ytd %>%">
              <span class="small">YTD: <%= fmt_currency(@sales_ytd) %></span>
            </div>
          </div>
          <div class="progress mt-1" style="height: 18px;">
            <% sales_pct_ly = @sales_prev.to_f.positive? ? [(@sales_prev.to_f / [@sales_prev.to_f * 1.5, @sales_ytd.to_f].max) * 100, 100].min : 50 %>
            <div class="progress-bar bg-secondary" role="progressbar" style="width: <%= sales_pct_ly %>%">
              <span class="small">LY: <%= fmt_currency(@sales_prev) %></span>
            </div>
          </div>
        </div>
        <!-- Utilidad -->
        <div class="col-md-4">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="small text-muted">Utilidad Bruta</span>
            <span class="small fw-semibold <%= @kpi_deltas&.dig(:profit).to_f >= 0 ? 'text-success' : 'text-danger' %>">
              <% if @kpi_deltas&.dig(:profit) %>
                <i class="fa-solid fa-arrow-<%= @kpi_deltas&.dig(:profit).to_f >= 0 ? 'up' : 'down' %>"></i>
                <%= number_to_percentage(@kpi_deltas&.dig(:profit).to_f * 100, precision: 1) %>
              <% else %>—<% end %>
            </span>
          </div>
          <div class="progress" style="height: 24px;">
            <% profit_pct_ytd = @profit_prev.to_f.positive? ? [(@profit_ytd.to_f / [@profit_prev.to_f * 1.5, @profit_ytd.to_f].max) * 100, 100].min : 50 %>
            <div class="progress-bar bg-primary" role="progressbar" style="width: <%= profit_pct_ytd %>%">
              <span class="small">YTD: <%= fmt_currency(@profit_ytd) %></span>
            </div>
          </div>
          <div class="progress mt-1" style="height: 18px;">
            <% profit_pct_ly = @profit_prev.to_f.positive? ? [(@profit_prev.to_f / [@profit_prev.to_f * 1.5, @profit_ytd.to_f].max) * 100, 100].min : 50 %>
            <div class="progress-bar bg-secondary" role="progressbar" style="width: <%= profit_pct_ly %>%">
              <span class="small">LY: <%= fmt_currency(@profit_prev) %></span>
            </div>
          </div>
        </div>
        <!-- Órdenes -->
        <div class="col-md-4">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="small text-muted">Órdenes de Venta</span>
            <span class="small fw-semibold <%= @kpi_deltas&.dig(:orders).to_f >= 0 ? 'text-success' : 'text-danger' %>">
              <% if @kpi_deltas&.dig(:orders) %>
                <i class="fa-solid fa-arrow-<%= @kpi_deltas&.dig(:orders).to_f >= 0 ? 'up' : 'down' %>"></i>
                <%= number_to_percentage(@kpi_deltas&.dig(:orders).to_f * 100, precision: 1) %>
              <% else %>—<% end %>
            </span>
          </div>
          <div class="progress" style="height: 24px;">
            <% orders_max = [@orders_count_ytd.to_f, @orders_prev.to_f].max %>
            <% orders_pct_ytd = orders_max.positive? ? (@orders_count_ytd.to_f / orders_max) * 100 : 50 %>
            <div class="progress-bar bg-info" role="progressbar" style="width: <%= orders_pct_ytd %>%">
              <span class="small">YTD: <%= number_with_delimiter(@orders_count_ytd) %></span>
            </div>
          </div>
          <div class="progress mt-1" style="height: 18px;">
            <% orders_pct_ly = orders_max.positive? ? (@orders_prev.to_f / orders_max) * 100 : 50 %>
            <div class="progress-bar bg-secondary" role="progressbar" style="width: <%= orders_pct_ly %>%">
              <span class="small">LY: <%= number_with_delimiter(@orders_prev) %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== 9 · GRÁFICOS FINANCIEROS ========== -->
  <div class="row g-3 mb-4">
    <!-- Flujo de Caja 12 meses -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header py-2">
          <span class="fw-semibold"><i class="fa-solid fa-water"></i> Flujo de Caja (12 meses)</span>
        </div>
        <div class="card-body">
          <% cf = @chart_cashflow || {} %>
          <% cf_values = [cf[:inflow], cf[:outflow], cf[:net]].flatten.compact.map(&:to_f) %>
          <% has_cf_data = cf_values.any? { |v| v != 0 } %>
          <% if has_cf_data %>
            <div
              data-controller="chart"
              data-chart-type="line"
              data-chart-x="<%= (cf[:months] || []).to_json %>"
              data-chart-series="<%= [
                { name: 'Ingresos', data: (cf[:inflow] || []).map(&:to_f) },
                { name: 'Egresos',  data: (cf[:outflow] || []).map { |v| -v.to_f } },
                { name: 'Neto',     data: (cf[:net] || []).map(&:to_f) }
              ].to_json %>"
              style="height:280px"
            ></div>
          <% else %>
            <div class="text-muted text-center py-4">Sin datos de flujo de caja.</div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Comparativo Flujo de Caja YoY -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
          <span class="fw-semibold"><i class="fa-solid fa-scale-balanced"></i> Cashflow: <%= @chart_cashflow_comparison&.dig(:current_year) || Time.zone.now.year %> vs <%= @chart_cashflow_comparison&.dig(:prev_year) || Time.zone.now.year - 1 %></span>
        </div>
        <div class="card-body">
          <% cfc = @chart_cashflow_comparison || {} %>
          <% cfc_values = [cfc[:net_current], cfc[:net_prev]].flatten.compact.map(&:to_f) %>
          <% has_cfc_data = cfc_values.any? { |v| v != 0 } %>
          <% if has_cfc_data %>
            <div
              data-controller="chart"
              data-chart-type="bar"
              data-chart-x="<%= (cfc[:months] || []).to_json %>"
              data-chart-series="<%= [
                { name: "#{cfc[:current_year]} Neto", data: (cfc[:net_current] || []).map(&:to_f), type: 'bar' },
                { name: "#{cfc[:prev_year]} Neto",    data: (cfc[:net_prev] || []).map(&:to_f), type: 'bar' }
              ].to_json %>"
              style="height:240px"
            ></div>
            <div class="row mt-2 small text-muted">
              <div class="col-6">
                <strong><%= cfc[:current_year] %></strong> —
                <span class="text-success"><%= number_to_currency((cfc[:inflow_current] || []).sum, unit: '$', precision: 0, delimiter: ',') %></span> /
                <span class="text-danger"><%= number_to_currency((cfc[:outflow_current] || []).sum, unit: '$', precision: 0, delimiter: ',') %></span> =
                <strong class="<%= (cfc[:net_current] || []).sum >= 0 ? 'text-success' : 'text-danger' %>"><%= number_to_currency((cfc[:net_current] || []).sum, unit: '$', precision: 0, delimiter: ',') %></strong>
              </div>
              <div class="col-6">
                <strong><%= cfc[:prev_year] %></strong> —
                <span class="text-success"><%= number_to_currency((cfc[:inflow_prev] || []).sum, unit: '$', precision: 0, delimiter: ',') %></span> /
                <span class="text-danger"><%= number_to_currency((cfc[:outflow_prev] || []).sum, unit: '$', precision: 0, delimiter: ',') %></span> =
                <strong class="<%= (cfc[:net_prev] || []).sum >= 0 ? 'text-success' : 'text-danger' %>"><%= number_to_currency((cfc[:net_prev] || []).sum, unit: '$', precision: 0, delimiter: ',') %></strong>
              </div>
            </div>
          <% else %>
            <div class="text-muted text-center py-4">Sin datos de comparativo de flujo de caja.</div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== 10 · GRÁFICOS ANALÍTICOS ========== -->
  <div class="row g-3 mb-4">
    <!-- Ventas por Categoría (stacked) -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header py-2">
          <span class="fw-semibold"><i class="fa-solid fa-chart-column"></i> Ventas Mensuales por Categoría</span>
        </div>
        <div class="card-body">
          <% cat = @chart_monthly_by_category || {} %>
          <% cat_series = (cat[:series] || []) %>
          <% has_cat_data = cat_series.any? { |s| (s[:data] || []).any? { |v| v.to_f != 0 } } %>
          <% if has_cat_data %>
            <div
              data-controller="chart"
              data-chart-type="stacked"
              data-chart-x="<%= (cat[:months] || []).to_json %>"
              data-chart-series="<%= cat_series.map { |s| s.merge(type: 'bar') }.to_json %>"
              style="height:280px"
            ></div>
          <% else %>
            <div class="text-muted text-center py-4">Sin datos de ventas por categoría.</div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Rentabilidad por Marca + Categoría -->
    <div class="col-lg-6">
      <div class="row g-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header py-2">
              <span class="fw-semibold"><i class="fa-solid fa-city"></i> Rentabilidad por Marca</span>
            </div>
            <div class="card-body">
              <% brand = @chart_brand_profit || {} %>
              <% brand_data = (brand[:profit] || []).map(&:to_f) %>
              <% if brand_data.any? { |v| v != 0 } %>
                <div
                  data-controller="chart"
                  data-chart-type="bar"
                  data-chart-x="<%= (brand[:brands] || []).to_json %>"
                  data-chart-series="<%= [{ name: 'Utilidad', data: brand_data }].to_json %>"
                  style="height:130px"
                ></div>
              <% else %>
                <div class="text-muted text-center py-3 small">Sin datos.</div>
              <% end %>
            </div>
          </div>
        </div>
        <div class="col-12">
          <div class="card">
            <div class="card-header py-2">
              <span class="fw-semibold"><i class="fa-solid fa-tags"></i> Rentabilidad por Categoría</span>
            </div>
            <div class="card-body">
              <% cat_profit = @chart_category_profit || {} %>
              <% cat_profit_data = (cat_profit[:profit] || []).map(&:to_f) %>
              <% if cat_profit_data.any? { |v| v != 0 } %>
                <div
                  data-controller="chart"
                  data-chart-type="bar"
                  data-chart-x="<%= (cat_profit[:categories] || []).to_json %>"
                  data-chart-series="<%= [{ name: 'Utilidad', data: cat_profit_data }].to_json %>"
                  style="height:130px"
                ></div>
              <% else %>
                <div class="text-muted text-center py-3 small">Sin datos.</div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== 11 · RANKINGS: Productos + Inventario ========== -->
  <div class="row g-3 mb-4">
    <!-- Top Productos -->
    <div class="col-xl-8">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-box"></i> Top Productos</span>
          <div class="d-flex align-items-center gap-2">
            <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
              <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-sellers" type="button" role="tab" aria-selected="true">Vendedores</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-profit" type="button" role="tab">Rentables</button></li>
            </ul>
            <%= link_to admin_products_path, class: 'btn btn-sm btn-outline-primary ms-2 d-none d-lg-inline-block' do %>
              <i class="fa-solid fa-list"></i> Ver todos
            <% end %>
          </div>
          <select class="form-select form-select-sm d-md-none w-auto" data-action="change->tabs#select">
            <option value="#tp-sellers" selected>Vendedores</option>
            <option value="#tp-profit">Rentables</option>
          </select>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <!-- Vendedores -->
            <div class="tab-pane fade show active" id="tp-sellers" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-sellers-ytd" type="button" role="tab" aria-selected="true">YTD</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-sellers-ly" type="button" role="tab">LY</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-sellers-all" type="button" role="tab">All</button></li>
                </ul>
                <div class="tab-content">
                  <% %w[ytd ly all].each do |period| %>
                    <div class="tab-pane fade <%= period == 'ytd' ? 'show active' : '' %>" id="tp-sellers-<%= period %>" role="tabpanel" data-tabs-target="panel">
                      <turbo-frame id="frame-sellers-<%= period %>" src="<%= admin_dashboard_sellers_path(period: period) %>">
                        <div class="table-responsive p-2 px-3">
                          <table class="table table-sm mb-0">
                            <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Unidades</th><th class="text-end">Ingresos</th></tr></thead>
                            <%= table_skeleton_rows(cols: 4, rows: 3) %>
                          </table>
                        </div>
                      </turbo-frame>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
            <!-- Rentables -->
            <div class="tab-pane fade" id="tp-profit" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-profit-ytd" type="button" role="tab" aria-selected="true">YTD</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-profit-ly" type="button" role="tab">LY</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-profit-all" type="button" role="tab">All</button></li>
                </ul>
                <div class="tab-content">
                  <% %w[ytd ly all].each do |period| %>
                    <div class="tab-pane fade <%= period == 'ytd' ? 'show active' : '' %>" id="tp-profit-<%= period %>" role="tabpanel" data-tabs-target="panel">
                      <turbo-frame id="frame-profit-<%= period %>" src="<%= admin_dashboard_profitable_path(period: period) %>">
                        <div class="table-responsive p-2 px-3">
                          <table class="table table-sm mb-0">
                            <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Utilidad</th></tr></thead>
                            <%= table_skeleton_rows(cols: 5, rows: 3) %>
                          </table>
                        </div>
                      </turbo-frame>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Inventario -->
    <div class="col-xl-4">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-boxes-stacked"></i> Top Inventario</span>
          <div class="d-flex align-items-center gap-2 justify-content-end">
            <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
              <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-inv" type="button" role="tab" aria-selected="true">Inventario</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-res" type="button" role="tab">Apartados</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-all" type="button" role="tab">Todos</button></li>
            </ul>
            <select class="form-select form-select-sm d-md-none w-auto" data-action="change->tabs#select">
              <option value="#ti-inv" selected>Inventario</option>
              <option value="#ti-res">Apartados</option>
              <option value="#ti-all">Todos</option>
            </select>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <% %w[inv res all].each_with_index do |scope, idx| %>
              <div class="tab-pane fade <%= idx == 0 ? 'show active' : '' %>" id="ti-<%= scope %>" role="tabpanel" data-tabs-target="panel">
                <div data-controller="tabs">
                  <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                    <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-<%= scope %>-value" type="button" role="tab" aria-selected="true">Valor</button></li>
                    <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-<%= scope %>-qty" type="button" role="tab">Unidades</button></li>
                  </ul>
                  <div class="tab-content">
                    <% %w[value qty].each_with_index do |metric, midx| %>
                      <div class="tab-pane fade <%= midx == 0 ? 'show active' : '' %>" id="ti-<%= scope %>-<%= metric %>" role="tabpanel" data-tabs-target="panel">
                        <turbo-frame id="frame-inventory-<%= scope %>-<%= metric %>" src="<%= admin_dashboard_inventory_top_path(scope: scope, metric: metric) %>">
                          <div class="table-responsive p-2 px-3">
                            <table class="table table-sm mb-0">
                              <%= table_skeleton_rows(cols: metric == 'value' ? 3 : 4, rows: 3) %>
                            </table>
                          </div>
                        </turbo-frame>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== 12 · RANKINGS: Categorías + Clientes ========== -->
  <div class="row g-3 mb-4">
    <!-- Top Categorías -->
    <div class="col-xl-6">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-layer-group"></i> Top Categorías</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ytd" type="button" role="tab" aria-selected="true">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ly" type="button" role="tab">LY</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-all" type="button" role="tab">All</button></li>
          </ul>
          <select class="form-select form-select-sm d-md-none w-auto" data-action="change->tabs#select">
            <option value="#tc-ytd" selected>YTD</option>
            <option value="#tc-ly">LY</option>
            <option value="#tc-all">All</option>
          </select>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <% %w[ytd ly all].each_with_index do |period, pidx| %>
              <div class="tab-pane fade <%= pidx == 0 ? 'show active' : '' %>" id="tc-<%= period %>" role="tabpanel" data-tabs-target="panel">
                <div data-controller="tabs">
                  <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                    <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-<%= period %>-rev" type="button" role="tab" aria-selected="true">Ingresos</button></li>
                    <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-<%= period %>-prof" type="button" role="tab">Utilidad</button></li>
                  </ul>
                  <div class="tab-content">
                    <% { 'rev' => 'rev', 'prof' => 'profit' }.each_with_index do |(tab_key, metric), midx| %>
                      <div class="tab-pane fade <%= midx == 0 ? 'show active' : '' %>" id="tc-<%= period %>-<%= tab_key %>" role="tabpanel" data-tabs-target="panel">
                        <turbo-frame id="frame-cats-<%= period %>-<%= metric %>" src="<%= admin_dashboard_categories_rank_path(period: period, metric: metric) %>">
                          <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                            <%= table_skeleton_rows(cols: 3, rows: 3) %>
                          </table></div>
                        </turbo-frame>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Clientes -->
    <div class="col-xl-6">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-user-group"></i> Top Clientes</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-ytd" type="button" role="tab" aria-selected="true">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-ly" type="button" role="tab">LY</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-all" type="button" role="tab">All</button></li>
          </ul>
          <select class="form-select form-select-sm d-md-none w-auto" data-action="change->tabs#select">
            <option value="#tcu-ytd" selected>YTD</option>
            <option value="#tcu-ly">LY</option>
            <option value="#tcu-all">All</option>
          </select>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <% %w[ytd ly all].each_with_index do |period, pidx| %>
              <div class="tab-pane fade <%= pidx == 0 ? 'show active' : '' %>" id="tcu-<%= period %>" role="tabpanel" data-tabs-target="panel">
                <div data-controller="tabs">
                  <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                    <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-<%= period %>-sales" type="button" role="tab" aria-selected="true">Ventas</button></li>
                    <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-<%= period %>-res" type="button" role="tab">Apartados</button></li>
                    <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-<%= period %>-comb" type="button" role="tab">Combinado</button></li>
                  </ul>
                  <div class="tab-content">
                    <% { 'sales' => 'sales', 'res' => 'reserved', 'comb' => 'combined' }.each_with_index do |(tab_key, metric), midx| %>
                      <div class="tab-pane fade <%= midx == 0 ? 'show active' : '' %>" id="tcu-<%= period %>-<%= tab_key %>" role="tabpanel" data-tabs-target="panel">
                        <turbo-frame id="frame-cust-<%= period %>-<%= metric %>" src="<%= admin_dashboard_customers_rank_path(period: period, metric: metric) %>">
                          <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                            <%= table_skeleton_rows(cols: 3, rows: 3) %>
                          </table></div>
                        </turbo-frame>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== 13 · PRODUCTOS PROBLEMÁTICOS ========== -->
  <div class="card mb-4 border-danger">
    <div class="card-header d-flex justify-content-between align-items-center bg-danger-subtle" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#worst-section" aria-expanded="false">
      <span><i class="fa-solid fa-triangle-exclamation"></i> Productos Problemáticos</span>
      <div class="d-flex align-items-center gap-2">
        <%= link_to admin_products_path(sort: 'margin_asc'), class: 'btn btn-sm btn-outline-danger' do %>
          <i class="fa-solid fa-list"></i> Ver todos
        <% end %>
        <span class="badge bg-danger">Requiere atención</span>
        <i class="fa-solid fa-chevron-down text-muted"></i>
      </div>
    </div>
    <div class="collapse" id="worst-section">
      <div class="card-body">
        <!-- KPIs resumen -->
        <div class="row text-center mb-3">
          <div class="col-6 col-md-3">
            <div class="small text-muted">Capital Inmovilizado</div>
            <div class="fs-5 fw-bold text-danger">$ <%= number_with_precision(@worst_global_total_immobilized_capital, precision: 2, delimiter: ',') %></div>
          </div>
          <div class="col-6 col-md-3">
            <div class="small text-muted">Margen Promedio</div>
            <div class="fs-5 fw-bold"><%= @worst_global_avg_margin_pct.nil? ? '—' : number_to_percentage(@worst_global_avg_margin_pct * 100, precision: 1) %></div>
          </div>
          <div class="col-6 col-md-3">
            <div class="small text-muted">Rotación Promedio</div>
            <div class="fs-5 fw-bold"><%= @worst_global_avg_rotation.nil? ? '—' : number_with_precision(@worst_global_avg_rotation, precision: 2, delimiter: ',') %></div>
          </div>
          <div class="col-6 col-md-3">
            <div class="small text-muted">Días de Inventario (DOH)</div>
            <div class="fs-5 fw-bold"><%= @worst_global_avg_doh.nil? ? '—' : number_with_precision(@worst_global_avg_doh, precision: 1, delimiter: ',') %></div>
          </div>
        </div>

        <!-- Ranking Principal -->
        <div class="table-responsive">
          <table class="table table-sm mb-0 table-hover">
            <thead class="table-light"><tr><th style="width:60px">Rank</th><th>Producto</th><th class="text-end">Score</th><th class="text-end d-none d-md-table-cell">Margen</th><th class="text-end d-none d-md-table-cell">Rotación</th><th class="text-end d-none d-lg-table-cell">DOH</th><th class="text-end">Capital</th></tr></thead>
            <tbody>
              <% @worst_score_products&.first(10)&.each_with_index do |r, idx| %>
                <tr>
                  <td class="text-muted">#<%= idx + 1 %></td>
                  <td>
                    <div class="small fw-semibold"><%= link_to r[:name], edit_admin_product_path(r[:id]) %></div>
                    <div class="text-muted d-none d-sm-block" style="font-size: .75rem;">(<%= [r[:brand], r[:category]].compact.join(' - ') %>)</div>
                  </td>
                  <td class="text-end"><span class="badge bg-secondary"><%= number_with_precision(r[:worst_score], precision: 2, delimiter: ',') %></span></td>
                  <td class="text-end d-none d-md-table-cell <%= r[:margin_pct].to_f < 0.15 ? 'text-danger fw-bold' : '' %>"><%= r[:margin_pct].nil? ? '—' : number_to_percentage(r[:margin_pct] * 100, precision: 1) %></td>
                  <td class="text-end d-none d-md-table-cell <%= r[:rotation].to_f < 1 ? 'text-warning fw-bold' : '' %>"><%= r[:rotation].nil? ? '—' : number_with_precision(r[:rotation], precision: 2, delimiter: ',') %></td>
                  <td class="text-end d-none d-lg-table-cell"><%= r[:doh].infinite? ? '∞' : number_with_precision(r[:doh], precision: 0, delimiter: ',') %></td>
                  <td class="text-end text-danger">$ <%= number_with_precision(r[:immobilized_capital], precision: 0, delimiter: ',') %></td>
                </tr>
              <% end %>
              <% if @worst_score_products.blank? %>
                <tr><td colspan="7" class="text-center text-muted py-3">Sin datos</td></tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Detalle por métrica (colapsable) -->
        <div class="mt-3">
          <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#worst-details" aria-expanded="false">
            <i class="fa-solid fa-chevron-down"></i> Ver desglose por métrica
          </button>
          <div class="collapse mt-3" id="worst-details">
            <div class="row g-3">
              <div class="col-md-6 col-xl-3">
                <div class="card">
                  <div class="card-header py-2 small fw-semibold"><i class="fa-solid fa-percent text-danger"></i> Peor Margen</div>
                  <div class="card-body p-0">
                    <ul class="list-group list-group-flush small">
                      <% @worst_margin_products&.first(5)&.each do |r| %>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                          <%= link_to r[:name].truncate(25), edit_admin_product_path(r[:id]), class: 'text-decoration-none' %>
                          <span class="badge bg-danger"><%= r[:margin_pct].nil? ? '—' : number_to_percentage(r[:margin_pct] * 100, precision: 0) %></span>
                        </li>
                      <% end %>
                      <% if @worst_margin_products.blank? %><li class="list-group-item text-muted text-center py-2">Sin datos</li><% end %>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-xl-3">
                <div class="card">
                  <div class="card-header py-2 small fw-semibold"><i class="fa-solid fa-rotate text-warning"></i> Peor Rotación</div>
                  <div class="card-body p-0">
                    <ul class="list-group list-group-flush small">
                      <% @worst_rotation_products&.first(5)&.each do |r| %>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                          <%= link_to r[:name].truncate(25), edit_admin_product_path(r[:id]), class: 'text-decoration-none' %>
                          <span class="badge bg-warning text-dark"><%= r[:rotation].nil? ? '—' : number_with_precision(r[:rotation], precision: 2) %></span>
                        </li>
                      <% end %>
                      <% if @worst_rotation_products.blank? %><li class="list-group-item text-muted text-center py-2">Sin datos</li><% end %>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-xl-3">
                <div class="card">
                  <div class="card-header py-2 small fw-semibold"><i class="fa-solid fa-clock text-info"></i> Mayor DOH</div>
                  <div class="card-body p-0">
                    <ul class="list-group list-group-flush small">
                      <% @top_doh_products&.first(5)&.each do |r| %>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                          <%= link_to r[:name].truncate(25), edit_admin_product_path(r[:id]), class: 'text-decoration-none' %>
                          <span class="badge bg-info text-dark"><%= r[:doh].infinite? ? '∞' : number_with_precision(r[:doh], precision: 0) %> días</span>
                        </li>
                      <% end %>
                      <% if @top_doh_products.blank? %><li class="list-group-item text-muted text-center py-2">Sin datos</li><% end %>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-xl-3">
                <div class="card">
                  <div class="card-header py-2 small fw-semibold"><i class="fa-solid fa-money-bill-wave text-danger"></i> Mayor Capital</div>
                  <div class="card-body p-0">
                    <ul class="list-group list-group-flush small">
                      <% @top_immobilized_products&.first(5)&.each do |r| %>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                          <%= link_to r[:name].truncate(25), edit_admin_product_path(r[:id]), class: 'text-decoration-none' %>
                          <span class="badge bg-danger">$ <%= number_with_precision(r[:immobilized_capital], precision: 0, delimiter: ',') %></span>
                        </li>
                      <% end %>
                      <% if @top_immobilized_products.blank? %><li class="list-group-item text-muted text-center py-2">Sin datos</li><% end %>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== 14 · GEOGRAFÍA (colapsable) ========== -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#geo-section" aria-expanded="false">
      <span><i class="fa-solid fa-globe"></i> Análisis Geográfico</span>
      <span class="text-muted small"><i class="fa-solid fa-chevron-down"></i> Click para expandir</span>
    </div>
  </div>
  <div class="collapse" id="geo-section">
    <div class="row mb-4 g-3">
      <!-- Ventas por Estado (México) -->
      <div class="col-xl-8">
        <div class="card h-100" data-controller="tabs">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fa-solid fa-flag"></i> Ventas por Estado (México)</span>
            <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
              <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#mx-ytd" type="button" role="tab" aria-selected="true">YTD</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#mx-ly" type="button" role="tab">Año Anterior</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#mx-all" type="button" role="tab">Histórico</button></li>
            </ul>
            <select class="form-select form-select-sm d-md-none w-auto" data-action="change->tabs#select">
              <option value="#mx-ytd" selected>YTD</option>
              <option value="#mx-ly">Año Anterior</option>
              <option value="#mx-all">Histórico</option>
            </select>
          </div>
          <div class="card-body p-0">
            <div class="tab-content">
              <% { 'ytd' => @sales_by_mexico_states_ytd, 'ly' => @sales_by_mexico_states_last_year, 'all' => @sales_by_mexico_states_all_time }.each_with_index do |(period, data), idx| %>
                <div class="tab-pane fade <%= idx == 0 ? 'show active' : '' %>" id="mx-<%= period %>" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                      <tbody>
                        <% data&.each do |r| %>
                          <tr>
                            <td><%= r[:state] %></td>
                            <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if data.blank? %>
                          <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Ventas por País -->
      <div class="col-xl-4">
        <div class="card h-100" data-controller="tabs">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fa-solid fa-table"></i> Ventas por País</span>
            <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
              <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#cty-ytd" type="button" role="tab" aria-selected="true">YTD</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#cty-ly" type="button" role="tab">LY</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#cty-all" type="button" role="tab">All</button></li>
            </ul>
            <select class="form-select form-select-sm d-md-none w-auto" data-action="change->tabs#select">
              <option value="#cty-ytd" selected>YTD</option>
              <option value="#cty-ly">LY</option>
              <option value="#cty-all">All</option>
            </select>
          </div>
          <div class="card-body p-0">
            <div class="tab-content">
              <% { 'ytd' => @sales_by_country_ytd, 'ly' => @sales_by_country_last_year, 'all' => @sales_by_country_all_time }.each_with_index do |(period, data), idx| %>
                <div class="tab-pane fade <%= idx == 0 ? 'show active' : '' %>" id="cty-<%= period %>" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                      <tbody>
                        <% data&.each do |r| %>
                          <tr>
                            <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                            <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                            <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                          </tr>
                        <% end %>
                        <% if data.blank? %>
                          <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
