<div class="container">
  <h2 class="mb-3"><i class="fa-solid fa-chart-line"></i> Dashboard</h2>

  <!-- Filtros globales -->
  <div class="card mb-3">
    <div class="card-body py-2">
      <%= form_with url: admin_dashboard_path, method: :get, local: true, class: "row gy-2 gx-2 align-items-end" do |f| %>
        <div class="col-auto">
          <label class="form-label mb-0 small">Rango</label>
          <%= f.select :range,
              options_for_select([
                ['YTD (año en curso)', 'ytd'],
                ['Últimos 30 días', 'last_30'],
                ['Últimos 90 días', 'last_90'],
                ['Este año', 'this_year'],
                ['Personalizado', 'custom']
              ], @range_key),
              {}, class: 'form-select form-select-sm' %>
        </div>
        <div class="col-auto" data-range-custom>
          <label class="form-label mb-0 small">Inicio</label>
          <%= f.date_field :start_date, value: @start_date, class: 'form-control form-control-sm' %>
        </div>
        <div class="col-auto" data-range-custom>
          <label class="form-label mb-0 small">Fin</label>
          <%= f.date_field :end_date, value: @end_date.to_date, class: 'form-control form-control-sm' %>
        </div>
        <div class="col-auto">
          <div class="form-check mt-4">
            <%= f.check_box :exclude_canceled, { checked: @exclude_canceled, class: 'form-check-input' }, 'true', 'false' %>
            <label class="form-check-label">Excluir cancelados</label>
          </div>
        </div>
        <div class="col-auto">
          <%= f.submit 'Aplicar', class: 'btn btn-primary btn-sm' %>
          <%= link_to 'Limpiar filtros', admin_dashboard_path, class: 'btn btn-outline-secondary btn-sm' %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-globe"></i> Mapa mundial: accesos y ventas</span>
          <small class="text-muted">Fuente: Visitor Logs (accesos); Ventas por enviar (placeholder)</small>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
        <!-- KPIs -->
        <div class="row g-3">
          <div class="col-md-2 col-6">
              // ====== High-impact charts (ECharts) ======
              const lineEl = document.getElementById('chart-trend-12m');
              const donutEl = document.getElementById('chart-sales-by-category');
              const stackedEl = document.getElementById('chart-monthly-stacked');
              const brandEl = document.getElementById('chart-brand-profit');

              try {
                if (lineEl && window.echarts) {
                  const chart = echarts.init(lineEl);
                  const months = <%= raw(@chart_sales_trend[:months].to_json) %>;
                  const revenue = <%= raw(@chart_sales_trend[:revenue].map(&:to_f).to_json) %>;
                  const cogs = <%= raw(@chart_sales_trend[:cogs].map(&:to_f).to_json) %>;
                  const profit = <%= raw(@chart_sales_trend[:profit].map(&:to_f).to_json) %>;
                  chart.setOption({
                    tooltip: { trigger: 'axis' },
                    legend: { data: ['Revenue','COGS','Profit'] },
                    xAxis: { type: 'category', data: months },
                    yAxis: { type: 'value' },
                    series: [
                      { name: 'Revenue', type: 'line', data: revenue, smooth: true },
                      { name: 'COGS', type: 'line', data: cogs, smooth: true },
                      { name: 'Profit', type: 'line', data: profit, smooth: true }
                    ]
                  });
                  window.addEventListener('resize', () => chart.resize());
                }

                if (donutEl && window.echarts) {
                  const chart = echarts.init(donutEl);
                  const series = <%= raw(@chart_sales_by_category.to_json) %>;
                  chart.setOption({
                    tooltip: { trigger: 'item' },
                    legend: { orient: 'vertical', left: 'left' },
                    series: [{
                      name: 'Sales by Category', type: 'pie', radius: ['40%','70%'], avoidLabelOverlap: false,
                      itemStyle: { borderRadius: 6, borderColor: '#fff', borderWidth: 2 },
                      label: { show: false }, emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } },
                      labelLine: { show: false }, data: series
                    }]
                  });
                  window.addEventListener('resize', () => chart.resize());
                }

                if (stackedEl && window.echarts) {
                  const chart = echarts.init(stackedEl);
                  const months = <%= raw(@chart_monthly_by_category[:months].to_json) %>;
                  const series = <%= raw(@chart_monthly_by_category[:series].to_json) %>;
                  chart.setOption({
                    tooltip: { trigger: 'axis' },
                    legend: {},
                    xAxis: { type: 'category', data: months },
                    yAxis: { type: 'value' },
                    series: series.map(s => ({ ...s, type: 'bar', stack: 'total' }))
                  });
                  window.addEventListener('resize', () => chart.resize());
                }

                if (brandEl && window.echarts) {
                  const chart = echarts.init(brandEl);
                  const brands = <%= raw(@chart_brand_profit[:brands].to_json) %>;
                  const profit = <%= raw(@chart_brand_profit[:profit].map(&:to_f).to_json) %>;
                  chart.setOption({
                    tooltip: { trigger: 'axis' },
                    xAxis: { type: 'value' },
                    yAxis: { type: 'category', data: brands },
                    series: [{ type: 'bar', data: profit, itemStyle: { color: '#4caf50' } }]
                  });
                  window.addEventListener('resize', () => chart.resize());
                }
              } catch (e) { console.error('Charts error', e); }

            <div class="card text-bg-light h-100">
              <div class="card-body">
                <div class="small text-muted">Productos</div>
                <div class="fs-4 fw-bold"><%= number_with_delimiter(@total_products) %></div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6">
            <div class="card text-bg-light h-100">
              <div class="card-body">
                <div class="small text-muted">Usuarios</div>
                <div class="fs-4 fw-bold"><%= number_with_delimiter(@total_users) %></div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6">
            <div class="card text-bg-success-subtle h-100">
              <div class="card-body">
                <div class="small text-muted">Ventas YTD</div>
                <div class="fs-5 fw-bold">$ <%= number_with_precision(@sales_ytd, precision: 2, delimiter: ',') %></div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6">
            <div class="card text-bg-warning-subtle h-100">
              <div class="card-body">
                <div class="small text-muted">Compras YTD</div>
                <div class="fs-5 fw-bold">$ <%= number_with_precision(@purchases_ytd, precision: 2, delimiter: ',') %></div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6">
            <div class="card text-bg-primary-subtle h-100">
              <div class="card-body">
                <div class="small text-muted">Ganancia YTD</div>
                <div class="fs-5 fw-bold">$ <%= number_with_precision(@profit_ytd, precision: 2, delimiter: ',') %></div>
              </div>
            </div>
          </div>
          <div class="col-md-2 col-6">
            <div class="card text-bg-info-subtle h-100">
              <div class="card-body">
                <div class="small text-muted">Margen YTD</div>
                <div class="fs-4 fw-bold"><%= number_to_percentage(@margin_ytd * 100, precision: 1) %></div>
              </div>
            </div>
          </div>
        </div>
              <div id="world-map-visits" style="height: 360px;"></div>
            </div>
            <div class="col-md-6">
              <h6 class="mb-2">Ventas por país</h6>
              <div id="world-map-sales" style="height: 360px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- High-impact charts row 1 -->
  <div class="row mt-4 g-3">
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-chart-line"></i> Sales Comparison (12 months)</div>
        <div class="card-body">
          <div id="chart-trend-12m" style="height: 280px;"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-chart-pie"></i> Sales by Product Category</div>
        <div class="card-body">
          <div id="chart-sales-by-category" style="height: 280px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- High-impact charts row 2 -->
  <div class="row mt-4 g-3">
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-chart-column"></i> Sales by Month (stacked by category)</div>
        <div class="card-body">
          <div id="chart-monthly-stacked" style="height: 280px;"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-city"></i> Brand Profitability</div>
        <div class="card-body">
          <div id="chart-brand-profit" style="height: 280px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ECharts CDN and world geojson loader -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/map/js/world.js"></script>
<script>
    // Mostrar campos de fecha solo si rango == custom
    document.addEventListener('turbo:load', () => {
      const rangeSel = document.querySelector('select[name="range"]');
      const customFields = document.querySelectorAll('[data-range-custom]');
      const sync = () => {
        const isCustom = rangeSel && rangeSel.value === 'custom';
        customFields.forEach(el => el.style.display = isCustom ? '' : 'none');
      };
      if (rangeSel) {
        rangeSel.addEventListener('change', sync);
      }
      sync();
    });

  document.addEventListener('turbo:load', () => {
    const visitsEl = document.getElementById('world-map-visits');
    const salesEl  = document.getElementById('world-map-sales');
    if (!visitsEl || !salesEl || !(window.echarts)) return;

    Promise.resolve().then(async () => {
      const res = await fetch('<%= admin_dashboard_geo_path(format: :json) %>');
      if (!res.ok) return;
      const data = await res.json();

      const visitsChart = echarts.init(visitsEl);
      const salesChart  = echarts.init(salesEl);

      const commonOpts = (title) => ({
        tooltip: { trigger: 'item', formatter: ({name, value}) => `${name}: ${value?.toLocaleString?.() || value || 0}` },
        visualMap: { min: 0, max: 100, left: 'left', top: 'bottom', text: ['Alto','Bajo'], calculable: true },
        series: [{
          name: title,
          type: 'map',
          map: 'world',
          roam: true,
          emphasis: { label: { show: false } },
          data: []
        }]
      });

      const visitsOpts = commonOpts('Accesos');
      visitsOpts.series[0].data = (data.visits || []).map(d => ({ name: d.name, value: d.value }));
      // Ajustar el rango visual con base en datos
      if (visitsOpts.series[0].data.length) {
        const maxVal = Math.max(...visitsOpts.series[0].data.map(d => d.value));
        visitsOpts.visualMap.max = Math.max(10, maxVal);
      }
      visitsChart.setOption(visitsOpts);

      const salesOpts = commonOpts('Ventas');
      salesOpts.series[0].data = (data.sales_by_country || []).map(d => ({ name: d.name, value: d.value }));
      if (salesOpts.series[0].data.length) {
        const maxVal = Math.max(...salesOpts.series[0].data.map(d => d.value));
        salesOpts.visualMap.max = Math.max(10, maxVal);
      }
      salesChart.setOption(salesOpts);

      // Responsivo
      window.addEventListener('resize', () => { visitsChart.resize(); salesChart.resize(); });
    });
  });
</script>
