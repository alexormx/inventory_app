<div class="container-fluid">
  <h2 class="mb-3"><i class="fa-solid fa-chart-line"></i> Dashboard</h2>

  <!-- KPIs al tope (estratégico) -->
  <div class="row g-3 mb-3">
    <div class="col-md-4 col-lg-3">
      <div class="card text-bg-success-subtle h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="small text-muted">Ventas YTD (MXN)</div>
              <div class="fs-4 fw-bold">$ <%= number_with_precision(@sales_ytd, precision: 2, delimiter: ',') %> <span class="small text-muted">(LY: $ <%= number_with_precision(@sales_prev, precision: 2, delimiter: ',') %>)</span></div>
              <div class="small <%= @kpi_deltas&.dig(:sales).to_f >= 0 ? 'text-success' : 'text-danger' %>">Δ vs LY: <%= @kpi_deltas&.dig(:sales).nil? ? '—' : number_to_percentage(@kpi_deltas[:sales] * 100, precision: 1) %></div>
            </div>
            <div style="width:110px;height:46px" id="sparkline-revenue"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-lg-3">
      <div class="card text-bg-primary-subtle h-100">
        <div class="card-body">
          <div class="small text-muted">Ganancia YTD</div>
          <div class="fs-4 fw-bold">$ <%= number_with_precision(@profit_ytd, precision: 2, delimiter: ',') %> <span class="small text-muted">(LY: $ <%= number_with_precision(@profit_prev, precision: 2, delimiter: ',') %>)</span></div>
          <div class="small <%= @kpi_deltas&.dig(:profit).to_f >= 0 ? 'text-success' : 'text-danger' %>">Δ vs LY: <%= @kpi_deltas&.dig(:profit).nil? ? '—' : number_to_percentage(@kpi_deltas[:profit] * 100, precision: 1) %></div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-lg-3">
      <div class="card text-bg-info-subtle h-100">
        <div class="card-body">
          <div class="small text-muted">Margen YTD</div>
          <div class="fs-4 fw-bold"><%= number_to_percentage(@margin_ytd * 100, precision: 1) %> <span class="small text-muted">(LY: <%= number_to_percentage(@margin_prev * 100, precision: 1) %>)</span></div>
          <div class="small <%= (@kpi_deltas&.dig(:margin_pp) || 0).to_f >= 0 ? 'text-success' : 'text-danger' %>">Δ pp vs LY: <%= @kpi_deltas&.dig(:margin_pp).present? ? number_with_precision(@kpi_deltas[:margin_pp] * 100, precision: 1) : '—' %> pp</div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-lg-3">
      <div class="card text-bg-warning-subtle h-100">
        <div class="card-body">
          <div class="small text-muted">Compras totales en MXN (All Time)</div>
          <div class="fs-4 fw-bold">$ <%= number_with_precision(@purchases_total_mxn, precision: 2, delimiter: ',') %></div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-lg-3">
      <div class="card text-bg-light h-100">
        <div class="card-body">
          <div class="small text-muted">PO en el año</div>
          <div class="fs-4 fw-bold"><%= number_with_delimiter(@po_count_ytd) %> <span class="small text-muted">(LY: <%= number_with_delimiter(@po_count_prev) %>)</span></div>
          <div class="small text-muted">Artículos comprados (YTD): <%= number_with_delimiter(@po_items_qty_ytd) %></div>
          <div class="small text-muted">All Time: <%= number_with_delimiter(@po_items_qty_all_time) %></div>
          <div class="small <%= @kpi_deltas&.dig(:po_count).to_f >= 0 ? 'text-success' : 'text-danger' %>">Δ vs LY: <%= @kpi_deltas&.dig(:po_count).nil? ? '—' : number_to_percentage(@kpi_deltas[:po_count] * 100, precision: 1) %></div>
          <div class="small text-muted">Total All Time: <%= number_with_delimiter(@po_total_all_time) %></div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-lg-3">
      <div class="card text-bg-light h-100">
        <div class="card-body">
          <div class="small text-muted">SO en el año</div>
          <div class="fs-4 fw-bold"><%= number_with_delimiter(@orders_count_ytd) %> <span class="small text-muted">(LY: <%= number_with_delimiter(@orders_prev) %>)</span></div>
          <div class="small text-muted">Artículos vendidos (YTD): <%= number_with_delimiter(@so_items_qty_ytd) %></div>
          <div class="small text-muted">All Time: <%= number_with_delimiter(@so_items_qty_all_time) %></div>
          <div class="small <%= @kpi_deltas&.dig(:orders).to_f >= 0 ? 'text-success' : 'text-danger' %>">Δ vs LY: <%= @kpi_deltas&.dig(:orders).nil? ? '—' : number_to_percentage(@kpi_deltas[:orders] * 100, precision: 1) %></div>
          <div class="small text-muted">Total All Time: <%= number_with_delimiter(@so_total_all_time) %></div>
        </div>
      </div>
    </div>
  </div>
  <div class="row g-3 mb-3">
    <div class="col-md-4 col-lg-4">
      <div class="card text-bg-light h-100">
        <div class="card-body">
          <div class="small text-muted">Ventas totales en MXN (All Time)</div>
          <div class="fs-4 fw-bold">$ <%= number_with_precision(@sales_total_mxn, precision: 2, delimiter: ',') %></div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-lg-4">
      <div class="card text-bg-light h-100">
        <div class="card-body">
          <div class="small text-muted">Clientes activos</div>
          <div class="fs-4 fw-bold"><%= number_with_delimiter(@active_customers_ytd) %> <span class="small text-muted">(LY: <%= number_with_delimiter(@active_customers_prev) %>)</span></div>
          <div class="small <%= @kpi_deltas&.dig(:customers).to_f >= 0 ? 'text-success' : 'text-danger' %>">Δ vs LY: <%= @kpi_deltas&.dig(:customers).nil? ? '—' : number_to_percentage(@kpi_deltas[:customers] * 100, precision: 1) %></div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-lg-4">
      <div class="card text-bg-secondary-subtle h-100">
        <div class="card-body">
          <div class="small text-muted">Valor total de inventario (MXN)</div>
          <div class="fs-4 fw-bold">$ <%= number_with_precision(@inventory_total_value, precision: 2, delimiter: ',') %></div>
          <div class="small text-muted">Rotación: <%= @inventory_turnover_ytd.nil? ? '—' : number_with_precision(@inventory_turnover_ytd, precision: 2, delimiter: ',') %></div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs tácticos (rápidos) -->
  <div class="row g-3 mb-3">
    <div class="col-md-2 col-6">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="small text-muted">Ticket promedio</div>
          <div class="fs-6 fw-bold">$ <%= number_with_precision(@avg_ticket_ytd, precision: 2, delimiter: ',') %></div>
        </div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="small text-muted">Conversión</div>
          <div class="fs-6 fw-bold"><%= @conversion_rate_ytd.nil? ? '—' : number_to_percentage(@conversion_rate_ytd * 100, precision: 2) %></div>
        </div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="small text-muted">Stock crítico</div>
          <div class="fs-6 fw-bold"><%= @critical_stock_count.nil? ? '—' : number_with_delimiter(@critical_stock_count) %></div>
        </div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="small text-muted">Recurrentes</div>
          <div class="fs-6 fw-bold"><%= @recurring_customers_ratio.nil? ? '—' : number_to_percentage(@recurring_customers_ratio * 100, precision: 1) %></div>
        </div>
      </div>
    </div>
  </div>

  <!-- (Se removió el bloque de filtros globales a solicitud) -->

  <!-- (Se eliminó la tabla duplicada de Países de la parte superior) -->

  <!-- Top productos: combinado Sellers/Rentables + Inventario -->
  <div class="row mt-3 g-3">
    <div class="col-xl-8">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <i class="fa-solid fa-boxes"></i> Productos
            <ul class="nav nav-tabs nav-tabs-sm card-header-tabs mt-2" role="tablist">
              <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-sellers" type="button" role="tab" aria-controls="tp-sellers" aria-selected="true">Sellers</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-profit" type="button" role="tab" aria-controls="tp-profit">Rentables</button></li>
            </ul>
          </div>
          <div>
            <a href="<%= admin_products_path %>" class="btn btn-sm btn-outline-primary">Ver detalle</a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <!-- Sellers -->
            <div class="tab-pane fade show active" id="tp-sellers" role="tabpanel" data-tabs-target="panel" data-controller="subtabs">
              <div class="px-3 pt-3">
                <ul class="nav nav-tabs nav-tabs-sm" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->subtabs#activate" data-subtabs-target="tab" data-target="#ts-ytd" type="button" role="tab" aria-controls="ts-ytd" aria-selected="true">YTD</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->subtabs#activate" data-subtabs-target="tab" data-target="#ts-ly" type="button" role="tab" aria-controls="ts-ly">Last Year</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->subtabs#activate" data-subtabs-target="tab" data-target="#ts-all" type="button" role="tab" aria-controls="ts-all">All Time</button></li>
                </ul>
              </div>
              <div class="tab-content">
                <div class="tab-pane fade show active" id="ts-ytd" role="tabpanel" data-subtabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Unidades</th><th class="text-end">Ingresos</th></tr></thead>
                      <tbody>
                        <% @top_sellers_ytd&.each_with_index do |r, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                            <td class="text-end"><%= number_with_delimiter(r[:units]) %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_sellers_ytd.blank? %>
                          <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="tab-pane fade" id="ts-ly" role="tabpanel" data-subtabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Unidades</th><th class="text-end">Ingresos</th></tr></thead>
                      <tbody>
                        <% @top_sellers_last_year&.each_with_index do |r, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                            <td class="text-end"><%= number_with_delimiter(r[:units]) %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_sellers_last_year.blank? %>
                          <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="tab-pane fade" id="ts-all" role="tabpanel" data-subtabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Unidades</th><th class="text-end">Ingresos</th></tr></thead>
                      <tbody>
                        <% @top_products_all&.each_with_index do |r, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                            <td class="text-end"><%= number_with_delimiter(r[:units]) %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_products_all.blank? %>
                          <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Rentables -->
            <div class="tab-pane fade" id="tp-profit" role="tabpanel" data-tabs-target="panel" data-controller="subtabs">
              <div class="px-3 pt-3">
                <ul class="nav nav-tabs nav-tabs-sm" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->subtabs#activate" data-subtabs-target="tab" data-target="#pp-ytd" type="button" role="tab" aria-controls="pp-ytd" aria-selected="true">YTD</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->subtabs#activate" data-subtabs-target="tab" data-target="#pp-ly" type="button" role="tab" aria-controls="pp-ly">Last Year</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->subtabs#activate" data-subtabs-target="tab" data-target="#pp-all" type="button" role="tab" aria-controls="pp-all">All Time</button></li>
                </ul>
              </div>
              <div class="tab-content">
                <div class="tab-pane fade show active" id="pp-ytd" role="tabpanel" data-subtabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Profit</th></tr></thead>
                      <tbody>
                        <% @top_products_profit_ytd&.each_with_index do |r, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:cogs], precision: 2, delimiter: ',') %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:profit], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_products_profit_ytd.blank? %>
                          <tr><td colspan="5" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="tab-pane fade" id="pp-ly" role="tabpanel" data-subtabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Profit</th></tr></thead>
                      <tbody>
                        <% @top_products_profit_last_year&.each_with_index do |r, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:cogs], precision: 2, delimiter: ',') %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:profit], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_products_profit_last_year.blank? %>
                          <tr><td colspan="5" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="tab-pane fade" id="pp-all" role="tabpanel" data-subtabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Profit</th></tr></thead>
                      <tbody>
                        <% @top_products_profit_all_time&.each_with_index do |r, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:cogs], precision: 2, delimiter: ',') %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:profit], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_products_profit_all_time.blank? %>
                          <tr><td colspan="5" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-boxes-stacked"></i> Top Inventario por Valor</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Valor de Inventario</th></tr></thead>
              <tbody>
                <% @top_inventory_by_value&.each_with_index do |r, idx| %>
                  <tr>
                    <td class="text-muted">#<%= idx + 1 %></td>
                    <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                    <td class="text-end">$ <%= number_with_precision(r[:inventory_value], precision: 2, delimiter: ',') %></td>
                  </tr>
                <% end %>
                <% if @top_inventory_by_value.blank? %>
                  <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top categorías + Top clientes (lado a lado) -->
  <div class="row mt-4 g-3">
    <div class="col-xl-6">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-layer-group"></i> Top Categorías</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ytd" type="button" role="tab" aria-controls="tc-ytd" aria-selected="true">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ly" type="button" role="tab" aria-controls="tc-ly">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-all" type="button" role="tab" aria-controls="tc-all">All Time</button></li>
          </ul>
          <div><a class="btn btn-sm btn-outline-primary" href="<%= admin_products_path %>">Ver detalle</a></div>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="tc-ytd" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Categoría</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @top_categories_ytd&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= r[:category] %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_categories_ytd.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="tc-ly" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Categoría</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @top_categories_last_year&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= r[:category] %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_categories_last_year.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="tc-all" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Categoría</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @top_categories_all_time&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= r[:category] %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_categories_all_time.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
  </div>
  <div class="col-xl-6">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-ranking-star"></i> Top Customers</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#rank-range" type="button" role="tab" aria-controls="rank-range" aria-selected="true">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#rank-ly" type="button" role="tab" aria-controls="rank-ly">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#rank-all" type="button" role="tab" aria-controls="rank-all">All Time</button></li>
          </ul>
          <a href="<%= admin_users_path %>" class="btn btn-sm btn-outline-primary ms-2">Ver detalle</a>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="rank-range" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead>
                    <tr>
                      <th>Rank</th>
                      <th>Cliente</th>
                      <th class="text-end">Órdenes</th>
                      <th class="text-end">Ingresos YTD</th>
                      <th class="text-end">Ingresos LY</th>
                      <th class="text-end">Δ vs LY</th>
                    </tr>
                   </thead>
                   <tbody>
                     <% (@top_users_ytd_vs_prev.presence || @top_users_range).each_with_index do |u, idx| %>
                       <tr>
                         <td class="text-muted">#<%= idx + 1 %></td>
                         <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                         <td class="text-end"><%= number_with_delimiter(u[:orders_count]) %></td>
                         <td class="text-end">$ <%= number_with_precision(u[:revenue], precision: 2, delimiter: ',') %></td>
                         <td class="text-end">$ <%= number_with_precision((u[:prev_revenue] || 0), precision: 2, delimiter: ',') %></td>
                         <td class="text-end">
                           <% if u[:revenue_delta_ratio].nil? %>
                             <span class="text-muted">—</span>
                           <% else %>
                             <%= number_to_percentage(u[:revenue_delta_ratio] * 100, precision: 1) %>
                           <% end %>
                         </td>
                       </tr>
                     <% end %>
                     <% if @top_users_range.blank? %>
                       <tr><td colspan="6" class="text-center text-muted py-3">No data</td></tr>
                     <% end %>
                   </tbody>
                 </table>
              </div>
            </div>
            <div class="tab-pane fade" id="rank-ly" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Customer</th><th class="text-end">Orders</th><th class="text-end">Revenue</th></tr></thead>
                  <tbody>
                    <% @top_users_last_year.each_with_index do |u, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                        <td class="text-end"><%= number_with_delimiter(u[:orders_count]) %></td>
                        <td class="text-end">$ <%= number_with_precision(u[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_users_last_year.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">No data</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="rank-all" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Customer</th><th class="text-end">Orders</th><th class="text-end">Revenue</th></tr></thead>
                  <tbody>
                    <% @top_users_all.each_with_index do |u, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                        <td class="text-end"><%= number_with_delimiter(u[:orders_count]) %></td>
                        <td class="text-end">$ <%= number_with_precision(u[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_users_all.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">No data</td></tr>
                    <% end %>
                  </tbody>
                </table>
                <div class="px-3 py-2 small text-muted">Nota: en All Time no se muestra comparativo vs años anteriores.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Otras tablas: Geografía -->
  <div class="row mt-4">
    <div class="col-xl-8">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-flag"></i> Ventas por Estado (México)</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#mx-ytd" type="button" role="tab" aria-controls="mx-ytd" aria-selected="true">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#mx-ly" type="button" role="tab" aria-controls="mx-ly">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#mx-all" type="button" role="tab" aria-controls="mx-all">All Time</button></li>
          </ul>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="mx-ytd" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @sales_by_mexico_states_ytd&.each do |r| %>
                      <tr>
                        <td><%= r[:state] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_mexico_states_ytd.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="mx-ly" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @sales_by_mexico_states_last_year&.each do |r| %>
                      <tr>
                        <td><%= r[:state] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_mexico_states_last_year.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="mx-all" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @sales_by_mexico_states_all_time&.each do |r| %>
                      <tr>
                        <td><%= r[:state] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_mexico_states_all_time.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-table"></i> Distribución de Ventas por País</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#cty-ytd" type="button" role="tab" aria-controls="cty-ytd" aria-selected="true">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#cty-ly" type="button" role="tab" aria-controls="cty-ly">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#cty-all" type="button" role="tab" aria-controls="cty-all">All Time</button></li>
          </ul>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="cty-ytd" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                  <tbody>
                    <% @sales_by_country_ytd&.each do |r| %>
                      <tr>
                        <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_country_ytd.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="cty-ly" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                  <tbody>
                    <% @sales_by_country_last_year&.each do |r| %>
                      <tr>
                        <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_country_last_year.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="cty-all" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                  <tbody>
                    <% @sales_by_country_all_time&.each do |r| %>
                      <tr>
                        <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_country_all_time.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <!-- High-impact charts row 1 -->
  <div class="row mt-4 g-3">
    <div class="col-lg-12">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-chart-line"></i> Sales Comparison (12 months)</span>
          <a href="<%= admin_sale_orders_path %>" class="btn btn-sm btn-outline-primary">Ver detalle</a>
        </div>
        <div class="card-body">
          <div id="chart-trend-12m" style="height: 280px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- High-impact charts row 2 -->
  <div class="row mt-4 g-3">
    <div class="col-lg-12">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-chart-column"></i> Sales by Month (stacked by category)</div>
        <div class="card-body">
          <div id="chart-monthly-stacked" style="height: 280px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- High-impact charts row 3: Category Profitability -->
  <div class="row mt-4 g-3">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-city"></i> Brand Profitability</div>
        <div class="card-body">
          <div id="chart-brand-profit" style="height: 280px;"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-tags"></i> Category Profitability</div>
        <div class="card-body">
          <div id="chart-category-profit" style="height: 280px;"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- (Se eliminó el bloque final de "Producto top por categoría (Profit)") -->
</div>

<!-- ECharts para charts (no mapas) -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
    // Mostrar campos de fecha solo si rango == custom
    document.addEventListener('turbo:load', () => {
      const rangeSel = document.querySelector('select[name="range"]');
      const customFields = document.querySelectorAll('[data-range-custom]');
      const sync = () => {
        const isCustom = rangeSel && rangeSel.value === 'custom';
        customFields.forEach(el => el.style.display = isCustom ? '' : 'none');
      };
      if (rangeSel) {
        rangeSel.addEventListener('change', sync);
      }
      sync();
    });

  // High-impact charts (init on Turbo load)
  document.addEventListener('turbo:load', () => {
    if (!(window.echarts)) return;
    try {
  const lineEl = document.getElementById('chart-trend-12m');
  const sparkRevenueEl = document.getElementById('sparkline-revenue');
      const donutEl = document.getElementById('chart-sales-by-category');
  const stackedEl = document.getElementById('chart-monthly-stacked');
  const brandEl = document.getElementById('chart-brand-profit');
  const categoryProfitEl = document.getElementById('chart-category-profit');

      if (lineEl) {
        const chart = echarts.init(lineEl);
        const months = <%= raw(@chart_sales_trend[:months].to_json) %>;
        const revenue = <%= raw(@chart_sales_trend[:revenue].map(&:to_f).to_json) %>;
        const cogs = <%= raw(@chart_sales_trend[:cogs].map(&:to_f).to_json) %>;
        const profit = <%= raw(@chart_sales_trend[:profit].map(&:to_f).to_json) %>;
        chart.setOption({
          tooltip: { trigger: 'axis' },
          legend: { data: ['Revenue','COGS','Profit'] },
          xAxis: { type: 'category', data: months },
          yAxis: { type: 'value' },
          series: [
            { name: 'Revenue', type: 'line', data: revenue, smooth: true },
            { name: 'COGS', type: 'line', data: cogs, smooth: true },
            { name: 'Profit', type: 'line', data: profit, smooth: true }
          ]
        });
        window.addEventListener('resize', () => chart.resize());
      }

      if (sparkRevenueEl) {
        const chart = echarts.init(sparkRevenueEl);
        const revenue = <%= raw(@chart_sales_trend[:revenue].map(&:to_f).to_json) %>;
        chart.setOption({
          grid: {left: 0, right: 0, top: 2, bottom: 2},
          xAxis: { type: 'category', show: false, data: revenue.map((_,i)=>i) },
          yAxis: { type: 'value', show: false },
          series: [{ type: 'line', data: revenue, smooth: true, symbol: 'none', lineStyle: { width: 2 } }],
          tooltip: { show: false }
        });
        window.addEventListener('resize', () => chart.resize());
      }

      if (donutEl) {
        const chart = echarts.init(donutEl);
        const series = <%= raw(@chart_sales_by_category.to_json) %>;
        chart.setOption({
          tooltip: { trigger: 'item' },
          legend: { orient: 'vertical', left: 'left' },
          series: [{
            name: 'Sales by Category', type: 'pie', radius: ['40%','70%'], avoidLabelOverlap: false,
            itemStyle: { borderRadius: 6, borderColor: '#fff', borderWidth: 2 },
            label: { show: false }, emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } },
            labelLine: { show: false }, data: series
          }]
        });
        window.addEventListener('resize', () => chart.resize());
      }

      if (stackedEl) {
        const chart = echarts.init(stackedEl);
        const months = <%= raw(@chart_monthly_by_category[:months].to_json) %>;
        const series = <%= raw(@chart_monthly_by_category[:series].to_json) %>;
        chart.setOption({
          tooltip: { trigger: 'axis' },
          legend: {},
          xAxis: { type: 'category', data: months },
          yAxis: { type: 'value' },
          series: series.map(s => ({ ...s, type: 'bar', stack: 'total' }))
        });
        window.addEventListener('resize', () => chart.resize());
      }

      if (brandEl) {
        const chart = echarts.init(brandEl);
        const brands = <%= raw(@chart_brand_profit[:brands].to_json) %>;
        const profit = <%= raw(@chart_brand_profit[:profit].map(&:to_f).to_json) %>;
        chart.setOption({
          tooltip: { trigger: 'axis' },
          xAxis: { type: 'value' },
          yAxis: { type: 'category', data: brands },
          series: [{ type: 'bar', data: profit, itemStyle: { color: '#4caf50' } }]
        });
        window.addEventListener('resize', () => chart.resize());
      }

      if (categoryProfitEl) {
        const chart = echarts.init(categoryProfitEl);
        const _catProfit = <%= raw((@chart_category_profit || {categories: [], profit: []}).to_json) %>;
        const categories = _catProfit.categories || [];
        const profit = (_catProfit.profit || []).map(parseFloat);
        chart.setOption({
          tooltip: { trigger: 'axis' },
          xAxis: { type: 'value' },
          yAxis: { type: 'category', data: categories },
          series: [{ type: 'bar', data: profit, itemStyle: { color: '#3f51b5' } }]
        });
        window.addEventListener('resize', () => chart.resize());
      }
    } catch (e) { console.error('Charts error', e); }
  });

  // (Se removió el mapa; no hay inicialización de mapas.)
</script>
