<div class="container-fluid">
  <h2 class="mb-3"><i class="fa-solid fa-chart-line"></i> Dashboard</h2>

  <!-- KPIs al tope (estratégico) -->
  <div class="row g-3 mb-3">
    <div class="col-md-4 col-lg-3">
      <%= render "kpi_card",
        title: "Ventas YTD (MXN)",
        value: fmt_currency(@sales_ytd),
        ly: fmt_currency(@sales_prev),
        delta: @kpi_deltas&.dig(:sales),
        spark_id: "sparkline-revenue",
        variant: "text-bg-success-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-3">
      <%= render "kpi_card",
        title: "Ganancia YTD",
        value: fmt_currency(@profit_ytd),
        ly: fmt_currency(@profit_prev),
        delta: @kpi_deltas&.dig(:profit),
        variant: "text-bg-primary-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-3">
      <%= render "kpi_card",
        title: "Margen YTD",
        value: number_to_percentage(@margin_ytd * 100, precision: 1),
        ly: number_to_percentage(@margin_prev * 100, precision: 1),
        delta: @kpi_deltas&.dig(:margin_pp),
        variant: "text-bg-warning-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-3">
      <%= render "kpi_card",
        title: "Compras totales en MXN (All Time)",
        value: fmt_currency(@purchases_total_mxn),
        variant: "text-bg-warning-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-3">
      <%= render "kpi_card",
        title: "PO en el año",
        value: number_with_delimiter(@po_count_ytd),
        ly: number_with_delimiter(@po_count_prev),
        delta: @kpi_deltas&.dig(:po_count),
        variant: "text-bg-primary-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-3">
      <%= render "kpi_card",
        title: "SO en el año",
        value: number_with_delimiter(@orders_count_ytd),
        ly: number_with_delimiter(@orders_prev),
        delta: @kpi_deltas&.dig(:orders),
        variant: "text-bg-primary-subtle"
      %>
    </div>
  </div>

  <!-- Top productos + Top inventario (lado a lado) -->
  <div class="row g-3 mt-2">
    <div class="col-xl-8">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-box"></i> Top Productos</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-sellers" type="button" role="tab" aria-controls="tp-sellers" aria-selected="true">Vendedores</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-profit" type="button" role="tab" aria-controls="tp-profit">Rentables</button></li>
          </ul>
          <select class="form-select form-select-sm d-md-none w-auto" aria-label="Seleccionar grupo" data-action="change->tabs#select">
            <option value="#tp-sellers" selected>Vendedores</option>
            <option value="#tp-profit">Rentables</option>
          </select>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <!-- Vendedores main tab with subtabs -->
            <div class="tab-pane fade show active" id="tp-sellers" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-sellers-ytd" type="button" role="tab" aria-controls="tp-sellers-ytd" aria-selected="true">YTD</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-sellers-ly" type="button" role="tab" aria-controls="tp-sellers-ly">LY</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-sellers-all" type="button" role="tab" aria-controls="tp-sellers-all">All</button></li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="tp-sellers-ytd" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-sellers-ytd" src="<%= admin_dashboard_sellers_path(period: 'ytd') %>">
                      <div class="table-responsive p-2 px-3">
                        <table class="table table-sm mb-0">
                          <thead>
                            <tr>
                              <th scope="col">Rank</th>
                              <th scope="col">Producto</th>
                              <th scope="col" class="text-end">Unidades</th>
                              <th scope="col" class="text-end">Ingresos</th>
                            </tr>
                          </thead>
                          <%= table_skeleton_rows(cols: 4, rows: 3) %>
                        </table>
                      </div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tp-sellers-ly" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-sellers-ly" src="<%= admin_dashboard_sellers_path(period: 'ly') %>">
                      <div class="table-responsive p-2 px-3">
                        <table class="table table-sm mb-0">
                          <thead>
                            <tr>
                              <th scope="col">Rank</th>
                              <th scope="col">Producto</th>
                              <th scope="col" class="text-end">Unidades</th>
                              <th scope="col" class="text-end">Ingresos</th>
                            </tr>
                          </thead>
                          <%= table_skeleton_rows(cols: 4, rows: 3) %>
                        </table>
                      </div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tp-sellers-all" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-sellers-all" src="<%= admin_dashboard_sellers_path(period: 'all') %>">
                      <div class="table-responsive p-2 px-3">
                        <table class="table table-sm mb-0">
                          <thead>
                            <tr>
                              <th scope="col">Rank</th>
                              <th scope="col">Producto</th>
                              <th scope="col" class="text-end">Unidades</th>
                              <th scope="col" class="text-end">Ingresos</th>
                            </tr>
                          </thead>
                          <%= table_skeleton_rows(cols: 4, rows: 3) %>
                        </table>
                      </div>
                    </turbo-frame>
                  </div>
                </div>
              </div>
            </div>
            <!-- Rentables main tab with subtabs -->
            <div class="tab-pane fade" id="tp-profit" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-profit-ytd" type="button" role="tab" aria-controls="tp-profit-ytd" aria-selected="true">YTD</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-profit-ly" type="button" role="tab" aria-controls="tp-profit-ly">LY</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-profit-all" type="button" role="tab" aria-controls="tp-profit-all">All</button></li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="tp-profit-ytd" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-profit-ytd" src="<%= admin_dashboard_profitable_path(period: 'ytd') %>">
                      <div class="table-responsive p-2 px-3">
                        <table class="table table-sm mb-0">
                          <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Utilidad</th></tr></thead>
                          <%= table_skeleton_rows(cols: 5, rows: 3) %>
                        </table>
                      </div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tp-profit-ly" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-profit-ly" src="<%= admin_dashboard_profitable_path(period: 'ly') %>">
                      <div class="table-responsive p-2 px-3">
                        <table class="table table-sm mb-0">
                          <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Utilidad</th></tr></thead>
                          <%= table_skeleton_rows(cols: 5, rows: 3) %>
                        </table>
                      </div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tp-profit-all" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-profit-all" src="<%= admin_dashboard_profitable_path(period: 'all') %>">
                      <div class="table-responsive p-2 px-3">
                        <table class="table table-sm mb-0">
                          <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Utilidad</th></tr></thead>
                          <%= table_skeleton_rows(cols: 5, rows: 3) %>
                        </table>
                      </div>
                    </turbo-frame>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-boxes-stacked"></i> Top Inventario</span>
          <div class="d-flex align-items-center gap-2 justify-content-end">
            <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
              <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-inv" type="button" role="tab" aria-controls="ti-inv" aria-selected="true">Inventario</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-res" type="button" role="tab" aria-controls="ti-res">Apartados</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-all" type="button" role="tab" aria-controls="ti-all">Todos</button></li>
            </ul>
            <select class="form-select form-select-sm d-md-none w-auto" aria-label="Seleccionar grupo" data-action="change->tabs#select">
              <option value="#ti-inv" selected>Inventario</option>
              <option value="#ti-res">Apartados</option>
              <option value="#ti-all">Todos</option>
            </select>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <!-- Grupo: Inventario -->
            <div class="tab-pane fade show active" id="ti-inv" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-inv-value" type="button" role="tab" aria-controls="ti-inv-value" aria-selected="true">Valor</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-inv-qty" type="button" role="tab" aria-controls="ti-inv-qty">Unidades</button></li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="ti-inv-value" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-inventory-inv-value" src="<%= admin_dashboard_inventory_top_path(scope: 'inv', metric: 'value') %>">
                      <div class="table-responsive p-2 px-3">
                        <table class="table table-sm mb-0">
                          <%= table_skeleton_rows(cols: 3, rows: 3) %>
                        </table>
                      </div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="ti-inv-qty" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-inventory-inv-qty" src="<%= admin_dashboard_inventory_top_path(scope: 'inv', metric: 'qty') %>">
                      <div class="table-responsive p-2 px-3">
                        <table class="table table-sm mb-0">
                          <%= table_skeleton_rows(cols: 4, rows: 3) %>
                        </table>
                      </div>
                    </turbo-frame>
                  </div>
                </div>
              </div>
            </div>
            <!-- Grupo: Apartados -->
            <div class="tab-pane fade" id="ti-res" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-res-value" type="button" role="tab" aria-controls="ti-res-value" aria-selected="true">Valor</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-res-qty" type="button" role="tab" aria-controls="ti-res-qty">Unidades</button></li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="ti-res-value" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-inventory-res-value" src="<%= admin_dashboard_inventory_top_path(scope: 'res', metric: 'value') %>">
                      <div class="table-responsive p-2 px-3">
                        <table class="table table-sm mb-0">
                          <%= table_skeleton_rows(cols: 3, rows: 3) %>
                        </table>
                      </div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="ti-res-qty" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-inventory-res-qty" src="<%= admin_dashboard_inventory_top_path(scope: 'res', metric: 'qty') %>">
                      <div class="table-responsive p-2 px-3">
                        <table class="table table-sm mb-0">
                          <%= table_skeleton_rows(cols: 4, rows: 3) %>
                        </table>
                      </div>
                    </turbo-frame>
                  </div>
                </div>
              </div>
            </div>
            <!-- Grupo: Todos -->
            <div class="tab-pane fade" id="ti-all" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-all-value" type="button" role="tab" aria-controls="ti-all-value" aria-selected="true">Valor</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-all-qty" type="button" role="tab" aria-controls="ti-all-qty">Unidades</button></li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="ti-all-value" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-inventory-all-value" src="<%= admin_dashboard_inventory_top_path(scope: 'all', metric: 'value') %>">
                      <div class="table-responsive p-2 px-3">
                        <table class="table table-sm mb-0">
                          <%= table_skeleton_rows(cols: 3, rows: 3) %>
                        </table>
                      </div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="ti-all-qty" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-inventory-all-qty" src="<%= admin_dashboard_inventory_top_path(scope: 'all', metric: 'qty') %>">
                      <div class="table-responsive p-2 px-3">
                        <table class="table table-sm mb-0">
                          <%= table_skeleton_rows(cols: 4, rows: 3) %>
                        </table>
                      </div>
                    </turbo-frame>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-4 col-lg-4">
      <%= render "kpi_card",
        title: "Ventas totales en MXN (All Time)",
        value: fmt_currency(@sales_total_mxn),
        variant: "text-bg-success-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-4">
      <%= render "kpi_card",
        title: "Clientes activos",
        value: fmt_number(@active_customers_ytd),
        ly: fmt_number(@active_customers_prev),
        delta: @kpi_deltas&.dig(:customers),
        variant: "text-bg-primary-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-4">
      <%= render "kpi_card",
        title: "Valor total de inventario (MXN)",
        value: fmt_currency(@inventory_total_value),
        ly: (@inventory_turnover_ytd.nil? ? nil : "Rotación: #{number_with_precision(@inventory_turnover_ytd, precision: 2, delimiter: ',')}") ,
        variant: "text-bg-warning-subtle"
      %>
    </div>
  </div>

  <!-- KPIs tácticos (rápidos) -->
  <div class="row g-3 mb-3">
    <div class="col-md-2 col-6">
      <%= render 'kpi_stat', title: 'Ticket promedio', value: fmt_currency(@avg_ticket_ytd) %>
    </div>
    <div class="col-md-2 col-6">
      <%= render 'kpi_stat', title: 'Conversión', value: fmt_percentage_ratio(@conversion_rate_ytd, precision: 2) %>
    </div>
    <div class="col-md-2 col-6">
      <%= render 'kpi_stat', title: 'Stock crítico', value: (@critical_stock_count.nil? ? '—' : fmt_number(@critical_stock_count)) %>
    </div>
    <div class="col-md-2 col-6">
      <%= render 'kpi_stat', title: 'Recurrentes', value: fmt_percentage_ratio(@recurring_customers_ratio, precision: 1) %>
    </div>
  </div>

  <!-- Top categorías + Top clientes (lado a lado) -->
  <div class="row mt-4 g-3">
    <div class="col-xl-6">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-layer-group"></i> Top Categorías</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ytd" type="button" role="tab" aria-controls="tc-ytd" aria-selected="true">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ly" type="button" role="tab" aria-controls="tc-ly">LY</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-all" type="button" role="tab" aria-controls="tc-all">All</button></li>
          </ul>
          <select class="form-select form-select-sm d-md-none w-auto" aria-label="Seleccionar periodo" data-action="change->tabs#select">
            <option value="#tc-ytd" selected>YTD</option>
            <option value="#tc-ly">LY</option>
            <option value="#tc-all">All</option>
          </select>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <!-- Grupo: YTD -->
            <div class="tab-pane fade show active" id="tc-ytd" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ytd-rev" type="button" role="tab" aria-controls="tc-ytd-rev" aria-selected="true">Ingresos</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ytd-prof" type="button" role="tab" aria-controls="tc-ytd-prof">Utilidad</button></li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="tc-ytd-rev" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cats-ytd-rev" src="<%= admin_dashboard_categories_rank_path(period: 'ytd', metric: 'rev') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tc-ytd-prof" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cats-ytd-profit" src="<%= admin_dashboard_categories_rank_path(period: 'ytd', metric: 'profit') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                </div>
              </div>
            </div>
            <!-- Grupo: LY -->
            <div class="tab-pane fade" id="tc-ly" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ly-rev" type="button" role="tab" aria-controls="tc-ly-rev" aria-selected="true">Ingresos</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ly-prof" type="button" role="tab" aria-controls="tc-ly-prof">Utilidad</button></li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="tc-ly-rev" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cats-ly-rev" src="<%= admin_dashboard_categories_rank_path(period: 'ly', metric: 'rev') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tc-ly-prof" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cats-ly-profit" src="<%= admin_dashboard_categories_rank_path(period: 'ly', metric: 'profit') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                </div>
              </div>
            </div>
            <!-- Grupo: All -->
            <div class="tab-pane fade" id="tc-all" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-all-rev" type="button" role="tab" aria-controls="tc-all-rev" aria-selected="true">Ingresos</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-all-prof" type="button" role="tab" aria-controls="tc-all-prof">Utilidad</button></li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="tc-all-rev" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cats-all-rev" src="<%= admin_dashboard_categories_rank_path(period: 'all', metric: 'rev') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tc-all-prof" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cats-all-profit" src="<%= admin_dashboard_categories_rank_path(period: 'all', metric: 'profit') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
  </div>
  <div class="col-xl-6">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-user-group"></i> Top Clientes</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-ytd" type="button" role="tab" aria-controls="tcu-ytd" aria-selected="true">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-ly" type="button" role="tab" aria-controls="tcu-ly">LY</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-all" type="button" role="tab" aria-controls="tcu-all">All</button></li>
          </ul>
          <select class="form-select form-select-sm d-md-none w-auto" aria-label="Seleccionar periodo" data-action="change->tabs#select">
            <option value="#tcu-ytd" selected>YTD</option>
            <option value="#tcu-ly">LY</option>
            <option value="#tcu-all">All</option>
          </select>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <!-- Grupo: YTD -->
            <div class="tab-pane fade show active" id="tcu-ytd" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-ytd-sales" type="button" role="tab" aria-controls="tcu-ytd-sales" aria-selected="true">Ventas</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-ytd-res" type="button" role="tab" aria-controls="tcu-ytd-res">Apartados</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-ytd-comb" type="button" role="tab" aria-controls="tcu-ytd-comb">Combinado</button></li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="tcu-ytd-sales" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cust-ytd-sales" src="<%= admin_dashboard_customers_rank_path(period: 'ytd', metric: 'sales') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tcu-ytd-res" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cust-ytd-reserved" src="<%= admin_dashboard_customers_rank_path(period: 'ytd', metric: 'reserved') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tcu-ytd-comb" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cust-ytd-combined" src="<%= admin_dashboard_customers_rank_path(period: 'ytd', metric: 'combined') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                </div>
              </div>
            </div>
            <!-- Grupo: LY -->
            <div class="tab-pane fade" id="tcu-ly" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-ly-sales" type="button" role="tab" aria-controls="tcu-ly-sales" aria-selected="true">Ventas</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-ly-res" type="button" role="tab" aria-controls="tcu-ly-res">Apartados</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-ly-comb" type="button" role="tab" aria-controls="tcu-ly-comb">Combinado</button></li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="tcu-ly-sales" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cust-ly-sales" src="<%= admin_dashboard_customers_rank_path(period: 'ly', metric: 'sales') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tcu-ly-res" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cust-ly-reserved" src="<%= admin_dashboard_customers_rank_path(period: 'ly', metric: 'reserved') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tcu-ly-comb" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cust-ly-combined" src="<%= admin_dashboard_customers_rank_path(period: 'ly', metric: 'combined') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                </div>
              </div>
            </div>
            <!-- Grupo: All -->
            <div class="tab-pane fade" id="tcu-all" role="tabpanel" data-tabs-target="panel">
              <div data-controller="tabs">
                <ul class="nav nav-tabs nav-tabs-sm px-3 pt-3 d-none d-md-flex" role="tablist">
                  <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-all-sales" type="button" role="tab" aria-controls="tcu-all-sales" aria-selected="true">Ventas</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-all-res" type="button" role="tab" aria-controls="tcu-all-res">Apartados</button></li>
                  <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tcu-all-comb" type="button" role="tab" aria-controls="tcu-all-comb">Combinado</button></li>
                </ul>
                <div class="tab-content">
                  <div class="tab-pane fade show active" id="tcu-all-sales" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cust-all-sales" src="<%= admin_dashboard_customers_rank_path(period: 'all', metric: 'sales') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tcu-all-res" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cust-all-reserved" src="<%= admin_dashboard_customers_rank_path(period: 'all', metric: 'reserved') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                  <div class="tab-pane fade" id="tcu-all-comb" role="tabpanel" data-tabs-target="panel">
                    <turbo-frame id="frame-cust-all-combined" src="<%= admin_dashboard_customers_rank_path(period: 'all', metric: 'combined') %>">
                      <div class="table-responsive p-2 px-3"><table class="table table-sm mb-0">
                        <%= table_skeleton_rows(cols: 3, rows: 3) %>
                      </table></div>
                    </turbo-frame>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Otras tablas: Geografía -->
  <div class="row mt-4">
    <div class="col-xl-8">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-flag"></i> Ventas por Estado (México)</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#mx-ytd" type="button" role="tab" aria-controls="mx-ytd" aria-selected="true">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#mx-ly" type="button" role="tab" aria-controls="mx-ly">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#mx-all" type="button" role="tab" aria-controls="mx-all">All Time</button></li>
          </ul>
          <select class="form-select form-select-sm d-md-none w-auto" aria-label="Seleccionar periodo" data-action="change->tabs#select">
            <option value="#mx-ytd" selected>YTD</option>
            <option value="#mx-ly">Last Year</option>
            <option value="#mx-all">All Time</option>
          </select>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="mx-ytd" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @sales_by_mexico_states_ytd&.each do |r| %>
                      <tr>
                        <td><%= r[:state] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_mexico_states_ytd.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="mx-ly" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @sales_by_mexico_states_last_year&.each do |r| %>
                      <tr>
                        <td><%= r[:state] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_mexico_states_last_year.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="mx-all" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @sales_by_mexico_states_all_time&.each do |r| %>
                      <tr>
                        <td><%= r[:state] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_mexico_states_all_time.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-table"></i> Distribución de Ventas por País</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#cty-ytd" type="button" role="tab" aria-controls="cty-ytd" aria-selected="true">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#cty-ly" type="button" role="tab" aria-controls="cty-ly">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#cty-all" type="button" role="tab" aria-controls="cty-all">All Time</button></li>
          </ul>
          <select class="form-select form-select-sm d-md-none w-auto" aria-label="Seleccionar periodo" data-action="change->tabs#select">
            <option value="#cty-ytd" selected>YTD</option>
            <option value="#cty-ly">Last Year</option>
            <option value="#cty-all">All Time</option>
          </select>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="cty-ytd" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                  <tbody>
                    <% @sales_by_country_ytd&.each do |r| %>
                      <tr>
                        <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_country_ytd.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="cty-ly" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                  <tbody>
                    <% @sales_by_country_last_year&.each do |r| %>
                      <tr>
                        <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_country_last_year.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="cty-all" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                  <tbody>
                    <% @sales_by_country_all_time&.each do |r| %>
                      <tr>
                        <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_country_all_time.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <!-- Worst Products KPIs -->
  <div class="row mt-4 g-3">
    <div class="col-lg-12">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-triangle-exclamation"></i> Worst Products</span>
          <div class="small text-muted">w1=0.4, w2=0.2, w3=0.2, w4=0.2 (ajustables por query params)</div>
        </div>
        <div class="card-body">
          <div class="row text-center mb-3">
            <div class="col-md-3">
              <div class="small text-muted">Capital inmovilizado</div>
              <div class="fs-5 fw-bold">$ <%= number_with_precision(@worst_global_total_immobilized_capital, precision: 2, delimiter: ',') %></div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">Margen promedio</div>
              <div class="fs-5 fw-bold"><%= @worst_global_avg_margin_pct.nil? ? '—' : number_to_percentage(@worst_global_avg_margin_pct * 100, precision: 1) %></div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">Rotación promedio</div>
              <div class="fs-5 fw-bold"><%= @worst_global_avg_rotation.nil? ? '—' : number_with_precision(@worst_global_avg_rotation, precision: 2, delimiter: ',') %></div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">DOH promedio</div>
              <div class="fs-5 fw-bold"><%= @worst_global_avg_doh.nil? ? '—' : number_with_precision(@worst_global_avg_doh, precision: 1, delimiter: ',') %></div>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-xl-6">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Margen</th></tr></thead>
                  <tbody>
                    <% @worst_margin_products&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td>
                          <div class="small fw-semibold"><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></div>
                          <div class="text-muted" style="font-size: .75rem;">(<%= [r[:brand], r[:category]].compact.join(' - ') %>)</div>
                        </td>
                        <td class="text-end"><%= r[:margin_pct].nil? ? '—' : number_to_percentage(r[:margin_pct] * 100, precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @worst_margin_products.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-xl-6">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Rotación</th></tr></thead>
                  <tbody>
                    <% @worst_rotation_products&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td>
                          <div class="small fw-semibold"><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></div>
                          <div class="text-muted" style="font-size: .75rem;">(<%= [r[:brand], r[:category]].compact.join(' - ') %>)</div>
                        </td>
                        <td class="text-end"><%= r[:rotation].nil? ? '—' : number_with_precision(r[:rotation], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @worst_rotation_products.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-xl-6">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">DOH</th></tr></thead>
                  <tbody>
                    <% @top_doh_products&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td>
                          <div class="small fw-semibold"><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></div>
                          <div class="text-muted" style="font-size: .75rem;">(<%= [r[:brand], r[:category]].compact.join(' - ') %>)</div>
                        </td>
                        <td class="text-end"><%= r[:doh].infinite? ? '∞' : number_with_precision(r[:doh], precision: 1, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_doh_products.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-xl-6">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Capital inmovilizado</th></tr></thead>
                  <tbody>
                    <% @top_immobilized_products&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td>
                          <div class="small fw-semibold"><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></div>
                          <div class="text-muted" style="font-size: .75rem;">(<%= [r[:brand], r[:category]].compact.join(' - ') %>)</div>
                        </td>
                        <td class="text-end">$ <%= number_with_precision(r[:immobilized_capital], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_immobilized_products.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-xl-12">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Worst Score</th><th class="text-end">Margen</th><th class="text-end">Rotación</th><th class="text-end">DOH</th><th class="text-end">Capital</th></tr></thead>
                  <tbody>
                    <% @worst_score_products&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td>
                          <div class="small fw-semibold"><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></div>
                          <div class="text-muted" style="font-size: .75rem;">(<%= [r[:brand], r[:category]].compact.join(' - ') %>)</div>
                        </td>
                        <td class="text-end"><%= number_with_precision(r[:worst_score], precision: 3, delimiter: ',') %></td>
                        <td class="text-end"><%= r[:margin_pct].nil? ? '—' : number_to_percentage(r[:margin_pct] * 100, precision: 1) %></td>
                        <td class="text-end"><%= r[:rotation].nil? ? '—' : number_with_precision(r[:rotation], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= r[:doh].infinite? ? '∞' : number_with_precision(r[:doh], precision: 1, delimiter: ',') %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:immobilized_capital], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @worst_score_products.blank? %>
                      <tr><td colspan="7" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- High-impact charts row 1 -->
  <div class="row mt-4 g-3">
    <div class="col-lg-12">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-chart-line"></i> Sales Comparison (12 months)</span>
          <!-- Botón "Ver detalle" removido a solicitud -->
        </div>
        <div class="card-body">
          <div
            data-controller="chart"
            data-chart-type="line"
            data-chart-x="<%= raw(@chart_sales_trend[:months].to_json) %>"
            data-chart-series="<%= raw([
              { name: 'Revenue', data: @chart_sales_trend[:revenue].map(&:to_f) },
              { name: 'COGS',    data: @chart_sales_trend[:cogs].map(&:to_f) },
              { name: 'Profit',  data: @chart_sales_trend[:profit].map(&:to_f) }
            ].to_json) %>"
            style="height:280px"
          ></div>
        </div>
      </div>
    </div>
  </div>

  <!-- High-impact charts row 2 -->
  <div class="row mt-4 g-3">
    <div class="col-lg-12">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-chart-column"></i> Sales by Month (stacked by category)</div>
        <div class="card-body">
          <div
            data-controller="chart"
            data-chart-type="bar"
            data-chart-x="<%= raw(@chart_monthly_by_category[:months].to_json) %>"
            data-chart-series="<%= raw((@chart_monthly_by_category[:series] || []).map { |s| s.merge(type: 'bar') }.to_json) %>"
            style="height:280px"
          ></div>
        </div>
      </div>
    </div>
  </div>

  <!-- High-impact charts row 3: Category Profitability -->
  <div class="row mt-4 g-3">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-city"></i> Brand Profitability</div>
        <div class="card-body">
          <div
            data-controller="chart"
            data-chart-type="bar"
            data-chart-x="<%= raw(@chart_brand_profit[:brands].to_json) %>"
            data-chart-series='[{"name":"Utilidad","data":<%= raw(@chart_brand_profit[:profit].map(&:to_f).to_json) %>}]'
            style="height:280px"
          ></div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-tags"></i> Category Profitability</div>
        <div class="card-body">
          <div
            data-controller="chart"
            data-chart-type="bar"
            data-chart-x="<%= raw((@chart_category_profit[:categories] || []).to_json) %>"
            data-chart-series='[{"name":"Utilidad","data":<%= raw((@chart_category_profit[:profit] || []).map(&:to_f).to_json) %>}]'
            style="height:280px"
          ></div>
        </div>
      </div>
    </div>
  </div>
  <!-- (Se eliminó el bloque final de "Producto top por categoría (Profit)") -->
</div>

<!-- Sin scripts inline: todos los charts usan Stimulus chart_controller -->
