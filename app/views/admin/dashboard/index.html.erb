<div class="container-fluid">
  <h2 class="mb-3"><i class="fa-solid fa-chart-line"></i> Dashboard</h2>

  <!-- KPIs al tope (estratégico) -->
  <div class="row g-3 mb-3">
    <div class="col-md-4 col-lg-3">
      <%= render "kpi_card",
        title: "Ventas YTD (MXN)",
        value: "$ #{number_with_precision(@sales_ytd, precision: 2, delimiter: ',')}",
        ly: "$ #{number_with_precision(@sales_prev, precision: 2, delimiter: ',')}",
        delta: @kpi_deltas&.dig(:sales),
        spark_id: "sparkline-revenue",
        variant: "text-bg-success-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-3">
      <%= render "kpi_card",
        title: "Ganancia YTD",
        value: "$ #{number_with_precision(@profit_ytd, precision: 2, delimiter: ',')}",
        ly: "$ #{number_with_precision(@profit_prev, precision: 2, delimiter: ',')}",
        delta: @kpi_deltas&.dig(:profit),
        variant: "text-bg-primary-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-3">
      <%= render "kpi_card",
        title: "Margen YTD",
        value: number_to_percentage(@margin_ytd * 100, precision: 1),
        ly: number_to_percentage(@margin_prev * 100, precision: 1),
        delta: @kpi_deltas&.dig(:margin_pp),
        variant: "text-bg-warning-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-3">
      <%= render "kpi_card",
        title: "Compras totales en MXN (All Time)",
        value: "$ #{number_with_precision(@purchases_total_mxn, precision: 2, delimiter: ',')}",
        variant: "text-bg-warning-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-3">
      <%= render "kpi_card",
        title: "PO en el año",
        value: number_with_delimiter(@po_count_ytd),
        ly: number_with_delimiter(@po_count_prev),
        delta: @kpi_deltas&.dig(:po_count),
        variant: "text-bg-primary-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-3">
      <%= render "kpi_card",
        title: "SO en el año",
        value: number_with_delimiter(@orders_count_ytd),
        ly: number_with_delimiter(@orders_prev),
        delta: @kpi_deltas&.dig(:orders),
        variant: "text-bg-primary-subtle"
      %>
    </div>
  </div>
  <div class="row g-3 mb-3">
    <div class="col-md-4 col-lg-4">
      <%= render "kpi_card",
        title: "Ventas totales en MXN (All Time)",
        value: "$ #{number_with_precision(@sales_total_mxn, precision: 2, delimiter: ',')}",
        variant: "text-bg-success-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-4">
      <%= render "kpi_card",
        title: "Clientes activos",
        value: number_with_delimiter(@active_customers_ytd),
        ly: number_with_delimiter(@active_customers_prev),
        delta: @kpi_deltas&.dig(:customers),
        variant: "text-bg-primary-subtle"
      %>
    </div>
    <div class="col-md-4 col-lg-4">
      <%= render "kpi_card",
        title: "Valor total de inventario (MXN)",
        value: "$ #{number_with_precision(@inventory_total_value, precision: 2, delimiter: ',')}",
        ly: (@inventory_turnover_ytd.nil? ? nil : "Rotación: #{number_with_precision(@inventory_turnover_ytd, precision: 2, delimiter: ',')}") ,
        variant: "text-bg-warning-subtle"
      %>
    </div>
  </div>

  <!-- KPIs tácticos (rápidos) -->
  <div class="row g-3 mb-3">
    <div class="col-md-2 col-6">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="small text-muted">Ticket promedio</div>
          <div class="fs-6 fw-bold">$ <%= number_with_precision(@avg_ticket_ytd, precision: 2, delimiter: ',') %></div>
        </div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="small text-muted">Conversión</div>
          <div class="fs-6 fw-bold"><%= @conversion_rate_ytd.nil? ? '—' : number_to_percentage(@conversion_rate_ytd * 100, precision: 2) %></div>
        </div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="small text-muted">Stock crítico</div>
          <div class="fs-6 fw-bold"><%= @critical_stock_count.nil? ? '—' : number_with_delimiter(@critical_stock_count) %></div>
        </div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card h-100">
        <div class="card-body py-2">
          <div class="small text-muted">Recurrentes</div>
          <div class="fs-6 fw-bold"><%= @recurring_customers_ratio.nil? ? '—' : number_to_percentage(@recurring_customers_ratio * 100, precision: 1) %></div>
        </div>
      </div>
    </div>
  </div>

  <!-- (Se removió el bloque de filtros globales a solicitud) -->

  <!-- (Se eliminó la tabla duplicada de Países de la parte superior) -->

  <!-- Top productos: combinado Sellers/Rentables + Inventario -->
  <div class="row mt-3 g-3">
    <div class="col-xl-8">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="d-flex flex-column flex-md-row w-100 justify-content-between align-items-md-center gap-2">
            <i class="fa-solid fa-boxes"></i> Productos
            <ul class="nav nav-tabs nav-tabs-sm card-header-tabs mt-2 d-none d-md-flex" role="tablist">
              <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-sellers-ytd" type="button" role="tab" aria-controls="tp-sellers-ytd" aria-selected="true">Sellers · YTD</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-sellers-ly" type="button" role="tab" aria-controls="tp-sellers-ly">Sellers · LY</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-sellers-all" type="button" role="tab" aria-controls="tp-sellers-all">Sellers · All</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-profit-ytd" type="button" role="tab" aria-controls="tp-profit-ytd">Rentables · YTD</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-profit-ly" type="button" role="tab" aria-controls="tp-profit-ly">Rentables · LY</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tp-profit-all" type="button" role="tab" aria-controls="tp-profit-all">Rentables · All</button></li>
            </ul>
            <select class="form-select form-select-sm d-md-none w-auto" aria-label="Seleccionar pestaña" data-action="change->tabs#select">
              <option value="#tp-sellers-ytd" selected>Sellers · YTD</option>
              <option value="#tp-sellers-ly">Sellers · LY</option>
              <option value="#tp-sellers-all">Sellers · All</option>
              <option value="#tp-profit-ytd">Rentables · YTD</option>
              <option value="#tp-profit-ly">Rentables · LY</option>
              <option value="#tp-profit-all">Rentables · All</option>
            </select>
          </div>
          <div>
            <a href="<%= admin_products_path %>" class="btn btn-sm btn-outline-primary">Ver detalle</a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <!-- Sellers YTD -->
    <div class="tab-pane fade show active" id="tp-sellers-ytd" role="tabpanel" data-tabs-target="panel">
      <turbo-frame id="frame-sellers-ytd" src="<%= admin_dashboard_sellers_path(period: 'ytd') %>">
                    <div class="table-responsive dashboard-scroll">
                      <table class="table table-sm mb-0">
                        <thead>
                          <tr>
                            <th scope="col">Rank</th>
                            <th scope="col">Producto</th>
                            <th scope="col" class="text-end">Unidades</th>
                            <th scope="col" class="text-end">Ingresos</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% if @top_sellers_ytd.present? %>
                            <% @top_sellers_ytd.each_with_index do |r, idx| %>
                              <tr>
                                <td class="text-muted">#<%= idx + 1 %></td>
                                <td>
                                  <div class="small fw-semibold"><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></div>
                                  <% if r[:brand].present? || r[:category].present? %>
                                    <div class="text-muted" style="font-size: .75rem;">(<%= [r[:brand], r[:category]].compact.join(' - ') %>)</div>
                                  <% end %>
                                </td>
                                <td class="text-end"><%= number_with_delimiter(r[:units]) %></td>
                                <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                              </tr>
                            <% end %>
                          <% else %>
                            <% 3.times do %>
                              <tr class="placeholder-row">
                                <td colspan="4" class="placeholder-glow"><span class="placeholder col-12"></span></td>
                              </tr>
                            <% end %>
                          <% end %>
                        </tbody>
                      </table>
              </div>
            </turbo-frame>
            </div>
            <!-- Sellers LY -->
            <div class="tab-pane fade" id="tp-sellers-ly" role="tabpanel" data-tabs-target="panel">
                  <turbo-frame id="frame-sellers-ly" src="<%= admin_dashboard_sellers_path(period: 'ly') %>">
                    <div class="table-responsive dashboard-scroll">
                      <table class="table table-sm mb-0">
                        <thead>
                          <tr>
                            <th scope="col">Rank</th>
                            <th scope="col">Producto</th>
                            <th scope="col" class="text-end">Unidades</th>
                            <th scope="col" class="text-end">Ingresos</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% 3.times do %>
                            <tr class="placeholder-row">
                              <td colspan="4" class="placeholder-glow"><span class="placeholder col-12"></span></td>
                            </tr>
                          <% end %>
                        </tbody>
                      </table>
                    </div>
                  </turbo-frame>
            </div>
            <!-- Sellers All -->
            <div class="tab-pane fade" id="tp-sellers-all" role="tabpanel" data-tabs-target="panel">
                  <turbo-frame id="frame-sellers-all" src="<%= admin_dashboard_sellers_path(period: 'all') %>">
                    <div class="table-responsive dashboard-scroll">
                      <table class="table table-sm mb-0">
                        <thead>
                          <tr>
                            <th scope="col">Rank</th>
                            <th scope="col">Producto</th>
                            <th scope="col" class="text-end">Unidades</th>
                            <th scope="col" class="text-end">Ingresos</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% 3.times do %>
                            <tr class="placeholder-row">
                              <td colspan="4" class="placeholder-glow"><span class="placeholder col-12"></span></td>
                            </tr>
                          <% end %>
                        </tbody>
                      </table>
                    </div>
                  </turbo-frame>
            </div>

            <!-- Rentables YTD -->
            <div class="tab-pane fade" id="tp-profit-ytd" role="tabpanel" data-tabs-target="panel">
              <turbo-frame id="frame-profit-ytd" src="<%= admin_dashboard_profitable_path(period: 'ytd') %>">
                <div class="table-responsive">
                  <table class="table table-sm mb-0">
                    <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Utilidad</th></tr></thead>
                    <tbody>
                      <% 3.times do %>
                        <tr class="placeholder-row">
                          <td colspan="5" class="placeholder-glow"><span class="placeholder col-12"></span></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </turbo-frame>
            </div>
            <!-- Rentables LY -->
            <div class="tab-pane fade" id="tp-profit-ly" role="tabpanel" data-tabs-target="panel">
              <turbo-frame id="frame-profit-ly" src="<%= admin_dashboard_profitable_path(period: 'ly') %>">
                <div class="table-responsive">
                  <table class="table table-sm mb-0">
                    <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Utilidad</th></tr></thead>
                    <tbody>
                      <% 3.times do %>
                        <tr class="placeholder-row">
                          <td colspan="5" class="placeholder-glow"><span class="placeholder col-12"></span></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </turbo-frame>
            </div>
            <!-- Rentables All -->
            <div class="tab-pane fade" id="tp-profit-all" role="tabpanel" data-tabs-target="panel">
              <turbo-frame id="frame-profit-all" src="<%= admin_dashboard_profitable_path(period: 'all') %>">
                <div class="table-responsive">
                  <table class="table table-sm mb-0">
                    <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Utilidad</th></tr></thead>
                    <tbody>
                      <% 3.times do %>
                        <tr class="placeholder-row">
                          <td colspan="5" class="placeholder-glow"><span class="placeholder col-12"></span></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </turbo-frame>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-boxes-stacked"></i> Top Inventario</span>
          <div class="d-flex align-items-center gap-2 w-50 justify-content-end">
            <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
              <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-inv-val" type="button" role="tab" aria-controls="ti-inv-val" aria-selected="true">Inv · Valor</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-inv-qty" type="button" role="tab" aria-controls="ti-inv-qty">Inv · Unidades</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-res-val" type="button" role="tab" aria-controls="ti-res-val">Apart · Valor</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-res-qty" type="button" role="tab" aria-controls="ti-res-qty">Apart · Unidades</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-all-val" type="button" role="tab" aria-controls="ti-all-val">Todos · Valor</button></li>
              <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#ti-all-qty" type="button" role="tab" aria-controls="ti-all-qty">Todos · Unidades</button></li>
            </ul>
            <select class="form-select form-select-sm d-md-none w-auto" aria-label="Seleccionar pestaña" data-action="change->tabs#select">
              <option value="#ti-inv-val" selected>Inv · Valor</option>
              <option value="#ti-inv-qty">Inv · Unidades</option>
              <option value="#ti-res-val">Apart · Valor</option>
              <option value="#ti-res-qty">Apart · Unidades</option>
              <option value="#ti-all-val">Todos · Valor</option>
              <option value="#ti-all-qty">Todos · Unidades</option>
            </select>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <!-- Inv · Valor -->
            <div class="tab-pane fade show active" id="ti-inv-val" role="tabpanel" data-tabs-target="panel">
              <turbo-frame id="frame-inventory-inv-value" src="<%= admin_dashboard_inventory_top_path(scope: 'inv', metric: 'value') %>">
                <div class="table-responsive">
                  <table class="table table-sm mb-0">
                    <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Valor de Inventario</th></tr></thead>
                    <tbody>
                      <% 3.times do %>
                        <tr class="placeholder-row">
                          <td colspan="3" class="placeholder-glow"><span class="placeholder col-12"></span></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </turbo-frame>
            </div>
            <!-- Inv · Unidades -->
            <div class="tab-pane fade" id="ti-inv-qty" role="tabpanel" data-tabs-target="panel">
              <turbo-frame id="frame-inventory-inv-qty" src="<%= admin_dashboard_inventory_top_path(scope: 'inv', metric: 'qty') %>">
                <div class="table-responsive">
                  <table class="table table-sm mb-0">
                    <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Unidades</th><th class="text-end">Valor (MXN)</th></tr></thead>
                    <tbody>
                      <% 3.times do %>
                        <tr class="placeholder-row">
                          <td colspan="4" class="placeholder-glow"><span class="placeholder col-12"></span></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </turbo-frame>
            </div>
            <!-- Apartados · Valor -->
            <div class="tab-pane fade" id="ti-res-val" role="tabpanel" data-tabs-target="panel">
              <turbo-frame id="frame-inventory-res-value" src="<%= admin_dashboard_inventory_top_path(scope: 'res', metric: 'value') %>">
                <div class="table-responsive">
                  <table class="table table-sm mb-0">
                    <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Valor de Apartados</th></tr></thead>
                    <tbody>
                      <% 3.times do %>
                        <tr class="placeholder-row">
                          <td colspan="3" class="placeholder-glow"><span class="placeholder col-12"></span></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </turbo-frame>
            </div>
            <!-- Apartados · Unidades -->
            <div class="tab-pane fade" id="ti-res-qty" role="tabpanel" data-tabs-target="panel">
              <turbo-frame id="frame-inventory-res-qty" src="<%= admin_dashboard_inventory_top_path(scope: 'res', metric: 'qty') %>">
                <div class="table-responsive">
                  <table class="table table-sm mb-0">
                    <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Unidades</th><th class="text-end">Valor (MXN)</th></tr></thead>
                    <tbody>
                      <% 3.times do %>
                        <tr class="placeholder-row">
                          <td colspan="4" class="placeholder-glow"><span class="placeholder col-12"></span></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </turbo-frame>
            </div>
            <!-- Todos · Valor -->
            <div class="tab-pane fade" id="ti-all-val" role="tabpanel" data-tabs-target="panel">
              <turbo-frame id="frame-inventory-all-value" src="<%= admin_dashboard_inventory_top_path(scope: 'all', metric: 'value') %>">
                <div class="table-responsive">
                  <table class="table table-sm mb-0">
                    <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Valor (MXN)</th></tr></thead>
                    <tbody>
                      <% 3.times do %>
                        <tr class="placeholder-row">
                          <td colspan="3" class="placeholder-glow"><span class="placeholder col-12"></span></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </turbo-frame>
            </div>
            <!-- Todos · Unidades -->
            <div class="tab-pane fade" id="ti-all-qty" role="tabpanel" data-tabs-target="panel">
              <turbo-frame id="frame-inventory-all-qty" src="<%= admin_dashboard_inventory_top_path(scope: 'all', metric: 'qty') %>">
                <div class="table-responsive">
                  <table class="table table-sm mb-0">
                    <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Unidades</th><th class="text-end">Valor (MXN)</th></tr></thead>
                    <tbody>
                      <% 3.times do %>
                        <tr class="placeholder-row">
                          <td colspan="4" class="placeholder-glow"><span class="placeholder col-12"></span></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </turbo-frame>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top categorías + Top clientes (lado a lado) -->
  <div class="row mt-4 g-3">
    <div class="col-xl-6">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-layer-group"></i> Top Categorías</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ytd-rev" type="button" role="tab" aria-controls="tc-ytd-rev" aria-selected="true">YTD · Ingresos</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ytd-prof" type="button" role="tab" aria-controls="tc-ytd-prof">YTD · Utilidad</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ly-rev" type="button" role="tab" aria-controls="tc-ly-rev">LY · Ingresos</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-ly-prof" type="button" role="tab" aria-controls="tc-ly-prof">LY · Utilidad</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-all-rev" type="button" role="tab" aria-controls="tc-all-rev">All · Ingresos</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#tc-all-prof" type="button" role="tab" aria-controls="tc-all-prof">All · Utilidad</button></li>
          </ul>
          <select class="form-select form-select-sm d-md-none w-auto" aria-label="Seleccionar periodo" data-action="change->tabs#select">
            <option value="#tc-ytd-rev" selected>YTD · Ingresos</option>
            <option value="#tc-ytd-prof">YTD · Utilidad</option>
            <option value="#tc-ly-rev">LY · Ingresos</option>
            <option value="#tc-ly-prof">LY · Utilidad</option>
            <option value="#tc-all-rev">All · Ingresos</option>
            <option value="#tc-all-prof">All · Utilidad</option>
          </select>
          <div><a class="btn btn-sm btn-outline-primary" href="<%= admin_products_path %>">Ver detalle</a></div>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <!-- YTD · Ingresos -->
            <div class="tab-pane fade show active" id="tc-ytd-rev" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Categoría</th><th class="text-end">Ingresos</th></tr></thead>
                      <tbody>
                        <% @top_categories_ytd&.each_with_index do |r, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= r[:category] %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_categories_ytd.blank? %>
                          <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
            </div>
            <!-- YTD · Utilidad -->
            <div class="tab-pane fade" id="tc-ytd-prof" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Categoría</th><th class="text-end">Utilidad</th></tr></thead>
                      <tbody>
                        <% @top_categories_profit_ytd&.each_with_index do |r, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= r[:category] %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:profit], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_categories_profit_ytd.blank? %>
                          <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
            </div>
            <!-- LY · Ingresos -->
            <div class="tab-pane fade" id="tc-ly-rev" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Categoría</th><th class="text-end">Ingresos</th></tr></thead>
                      <tbody>
                        <% @top_categories_last_year&.each_with_index do |r, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= r[:category] %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_categories_last_year.blank? %>
                          <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
            </div>
            <!-- LY · Utilidad -->
            <div class="tab-pane fade" id="tc-ly-prof" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Categoría</th><th class="text-end">Utilidad</th></tr></thead>
                      <tbody>
                        <% @top_categories_profit_last_year&.each_with_index do |r, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= r[:category] %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:profit], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_categories_profit_last_year.blank? %>
                          <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
            </div>
            <!-- All · Ingresos -->
            <div class="tab-pane fade" id="tc-all-rev" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Categoría</th><th class="text-end">Ingresos</th></tr></thead>
                      <tbody>
                        <% @top_categories_all_time&.each_with_index do |r, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= r[:category] %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_categories_all_time.blank? %>
                          <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
            </div>
            <!-- All · Utilidad -->
            <div class="tab-pane fade" id="tc-all-prof" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Categoría</th><th class="text-end">Utilidad</th></tr></thead>
                      <tbody>
                        <% @top_categories_profit_all_time&.each_with_index do |r, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= r[:category] %></td>
                            <td class="text-end">$ <%= number_with_precision(r[:profit], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_categories_profit_all_time.blank? %>
                          <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
            </div>
          </div>
        </div>
      </div>
  </div>
  <div class="col-xl-6">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-ranking-star"></i> Top Customers</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#rank-range-sales" type="button" role="tab" aria-controls="rank-range-sales" aria-selected="true">YTD · Ventas</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#rank-range-reserved" type="button" role="tab" aria-controls="rank-range-reserved">YTD · Apartados</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#rank-range-combined" type="button" role="tab" aria-controls="rank-range-combined">YTD · Combinado</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#rank-ly-sales" type="button" role="tab" aria-controls="rank-ly-sales">LY · Ventas</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#rank-ly-reserved" type="button" role="tab" aria-controls="rank-ly-reserved">LY · Apartados</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#rank-ly-combined" type="button" role="tab" aria-controls="rank-ly-combined">LY · Combinado</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#rank-all-sales" type="button" role="tab" aria-controls="rank-all-sales">All · Ventas</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#rank-all-reserved" type="button" role="tab" aria-controls="rank-all-reserved">All · Apartados</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#rank-all-combined" type="button" role="tab" aria-controls="rank-all-combined">All · Combinado</button></li>
          </ul>
          <select class="form-select form-select-sm d-md-none w-auto" aria-label="Seleccionar periodo" data-action="change->tabs#select">
            <option value="#rank-range-sales" selected>YTD · Ventas</option>
            <option value="#rank-range-reserved">YTD · Apartados</option>
            <option value="#rank-range-combined">YTD · Combinado</option>
            <option value="#rank-ly-sales">LY · Ventas</option>
            <option value="#rank-ly-reserved">LY · Apartados</option>
            <option value="#rank-ly-combined">LY · Combinado</option>
            <option value="#rank-all-sales">All · Ventas</option>
            <option value="#rank-all-reserved">All · Apartados</option>
            <option value="#rank-all-combined">All · Combinado</option>
          </select>
          <a href="<%= admin_users_path %>" class="btn btn-sm btn-outline-primary ms-2">Ver detalle</a>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <!-- YTD · Ventas -->
            <div class="tab-pane fade show active" id="rank-range-sales" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead>
                        <tr>
                          <th>Rank</th>
                          <th>Cliente</th>
                          <th class="text-end">Órdenes</th>
                          <th class="text-end">Ingresos YTD</th>
                          <th class="text-end">Ingresos LY</th>
                          <th class="text-end">Δ vs LY</th>
                        </tr>
                       </thead>
                       <tbody>
                         <% (@top_users_ytd_vs_prev.presence || @top_users_range).each_with_index do |u, idx| %>
                           <tr>
                             <td class="text-muted">#<%= idx + 1 %></td>
                             <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                             <td class="text-end"><%= number_with_delimiter(u[:orders_count]) %></td>
                             <td class="text-end">$ <%= number_with_precision(u[:revenue], precision: 2, delimiter: ',') %></td>
                             <td class="text-end">$ <%= number_with_precision((u[:prev_revenue] || 0), precision: 2, delimiter: ',') %></td>
                             <td class="text-end">
                               <% if u[:revenue_delta_ratio].nil? %>
                                 <span class="text-muted">—</span>
                               <% else %>
                                 <%= number_to_percentage(u[:revenue_delta_ratio] * 100, precision: 1) %>
                               <% end %>
                             </td>
                           </tr>
                         <% end %>
                         <% if @top_users_range.blank? %>
                           <tr><td colspan="6" class="text-center text-muted py-3">No data</td></tr>
                         <% end %>
                       </tbody>
                     </table>
                  </div>
            </div>
            <!-- YTD · Apartados -->
            <div class="tab-pane fade" id="rank-range-reserved" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead>
                        <tr>
                          <th>Rank</th>
                          <th>Cliente</th>
                          <th class="text-end">Unidades apartadas</th>
                          <th class="text-end">Valor apartados (MXN)</th>
                        </tr>
                       </thead>
                       <tbody>
                         <% @top_users_reserved_ytd&.each_with_index do |u, idx| %>
                           <tr>
                             <td class="text-muted">#<%= idx + 1 %></td>
                             <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                             <td class="text-end"><%= number_with_delimiter(u[:units_reserved]) %></td>
                             <td class="text-end">$ <%= number_with_precision(u[:reserved_value], precision: 2, delimiter: ',') %></td>
                           </tr>
                         <% end %>
                         <% if @top_users_reserved_ytd.blank? %>
                           <tr><td colspan="4" class="text-center text-muted py-3">No data</td></tr>
                         <% end %>
                       </tbody>
                     </table>
                  </div>
            </div>
            <!-- YTD · Combinado -->
            <div class="tab-pane fade" id="rank-range-combined" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead>
                        <tr>
                          <th>Rank</th>
                          <th>Cliente</th>
                          <th class="text-end">Órdenes</th>
                          <th class="text-end">Ingresos</th>
                          <th class="text-end">Valor apartados</th>
                          <th class="text-end">Total</th>
                        </tr>
                       </thead>
                       <tbody>
                         <% @top_users_sales_reserved_ytd&.each_with_index do |u, idx| %>
                           <tr>
                             <td class="text-muted">#<%= idx + 1 %></td>
                             <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                             <td class="text-end"><%= number_with_delimiter(u[:orders_count]) %></td>
                             <td class="text-end">$ <%= number_with_precision(u[:revenue], precision: 2, delimiter: ',') %></td>
                             <td class="text-end">$ <%= number_with_precision(u[:reserved_value], precision: 2, delimiter: ',') %></td>
                             <td class="text-end">$ <%= number_with_precision(u[:total], precision: 2, delimiter: ',') %></td>
                           </tr>
                         <% end %>
                         <% if @top_users_sales_reserved_ytd.blank? %>
                           <tr><td colspan="6" class="text-center text-muted py-3">No data</td></tr>
                         <% end %>
                       </tbody>
                     </table>
                  </div>
            </div>
            <!-- LY · Ventas -->
            <div class="tab-pane fade" id="rank-ly-sales" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Cliente</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                      <tbody>
                        <% @top_users_last_year.each_with_index do |u, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                            <td class="text-end"><%= number_with_delimiter(u[:orders_count]) %></td>
                            <td class="text-end">$ <%= number_with_precision(u[:revenue], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_users_last_year.blank? %>
                          <tr><td colspan="4" class="text-center text-muted py-3">No data</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
            </div>
            <!-- LY · Apartados -->
            <div class="tab-pane fade" id="rank-ly-reserved" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Cliente</th><th class="text-end">Unidades apartadas</th><th class="text-end">Valor apartados (MXN)</th></tr></thead>
                      <tbody>
                        <% @top_users_reserved_last_year&.each_with_index do |u, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                            <td class="text-end"><%= number_with_delimiter(u[:units_reserved]) %></td>
                            <td class="text-end">$ <%= number_with_precision(u[:reserved_value], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_users_reserved_last_year.blank? %>
                          <tr><td colspan="4" class="text-center text-muted py-3">No data</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
            </div>
            <!-- LY · Combinado -->
            <div class="tab-pane fade" id="rank-ly-combined" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Cliente</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Valor apartados</th><th class="text-end">Total</th></tr></thead>
                      <tbody>
                        <% @top_users_sales_reserved_last_year&.each_with_index do |u, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                            <td class="text-end"><%= number_with_delimiter(u[:orders_count]) %></td>
                            <td class="text-end">$ <%= number_with_precision(u[:revenue], precision: 2, delimiter: ',') %></td>
                            <td class="text-end">$ <%= number_with_precision(u[:reserved_value], precision: 2, delimiter: ',') %></td>
                            <td class="text-end">$ <%= number_with_precision(u[:total], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_users_sales_reserved_last_year.blank? %>
                          <tr><td colspan="6" class="text-center text-muted py-3">No data</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
            </div>
            <!-- All · Ventas -->
            <div class="tab-pane fade" id="rank-all-sales" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Cliente</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                      <tbody>
                        <% @top_users_all.each_with_index do |u, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                            <td class="text-end"><%= number_with_delimiter(u[:orders_count]) %></td>
                            <td class="text-end">$ <%= number_with_precision(u[:revenue], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_users_all.blank? %>
                          <tr><td colspan="4" class="text-center text-muted py-3">No data</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                    <div class="px-3 py-2 small text-muted">Nota: en All Time no se muestra comparativo vs años anteriores.</div>
                  </div>
            </div>
            <!-- All · Apartados -->
            <div class="tab-pane fade" id="rank-all-reserved" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Cliente</th><th class="text-end">Unidades apartadas</th><th class="text-end">Valor apartados (MXN)</th></tr></thead>
                      <tbody>
                        <% @top_users_reserved_all&.each_with_index do |u, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                            <td class="text-end"><%= number_with_delimiter(u[:units_reserved]) %></td>
                            <td class="text-end">$ <%= number_with_precision(u[:reserved_value], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_users_reserved_all.blank? %>
                          <tr><td colspan="4" class="text-center text-muted py-3">No data</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
            </div>
            <!-- All · Combinado -->
            <div class="tab-pane fade" id="rank-all-combined" role="tabpanel" data-tabs-target="panel">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Rank</th><th>Cliente</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Valor apartados</th><th class="text-end">Total</th></tr></thead>
                      <tbody>
                        <% @top_users_sales_reserved_all&.each_with_index do |u, idx| %>
                          <tr>
                            <td class="text-muted">#<%= idx + 1 %></td>
                            <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                            <td class="text-end"><%= number_with_delimiter(u[:orders_count]) %></td>
                            <td class="text-end">$ <%= number_with_precision(u[:revenue], precision: 2, delimiter: ',') %></td>
                            <td class="text-end">$ <%= number_with_precision(u[:reserved_value], precision: 2, delimiter: ',') %></td>
                            <td class="text-end">$ <%= number_with_precision(u[:total], precision: 2, delimiter: ',') %></td>
                          </tr>
                        <% end %>
                        <% if @top_users_sales_reserved_all.blank? %>
                          <tr><td colspan="6" class="text-center text-muted py-3">No data</td></tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Otras tablas: Geografía -->
  <div class="row mt-4">
    <div class="col-xl-8">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-flag"></i> Ventas por Estado (México)</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#mx-ytd" type="button" role="tab" aria-controls="mx-ytd" aria-selected="true">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#mx-ly" type="button" role="tab" aria-controls="mx-ly">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#mx-all" type="button" role="tab" aria-controls="mx-all">All Time</button></li>
          </ul>
          <select class="form-select form-select-sm d-md-none w-auto" aria-label="Seleccionar periodo" data-action="change->tabs#select">
            <option value="#mx-ytd" selected>YTD</option>
            <option value="#mx-ly">Last Year</option>
            <option value="#mx-all">All Time</option>
          </select>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="mx-ytd" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @sales_by_mexico_states_ytd&.each do |r| %>
                      <tr>
                        <td><%= r[:state] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_mexico_states_ytd.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="mx-ly" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @sales_by_mexico_states_last_year&.each do |r| %>
                      <tr>
                        <td><%= r[:state] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_mexico_states_last_year.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="mx-all" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @sales_by_mexico_states_all_time&.each do |r| %>
                      <tr>
                        <td><%= r[:state] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_mexico_states_all_time.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card h-100" data-controller="tabs">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-table"></i> Distribución de Ventas por País</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs d-none d-md-flex" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#cty-ytd" type="button" role="tab" aria-controls="cty-ytd" aria-selected="true">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#cty-ly" type="button" role="tab" aria-controls="cty-ly">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-action="click->tabs#activate" data-tabs-target="tab" data-target="#cty-all" type="button" role="tab" aria-controls="cty-all">All Time</button></li>
          </ul>
          <select class="form-select form-select-sm d-md-none w-auto" aria-label="Seleccionar periodo" data-action="change->tabs#select">
            <option value="#cty-ytd" selected>YTD</option>
            <option value="#cty-ly">Last Year</option>
            <option value="#cty-all">All Time</option>
          </select>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="cty-ytd" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                  <tbody>
                    <% @sales_by_country_ytd&.each do |r| %>
                      <tr>
                        <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_country_ytd.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="cty-ly" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                  <tbody>
                    <% @sales_by_country_last_year&.each do |r| %>
                      <tr>
                        <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_country_last_year.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="cty-all" role="tabpanel" data-tabs-target="panel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                  <tbody>
                    <% @sales_by_country_all_time&.each do |r| %>
                      <tr>
                        <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_country_all_time.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <!-- Worst Products KPIs -->
  <div class="row mt-4 g-3">
    <div class="col-lg-12">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-triangle-exclamation"></i> Worst Products</span>
          <div class="small text-muted">w1=0.4, w2=0.2, w3=0.2, w4=0.2 (ajustables por query params)</div>
        </div>
        <div class="card-body">
          <div class="row text-center mb-3">
            <div class="col-md-3">
              <div class="small text-muted">Capital inmovilizado</div>
              <div class="fs-5 fw-bold">$ <%= number_with_precision(@worst_global_total_immobilized_capital, precision: 2, delimiter: ',') %></div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">Margen promedio</div>
              <div class="fs-5 fw-bold"><%= @worst_global_avg_margin_pct.nil? ? '—' : number_to_percentage(@worst_global_avg_margin_pct * 100, precision: 1) %></div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">Rotación promedio</div>
              <div class="fs-5 fw-bold"><%= @worst_global_avg_rotation.nil? ? '—' : number_with_precision(@worst_global_avg_rotation, precision: 2, delimiter: ',') %></div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">DOH promedio</div>
              <div class="fs-5 fw-bold"><%= @worst_global_avg_doh.nil? ? '—' : number_with_precision(@worst_global_avg_doh, precision: 1, delimiter: ',') %></div>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-xl-6">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Margen</th></tr></thead>
                  <tbody>
                    <% @worst_margin_products&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td>
                          <div class="small fw-semibold"><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></div>
                          <div class="text-muted" style="font-size: .75rem;">(<%= [r[:brand], r[:category]].compact.join(' - ') %>)</div>
                        </td>
                        <td class="text-end"><%= r[:margin_pct].nil? ? '—' : number_to_percentage(r[:margin_pct] * 100, precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @worst_margin_products.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-xl-6">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Rotación</th></tr></thead>
                  <tbody>
                    <% @worst_rotation_products&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td>
                          <div class="small fw-semibold"><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></div>
                          <div class="text-muted" style="font-size: .75rem;">(<%= [r[:brand], r[:category]].compact.join(' - ') %>)</div>
                        </td>
                        <td class="text-end"><%= r[:rotation].nil? ? '—' : number_with_precision(r[:rotation], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @worst_rotation_products.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-xl-6">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">DOH</th></tr></thead>
                  <tbody>
                    <% @top_doh_products&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td>
                          <div class="small fw-semibold"><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></div>
                          <div class="text-muted" style="font-size: .75rem;">(<%= [r[:brand], r[:category]].compact.join(' - ') %>)</div>
                        </td>
                        <td class="text-end"><%= r[:doh].infinite? ? '∞' : number_with_precision(r[:doh], precision: 1, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_doh_products.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-xl-6">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Capital inmovilizado</th></tr></thead>
                  <tbody>
                    <% @top_immobilized_products&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td>
                          <div class="small fw-semibold"><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></div>
                          <div class="text-muted" style="font-size: .75rem;">(<%= [r[:brand], r[:category]].compact.join(' - ') %>)</div>
                        </td>
                        <td class="text-end">$ <%= number_with_precision(r[:immobilized_capital], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_immobilized_products.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-xl-12">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Worst Score</th><th class="text-end">Margen</th><th class="text-end">Rotación</th><th class="text-end">DOH</th><th class="text-end">Capital</th></tr></thead>
                  <tbody>
                    <% @worst_score_products&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td>
                          <div class="small fw-semibold"><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></div>
                          <div class="text-muted" style="font-size: .75rem;">(<%= [r[:brand], r[:category]].compact.join(' - ') %>)</div>
                        </td>
                        <td class="text-end"><%= number_with_precision(r[:worst_score], precision: 3, delimiter: ',') %></td>
                        <td class="text-end"><%= r[:margin_pct].nil? ? '—' : number_to_percentage(r[:margin_pct] * 100, precision: 1) %></td>
                        <td class="text-end"><%= r[:rotation].nil? ? '—' : number_with_precision(r[:rotation], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= r[:doh].infinite? ? '∞' : number_with_precision(r[:doh], precision: 1, delimiter: ',') %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:immobilized_capital], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @worst_score_products.blank? %>
                      <tr><td colspan="7" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- High-impact charts row 1 -->
  <div class="row mt-4 g-3">
    <div class="col-lg-12">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-chart-line"></i> Sales Comparison (12 months)</span>
          <a href="<%= admin_sale_orders_path %>" class="btn btn-sm btn-outline-primary">Ver detalle</a>
        </div>
        <div class="card-body">
          <div
            data-controller="chart"
            data-chart-type="line"
            data-chart-x="<%= raw(@chart_sales_trend[:months].to_json) %>"
            data-chart-series="<%= raw([
              { name: 'Revenue', data: @chart_sales_trend[:revenue].map(&:to_f) },
              { name: 'COGS',    data: @chart_sales_trend[:cogs].map(&:to_f) },
              { name: 'Profit',  data: @chart_sales_trend[:profit].map(&:to_f) }
            ].to_json) %>"
            style="height:280px"
          ></div>
        </div>
      </div>
    </div>
  </div>

  <!-- High-impact charts row 2 -->
  <div class="row mt-4 g-3">
    <div class="col-lg-12">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-chart-column"></i> Sales by Month (stacked by category)</div>
        <div class="card-body">
          <div
            data-controller="chart"
            data-chart-type="bar"
            data-chart-x="<%= raw(@chart_monthly_by_category[:months].to_json) %>"
            data-chart-series="<%= raw((@chart_monthly_by_category[:series] || []).map { |s| s.merge(type: 'bar') }.to_json) %>"
            style="height:280px"
          ></div>
        </div>
      </div>
    </div>
  </div>

  <!-- High-impact charts row 3: Category Profitability -->
  <div class="row mt-4 g-3">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-city"></i> Brand Profitability</div>
        <div class="card-body">
          <div
            data-controller="chart"
            data-chart-type="bar"
            data-chart-x="<%= raw(@chart_brand_profit[:brands].to_json) %>"
            data-chart-series='[{"name":"Utilidad","data":<%= raw(@chart_brand_profit[:profit].map(&:to_f).to_json) %>}]'
            style="height:280px"
          ></div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-tags"></i> Category Profitability</div>
        <div class="card-body">
          <div
            data-controller="chart"
            data-chart-type="bar"
            data-chart-x="<%= raw((@chart_category_profit[:categories] || []).to_json) %>"
            data-chart-series='[{"name":"Utilidad","data":<%= raw((@chart_category_profit[:profit] || []).map(&:to_f).to_json) %>}]'
            style="height:280px"
          ></div>
        </div>
      </div>
    </div>
  </div>
  <!-- (Se eliminó el bloque final de "Producto top por categoría (Profit)") -->
</div>

<!-- Sin scripts inline: todos los charts usan Stimulus chart_controller -->
