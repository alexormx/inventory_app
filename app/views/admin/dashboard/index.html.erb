<div class="container-fluid">
  <h2 class="mb-3"><i class="fa-solid fa-chart-line"></i> Dashboard</h2>

  <!-- KPIs al tope -->
  <div class="row g-3 mb-3">
    <div class="col-md-2 col-6">
      <div class="card text-bg-light h-100">
        <div class="card-body">
          <div class="small text-muted">Productos</div>
          <div class="fs-4 fw-bold"><%= number_with_delimiter(@total_products) %></div>
        </div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card text-bg-light h-100">
        <div class="card-body">
          <div class="small text-muted">Usuarios</div>
          <div class="fs-4 fw-bold"><%= number_with_delimiter(@total_users) %></div>
        </div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card text-bg-success-subtle h-100">
        <div class="card-body">
          <div class="small text-muted">Ventas YTD</div>
          <div class="fs-5 fw-bold">$ <%= number_with_precision(@sales_ytd, precision: 2, delimiter: ',') %></div>
        </div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card text-bg-warning-subtle h-100">
        <div class="card-body">
          <div class="small text-muted">Compras YTD</div>
          <div class="fs-5 fw-bold">$ <%= number_with_precision(@purchases_ytd, precision: 2, delimiter: ',') %></div>
        </div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card text-bg-primary-subtle h-100">
        <div class="card-body">
          <div class="small text-muted">Ganancia YTD</div>
          <div class="fs-5 fw-bold">$ <%= number_with_precision(@profit_ytd, precision: 2, delimiter: ',') %></div>
        </div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="card text-bg-info-subtle h-100">
        <div class="card-body">
          <div class="small text-muted">Margen YTD</div>
          <div class="fs-4 fw-bold"><%= number_to_percentage(@margin_ytd * 100, precision: 1) %></div>
        </div>
      </div>
    </div>
  </div>

  <!-- (Se removió el bloque de filtros globales a solicitud) -->

  <!-- (Se eliminó la tabla duplicada de Países de la parte superior) -->

  <!-- Top productos -->
  <div class="row mt-3 g-3">
    <div class="col-xl-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-trophy"></i> Top Sellers</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ts-ytd" type="button" role="tab">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ts-ly" type="button" role="tab">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ts-all" type="button" role="tab">All Time</button></li>
          </ul>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="ts-ytd" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Unidades</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @top_sellers_ytd&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:units]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_sellers_ytd.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="ts-ly" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Unidades</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @top_sellers_last_year&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:units]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_sellers_last_year.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="ts-all" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Unidades</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @top_products_all&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:units]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_products_all.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-sack-dollar"></i> Productos más rentables</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#pp-ytd" type="button" role="tab">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#pp-ly" type="button" role="tab">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#pp-all" type="button" role="tab">All Time</button></li>
          </ul>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="pp-ytd" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Profit</th></tr></thead>
                  <tbody>
                    <% @top_products_profit_ytd&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:cogs], precision: 2, delimiter: ',') %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:profit], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_products_profit_ytd.blank? %>
                      <tr><td colspan="5" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="pp-ly" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Profit</th></tr></thead>
                  <tbody>
                    <% @top_products_profit_last_year&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:cogs], precision: 2, delimiter: ',') %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:profit], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_products_profit_last_year.blank? %>
                      <tr><td colspan="5" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="pp-all" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Ingresos</th><th class="text-end">COGS</th><th class="text-end">Profit</th></tr></thead>
                  <tbody>
                    <% @top_products_profit_all_time&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:cogs], precision: 2, delimiter: ',') %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:profit], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_products_profit_all_time.blank? %>
                      <tr><td colspan="5" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-boxes-stacked"></i> Top Inventario por Valor</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead><tr><th>Rank</th><th>Producto</th><th class="text-end">Valor de Inventario</th></tr></thead>
              <tbody>
                <% @top_inventory_by_value&.each_with_index do |r, idx| %>
                  <tr>
                    <td class="text-muted">#<%= idx + 1 %></td>
                    <td><%= link_to r[:name], edit_admin_product_path(r[:product_id]) %></td>
                    <td class="text-end">$ <%= number_with_precision(r[:inventory_value], precision: 2, delimiter: ',') %></td>
                  </tr>
                <% end %>
                <% if @top_inventory_by_value.blank? %>
                  <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top ventas -->
  <div class="row mt-4 g-3">
    <div class="col-xl-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-layer-group"></i> Top Categorías</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tc-ytd" type="button" role="tab">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tc-ly" type="button" role="tab">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tc-all" type="button" role="tab">All Time</button></li>
          </ul>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="tc-ytd" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Categoría</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @top_categories_ytd&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= r[:category] %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_categories_ytd.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="tc-ly" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Categoría</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @top_categories_last_year&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= r[:category] %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_categories_last_year.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="tc-all" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Categoría</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @top_categories_all_time&.each_with_index do |r, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= r[:category] %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_categories_all_time.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- (Se eliminó la tarjeta duplicada de "Producto top por categoría (Profit)") -->
  </div>

  <!-- Top clientes -->
  <div class="row mt-4 g-3">
    <div class="col-xl-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-ranking-star"></i> Top Customers</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#rank-range" type="button" role="tab">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#rank-ly" type="button" role="tab">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#rank-all" type="button" role="tab">All Time</button></li>
          </ul>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="rank-range" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead>
                    <tr>
                      <th>Rank</th>
                      <th>Cliente</th>
                      <th class="text-end">Órdenes</th>
                      <th class="text-end">Ingresos YTD</th>
                      <th class="text-end">Ingresos LY</th>
                      <th class="text-end">Δ vs LY</th>
                    </tr>
                   </thead>
                   <tbody>
                     <% (@top_users_ytd_vs_prev.presence || @top_users_range).each_with_index do |u, idx| %>
                       <tr>
                         <td class="text-muted">#<%= idx + 1 %></td>
                         <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                         <td class="text-end"><%= number_with_delimiter(u[:orders_count]) %></td>
                         <td class="text-end">$ <%= number_with_precision(u[:revenue], precision: 2, delimiter: ',') %></td>
                         <td class="text-end">$ <%= number_with_precision((u[:prev_revenue] || 0), precision: 2, delimiter: ',') %></td>
                         <td class="text-end">
                           <% if u[:revenue_delta_ratio].nil? %>
                             <span class="text-muted">—</span>
                           <% else %>
                             <%= number_to_percentage(u[:revenue_delta_ratio] * 100, precision: 1) %>
                           <% end %>
                         </td>
                       </tr>
                     <% end %>
                     <% if @top_users_range.blank? %>
                       <tr><td colspan="6" class="text-center text-muted py-3">No data</td></tr>
                     <% end %>
                   </tbody>
                 </table>
              </div>
            </div>
            <div class="tab-pane fade" id="rank-ly" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Customer</th><th class="text-end">Orders</th><th class="text-end">Revenue</th></tr></thead>
                  <tbody>
                    <% @top_users_last_year.each_with_index do |u, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                        <td class="text-end"><%= number_with_delimiter(u[:orders_count]) %></td>
                        <td class="text-end">$ <%= number_with_precision(u[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_users_last_year.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">No data</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="rank-all" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Rank</th><th>Customer</th><th class="text-end">Orders</th><th class="text-end">Revenue</th></tr></thead>
                  <tbody>
                    <% @top_users_all.each_with_index do |u, idx| %>
                      <tr>
                        <td class="text-muted">#<%= idx + 1 %></td>
                        <td><%= link_to u[:name], edit_admin_user_path(u[:user_id]) %></td>
                        <td class="text-end"><%= number_with_delimiter(u[:orders_count]) %></td>
                        <td class="text-end">$ <%= number_with_precision(u[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @top_users_all.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">No data</td></tr>
                    <% end %>
                  </tbody>
                </table>
                <div class="px-3 py-2 small text-muted">Nota: en All Time no se muestra comparativo vs años anteriores.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Otras tablas: Geografía -->
  <div class="row mt-4">
    <div class="col-xl-8">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-flag"></i> Ventas por Estado (México)</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#mx-ytd" type="button" role="tab">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#mx-ly" type="button" role="tab">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#mx-all" type="button" role="tab">All Time</button></li>
          </ul>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="mx-ytd" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @sales_by_mexico_states_ytd&.each do |r| %>
                      <tr>
                        <td><%= r[:state] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_mexico_states_ytd.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="mx-ly" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @sales_by_mexico_states_last_year&.each do |r| %>
                      <tr>
                        <td><%= r[:state] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_mexico_states_last_year.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="mx-all" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>Estado</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th></tr></thead>
                  <tbody>
                    <% @sales_by_mexico_states_all_time&.each do |r| %>
                      <tr>
                        <td><%= r[:state] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_mexico_states_all_time.blank? %>
                      <tr><td colspan="3" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-table"></i> Distribución de Ventas por País</span>
          <ul class="nav nav-tabs nav-tabs-sm card-header-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cty-ytd" type="button" role="tab">YTD</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#cty-ly" type="button" role="tab">Last Year</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#cty-all" type="button" role="tab">All Time</button></li>
          </ul>
        </div>
        <div class="card-body p-0">
          <div class="tab-content">
            <div class="tab-pane fade show active" id="cty-ytd" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                  <tbody>
                    <% @sales_by_country_ytd&.each do |r| %>
                      <tr>
                        <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_country_ytd.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="cty-ly" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                  <tbody>
                    <% @sales_by_country_last_year&.each do |r| %>
                      <tr>
                        <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_country_last_year.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="cty-all" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm mb-0">
                  <thead><tr><th>País</th><th class="text-end">Órdenes</th><th class="text-end">Ingresos</th><th class="text-end">Participación</th></tr></thead>
                  <tbody>
                    <% @sales_by_country_all_time&.each do |r| %>
                      <tr>
                        <td><%= country_flag_emoji(r[:name]) %> <%= r[:name] %></td>
                        <td class="text-end"><%= number_with_delimiter(r[:orders]) %></td>
                        <td class="text-end">$ <%= number_with_precision(r[:revenue], precision: 2, delimiter: ',') %></td>
                        <td class="text-end"><%= number_to_percentage((r[:share] * 100), precision: 1) %></td>
                      </tr>
                    <% end %>
                    <% if @sales_by_country_all_time.blank? %>
                      <tr><td colspan="4" class="text-center text-muted py-3">Sin datos</td></tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <!-- High-impact charts row 1 -->
  <div class="row mt-4 g-3">
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-chart-line"></i> Sales Comparison (12 months)</div>
        <div class="card-body">
          <div id="chart-trend-12m" style="height: 280px;"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-chart-pie"></i> Sales by Product Category</div>
        <div class="card-body">
          <div id="chart-sales-by-category" style="height: 280px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- High-impact charts row 2 -->
  <div class="row mt-4 g-3">
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-chart-column"></i> Sales by Month (stacked by category)</div>
        <div class="card-body">
          <div id="chart-monthly-stacked" style="height: 280px;"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header"><i class="fa-solid fa-city"></i> Brand Profitability</div>
        <div class="card-body">
          <div id="chart-brand-profit" style="height: 280px;"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- (Se eliminó el bloque final de "Producto top por categoría (Profit)") -->
</div>

<!-- ECharts para charts (no mapas) -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
    // Mostrar campos de fecha solo si rango == custom
    document.addEventListener('turbo:load', () => {
      const rangeSel = document.querySelector('select[name="range"]');
      const customFields = document.querySelectorAll('[data-range-custom]');
      const sync = () => {
        const isCustom = rangeSel && rangeSel.value === 'custom';
        customFields.forEach(el => el.style.display = isCustom ? '' : 'none');
      };
      if (rangeSel) {
        rangeSel.addEventListener('change', sync);
      }
      sync();
    });

  // High-impact charts (init on Turbo load)
  document.addEventListener('turbo:load', () => {
    if (!(window.echarts)) return;
    try {
      const lineEl = document.getElementById('chart-trend-12m');
      const donutEl = document.getElementById('chart-sales-by-category');
      const stackedEl = document.getElementById('chart-monthly-stacked');
      const brandEl = document.getElementById('chart-brand-profit');

      if (lineEl) {
        const chart = echarts.init(lineEl);
        const months = <%= raw(@chart_sales_trend[:months].to_json) %>;
        const revenue = <%= raw(@chart_sales_trend[:revenue].map(&:to_f).to_json) %>;
        const cogs = <%= raw(@chart_sales_trend[:cogs].map(&:to_f).to_json) %>;
        const profit = <%= raw(@chart_sales_trend[:profit].map(&:to_f).to_json) %>;
        chart.setOption({
          tooltip: { trigger: 'axis' },
          legend: { data: ['Revenue','COGS','Profit'] },
          xAxis: { type: 'category', data: months },
          yAxis: { type: 'value' },
          series: [
            { name: 'Revenue', type: 'line', data: revenue, smooth: true },
            { name: 'COGS', type: 'line', data: cogs, smooth: true },
            { name: 'Profit', type: 'line', data: profit, smooth: true }
          ]
        });
        window.addEventListener('resize', () => chart.resize());
      }

      if (donutEl) {
        const chart = echarts.init(donutEl);
        const series = <%= raw(@chart_sales_by_category.to_json) %>;
        chart.setOption({
          tooltip: { trigger: 'item' },
          legend: { orient: 'vertical', left: 'left' },
          series: [{
            name: 'Sales by Category', type: 'pie', radius: ['40%','70%'], avoidLabelOverlap: false,
            itemStyle: { borderRadius: 6, borderColor: '#fff', borderWidth: 2 },
            label: { show: false }, emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } },
            labelLine: { show: false }, data: series
          }]
        });
        window.addEventListener('resize', () => chart.resize());
      }

      if (stackedEl) {
        const chart = echarts.init(stackedEl);
        const months = <%= raw(@chart_monthly_by_category[:months].to_json) %>;
        const series = <%= raw(@chart_monthly_by_category[:series].to_json) %>;
        chart.setOption({
          tooltip: { trigger: 'axis' },
          legend: {},
          xAxis: { type: 'category', data: months },
          yAxis: { type: 'value' },
          series: series.map(s => ({ ...s, type: 'bar', stack: 'total' }))
        });
        window.addEventListener('resize', () => chart.resize());
      }

      if (brandEl) {
        const chart = echarts.init(brandEl);
        const brands = <%= raw(@chart_brand_profit[:brands].to_json) %>;
        const profit = <%= raw(@chart_brand_profit[:profit].map(&:to_f).to_json) %>;
        chart.setOption({
          tooltip: { trigger: 'axis' },
          xAxis: { type: 'value' },
          yAxis: { type: 'category', data: brands },
          series: [{ type: 'bar', data: profit, itemStyle: { color: '#4caf50' } }]
        });
        window.addEventListener('resize', () => chart.resize());
      }
    } catch (e) { console.error('Charts error', e); }
  });

  // (Se removió el mapa; no hay inicialización de mapas.)
</script>
