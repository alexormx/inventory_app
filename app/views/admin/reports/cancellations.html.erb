<div class="container mt-4">
  <h2>Reporte de cancelaciones</h2>
  <div class="mb-3">
    <%= form_with url: cancellations_admin_reports_path, method: :get, local: true, class: 'row g-2 align-items-end' do |f| %>
      <div class="col-auto">
        <label class="form-label">Desde</label>
        <%= date_field_tag :from, params[:from], class: 'form-control' %>
      </div>
      <div class="col-auto">
        <label class="form-label">Hasta</label>
        <%= date_field_tag :to, params[:to], class: 'form-control' %>
      </div>
      <div class="col-auto">
        <label class="form-label">ID Cliente</label>
        <%= text_field_tag :user_id, params[:user_id], class: 'form-control', placeholder: 'Opcional' %>
      </div>
      <div class="col-auto">
        <%= submit_tag 'Filtrar', class: 'btn btn-primary' %>
        <%= link_to 'Exportar CSV', cancellations_admin_reports_path(request.query_parameters.merge(format: :csv)), class: 'btn btn-outline-secondary' %>
      </div>
    <% end %>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">Totales por cliente (piezas canceladas)</h5>
      <% if @by_customer.present? %>
        <ul>
          <% @by_customer.each do |user_id, qty| %>
            <li><strong>Cliente #<%= user_id %>:</strong> <%= qty %> piezas</li>
          <% end %>
        </ul>
      <% else %>
        <p class="text-muted">Sin datos para los filtros actuales.</p>
      <% end %>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th>SO</th>
          <th>Cliente</th>
          <th>SKU</th>
          <th>Producto</th>
          <th>Cant. cancelada</th>
          <th>Precio unit.</th>
          <th>Motivo</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody>
        <% @items.each do |it| %>
          <tr>
            <td><%= link_to it.sale_order_id, admin_sale_order_path(it.sale_order_id) %></td>
            <td><%= it.sale_order&.user&.name %></td>
            <td><%= it.product&.product_sku %></td>
            <td><%= it.product&.product_name %></td>
            <td><%= it.canceled_quantity %></td>
            <td><%= number_with_precision(it.sale_price_at_cancellation, precision: 2) %></td>
            <td><%= it.cancellation_reason %></td>
            <td><%= it.canceled_at&.strftime('%F %T') %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <% if @items.respond_to?(:current_page) %>
    <div class="mt-2">
      <%= paginate @items %>
    </div>
  <% end %>
</div>
