<h2 class="mb-3 d-flex align-items-center gap-2"><i class="fa fa-cog"></i> Admin - Settings</h2>
<p class="text-muted">Modify application settings.</p>

<div class="alert alert-info" role="alert">
	<strong>Documentation</strong>
	<ul class="mb-0">
		<li>
			Best Sellers (YTD/LY/All Time) cuentan solo órdenes <em>pagadas/confirmadas</em>:
			<code>Confirmed</code>, <code>Shipped</code>, <code>Delivered</code>. Se excluyen pendientes/canceladas.
		</li>
		<li>
			COGS significa <strong>Cost of Goods Sold</strong> (costo de lo vendido).
		</li>
			<li>
				Rentables (profit por producto) usa:
				<ul>
					<li>Ingresos: suma de <code>unit_final_price * quantity</code> de órdenes pagadas.</li>
					<li>COGS: costo de las unidades vendidas en el periodo (<code>unit_cost * quantity</code> de los SaleOrderItems), independiente de cuándo se compraron.</li>
					<li>Mermas: resta costo de inventario con estatus <code>marketing, damaged, lost, scrap</code> según <code>status_changed_at</code>.</li>
				</ul>
				Utilidad = Ingresos - COGS - Mermas.
			</li>
		<li>
			Inventario: el <em>Average Purchase Cost</em> y <em>Inventory Value (MXN)</em> se calculan con costos compuestos en MXN
			(<code>total_line_cost_in_mxn</code> o <code>unit_compose_cost_in_mxn</code>), sin usar moneda origen.
		</li>
	</ul>
	<small class="text-muted">Última actualización: ajustes a cálculos y documentación.</small>
	</div>

<div class="card mb-4">
		<div class="card-header d-flex align-items-center gap-2">
			<i class="fa fa-sync"></i>
			<span>Sincronización de estados de inventario</span>
		</div>
	<div class="card-body">
				<p class="mb-3">
						Re-evalúa y sincroniza los estados de inventario conforme a la lógica de PO/SO.
				</p>
		<%= button_to "Iniciar sincronización (temporal)", sync_inventory_statuses_admin_settings_path,
									method: :post,
									class: "btn btn-primary",
									data: { turbo_confirm: "¿Confirmas iniciar la sincronización temporal?" } %>
	</div>
</div>

<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-calculator"></i>
		<span>Backfill de totales en Sale Orders</span>
	</div>
	<div class="card-body">
		<p class="mb-3">
			Recalcula <code>total_tax</code> y <code>total_order_value</code> para órdenes con total nulo o en 0.
		</p>
		<%= button_to "Iniciar backfill de Sale Orders", backfill_sale_orders_totals_admin_settings_path,
									method: :post,
									class: "btn btn-outline-primary",
									data: { turbo_confirm: "¿Confirmas iniciar el backfill de Sale Orders?" } %>
		<hr>
		<p class="mb-2 small text-muted">Si tienes órdenes <code>Pending</code> con total en 0 pero líneas cargadas, usa este botón para actualizar sus totales persistidos con el cálculo dinámico.</p>
		<%= button_to "Backfill Pending (solo totales)", backfill_pending_sale_orders_totals_admin_settings_path,
						method: :post,
						class: "btn btn-warning",
						data: { turbo_confirm: "¿Confirmas recalcular totales de órdenes Pending?" } %>
	</div>
</div>

<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-search"></i>
		<span>Auditoría de SO Delivered con Adeudo</span>
	</div>
	<div class="card-body">
		<p class="mb-3">Analiza órdenes en estado Delivered que aún presentan adeudo (pagos incompletos) y opcionalmente crea los pagos faltantes.</p>
		<%= link_to "Abrir auditoría", delivered_orders_debt_audit_admin_settings_path, class: "btn btn-outline-danger" %>
	</div>
</div>

<%# --- Pending Sale Orders Overview (dinámico) --- %>
<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-hourglass-half"></i>
		<span>Pending Sale Orders (vista rápida)</span>
	</div>
	<div class="card-body p-0">
		<% pending_scope = SaleOrder.where(status: 'Pending').includes(:payments, :sale_order_items) %>
		<% if pending_scope.any? %>
			<div class="table-responsive">
				<table class="table table-sm mb-0 align-middle">
					<thead>
						<tr>
							<th>SO</th>
							<th>Cliente</th>
							<th class="text-end">Items</th>
							<th class="text-end">Total (dinámico)</th>
							<th class="text-end">Pagado</th>
							<th class="text-end">Adeudo</th>
							<th></th>
						</tr>
					</thead>
					<tbody>
						<% pending_scope.limit(50).each do |so| %>
							<% dyn = so.compute_dynamic_totals %>
							<% paid = so.payments.where(status: 'Completed').sum(:amount).to_d %>
							<% debt = (dyn[:total] - paid).round(2) %>
							<tr class="<%= 'table-warning' if debt > 0 %>">
								<td><code><%= so.id %></code></td>
								<td><%= so.user&.name || '—' %></td>
								<td class="text-end"><%= so.sale_order_items.sum(:quantity) %></td>
								<td class="text-end"><%= number_to_currency(dyn[:total]) %></td>
								<td class="text-end"><%= number_to_currency(paid) %></td>
								<td class="text-end">
									<% if debt > 0 %>
										<span class="badge bg-danger"><%= number_to_currency(debt) %></span>
									<% else %>
										<span class="badge bg-success">$0.00</span>
									<% end %>
								</td>
								<td class="text-end">
									<%= link_to 'Ver', admin_sale_order_path(so), class: 'btn btn-sm btn-outline-secondary' %>
								</td>
							</tr>
						<% end %>
					</tbody>
				</table>
			</div>
			<div class="p-2 small text-muted border-top">
				Mostrando hasta 50 pendientes (total: <%= pending_scope.count %>). Los totales se calculan en vivo desde las líneas; no usan campos persistidos todavía.
			</div>
		<% else %>
			<div class="p-3 text-muted">No hay órdenes Pending.</div>
		<% end %>
	</div>
</div>

<div class="card">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-list"></i>
		<span>Ejecuciones recientes (todas)</span>
	</div>
	<div class="card-body p-0">
		<div class="table-responsive">
			<table class="table table-sm mb-0 align-middle">
				<thead>
					<tr>
						<th>ID</th>
						<th>Job</th>
						<th>Estado</th>
						<th>Inicio</th>
						<th>Fin</th>
						<th>Duración</th>
						<th>Stats</th>
						<th>Error</th>
					</tr>
				</thead>
				<tbody>
					<% if @runs.present? %>
						<% @runs.each do |r| %>
							<tr>
								<td>#<%= r.id %></td>
								<td><code><%= r.job_name %></code></td>
								<td>
									<% badge_class = case r.status.to_s
													 when 'queued' then 'bg-secondary'
													 when 'running' then 'bg-info'
													 when 'completed' then 'bg-success'
													 when 'failed' then 'bg-danger'
													 else 'bg-light text-dark border'
													 end %>
								<span class="badge <%= badge_class %>"><%= r.status %></span>
								</td>
								<td><%= r.started_at&.strftime('%Y-%m-%d %H:%M:%S') || '-' %></td>
								<td><%= r.finished_at&.strftime('%Y-%m-%d %H:%M:%S') || '-' %></td>
								<td><%= r.duration_seconds ? "#{r.duration_seconds}s" : '-' %></td>
								<td class="text-break" style="max-width: 320px;">
									<% if r.stats.present? %>
										<pre class="mb-0 small"><%= JSON.pretty_generate(r.stats) %></pre>
									<% else %>
										-
									<% end %>
								</td>
								<td class="text-break" style="max-width: 280px;">
									<%= r.error.presence || '-' %>
								</td>
							</tr>
						<% end %>
					<% else %>
						<tr>
							<td colspan="8" class="text-center text-muted">Sin ejecuciones registradas.</td>
						</tr>
					<% end %>
				</tbody>
			</table>
		</div>
	</div>
	<%# Paginación global %>
	<% if @runs.respond_to?(:current_page) %>
		<div class="card-footer py-2">
			<%= paginate @runs %>
		</div>
	<% end %>
</div>