<h2 class="mb-3 d-flex align-items-center gap-2"><i class="fa fa-cog"></i> Admin - Settings</h2>
<p class="text-muted">Modify application settings.</p>

<!-- Acceso rápido a configuraciones principales -->
<div class="row mb-4">
	<div class="col-md-6 col-lg-3 mb-3">
		<%= link_to admin_shipping_methods_path, class: "card text-decoration-none h-100 border-primary" do %>
			<div class="card-body text-center">
				<i class="fa fa-truck fa-2x text-primary mb-2"></i>
				<h6 class="card-title mb-1">Métodos de Envío</h6>
				<p class="card-text small text-muted mb-0"><%= ShippingMethod.active.count %> activos</p>
			</div>
		<% end %>
	</div>
	<div class="col-md-6 col-lg-3 mb-3">
		<%= link_to admin_payment_methods_path, class: "card text-decoration-none h-100 border-success" do %>
			<div class="card-body text-center">
				<i class="fa fa-credit-card fa-2x text-success mb-2"></i>
				<h6 class="card-title mb-1">Métodos de Pago</h6>
				<p class="card-text small text-muted mb-0"><%= PaymentMethod.active.count %> activos</p>
			</div>
		<% end %>
	</div>
	<div class="col-md-6 col-lg-3 mb-3">
		<%= link_to admin_system_variables_path, class: "card text-decoration-none h-100 border-info" do %>
			<div class="card-body text-center">
				<i class="fa fa-database fa-2x text-info mb-2"></i>
				<h6 class="card-title mb-1">Variables del Sistema</h6>
				<p class="card-text small text-muted mb-0">Configuración avanzada</p>
			</div>
		<% end %>
	</div>
	<div class="col-md-6 col-lg-3 mb-3">
		<%= link_to admin_inventory_audit_path, class: "card text-decoration-none h-100 border-warning" do %>
			<div class="card-body text-center">
				<i class="fa fa-warehouse fa-2x text-warning mb-2"></i>
				<h6 class="card-title mb-1">Auditoría Inventario</h6>
				<p class="card-text small text-muted mb-0">Reconciliación PO ↔ Inv</p>
			</div>
		<% end %>
	</div>
</div>

<!-- SEO Configuration -->
<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-search"></i>
		<span>Configuración SEO</span>
	</div>
	<div class="card-body">
		<% seo_site_name = SiteSetting.get('seo_site_name', 'Pasatiempos a Escala') %>
		<% seo_site_title = SiteSetting.get('seo_site_title', 'Tienda de Coleccionables y Autos a Escala') %>
		<% seo_meta_description = SiteSetting.get('seo_meta_description', 'Tienda especializada en modelos a escala, autos de colección Hot Wheels, Greenlight, Majorette y más. Productos 100% originales con envío a todo México.') %>
		<% seo_keywords = SiteSetting.get('seo_keywords', 'autos a escala, hot wheels, greenlight, coleccionables, tienda de coleccionables, autos de colección, diecast, modelos a escala, majorette, jada toys') %>
		
		<div class="alert alert-info small mb-3">
			<i class="fa fa-info-circle me-1"></i>
			<strong>SEO (Search Engine Optimization)</strong>: Esta información ayuda a que tu tienda aparezca en buscadores como Google cuando los usuarios busquen términos relacionados con tus productos.
		</div>
		
		<%= form_with url: admin_settings_path, method: :post, data: { turbo: false } do %>
			<div class="row">
				<div class="col-md-6 mb-3">
					<label class="form-label">Nombre del sitio</label>
					<input type="text" name="seo_site_name" class="form-control" value="<%= seo_site_name %>" placeholder="Ej: Pasatiempos a Escala">
					<small class="text-muted">Aparece en títulos y redes sociales</small>
				</div>
				<div class="col-md-6 mb-3">
					<label class="form-label">Slogan / Título principal</label>
					<input type="text" name="seo_site_title" class="form-control" value="<%= seo_site_title %>" placeholder="Ej: Tienda de Coleccionables y Autos a Escala">
					<small class="text-muted">Complementa el nombre en el título de la página</small>
				</div>
			</div>
			
			<div class="mb-3">
				<label class="form-label">Meta Descripción</label>
				<textarea name="seo_meta_description" class="form-control" rows="3" maxlength="300" placeholder="Descripción que aparece en resultados de Google..."><%= seo_meta_description %></textarea>
				<small class="text-muted">Recomendado: 150-160 caracteres. Actual: <span id="seo-desc-count"><%= seo_meta_description.length %></span> caracteres</small>
			</div>
			
			<div class="mb-3">
				<label class="form-label">Palabras clave (Keywords)</label>
				<textarea name="seo_keywords" class="form-control" rows="2" placeholder="autos a escala, hot wheels, greenlight, coleccionables..."><%= seo_keywords %></textarea>
				<small class="text-muted">Separadas por comas. Incluye marcas y términos que buscan tus clientes: Hot Wheels, Greenlight, Majorette, Jada Toys, etc.</small>
			</div>
			
			<div class="d-flex justify-content-between align-items-center">
				<button class="btn btn-primary" name="save_seo" value="1"><i class="fa fa-save me-1"></i> Guardar configuración SEO</button>
				<small class="text-muted">Los cambios se reflejarán inmediatamente en el sitio</small>
			</div>
		<% end %>
	</div>
</div>

<div class="alert alert-info" role="alert">
	<strong>Documentation</strong>
	<ul class="mb-0">
		<li>
			Best Sellers (YTD/LY/All Time) cuentan solo órdenes <em>pagadas/confirmadas</em>:
			<code>Confirmed</code>, <code>Shipped</code>, <code>Delivered</code>. Se excluyen pendientes/canceladas.
		</li>
		<li>
			COGS significa <strong>Cost of Goods Sold</strong> (costo de lo vendido).
		</li>
			<li>
				Rentables (profit por producto) usa:
				<ul>
					<li>Ingresos: suma de <code>unit_final_price * quantity</code> de órdenes pagadas.</li>
					<li>COGS: costo de las unidades vendidas en el periodo (<code>unit_cost * quantity</code> de los SaleOrderItems), independiente de cuándo se compraron.</li>
					<li>Mermas: resta costo de inventario con estatus <code>marketing, damaged, lost, scrap</code> según <code>status_changed_at</code>.</li>
				</ul>
				Utilidad = Ingresos - COGS - Mermas.
			</li>
		<li>
			Inventario: el <em>Average Purchase Cost</em> y <em>Inventory Value (MXN)</em> se calculan con costos compuestos en MXN
			(<code>total_line_cost_in_mxn</code> o <code>unit_compose_cost_in_mxn</code>), sin usar moneda origen.
		</li>
	</ul>
	<small class="text-muted">Última actualización: ajustes a cálculos y documentación.</small>
	</div>

<div class="card mb-4">
		<div class="card-header d-flex align-items-center gap-2">
			<i class="fa fa-sync"></i>
			<span>Sincronización de estados de inventario</span>
		</div>
	<div class="card-body">
				<p class="mb-3">
						Re-evalúa y sincroniza los estados de inventario conforme a la lógica de PO/SO.
				</p>
		<%= button_to "Iniciar sincronización (temporal)", sync_inventory_statuses_admin_settings_path,
									method: :post,
									class: "btn btn-primary",
									data: { controller: 'confirm', action: 'click->confirm#ask', confirm_message: '¿Confirmas iniciar la sincronización temporal?' } %>
	</div>
</div>

<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-link"></i>
		<span>Backfill vínculos de SO Line en Inventario</span>
	</div>
	<div class="card-body">
		<p class="mb-3 small">
			Rellena <code>sale_order_item_id</code> en Inventories cuando falte, usando la mejor coincidencia por par (Sale Order, Producto).
			Útil si se perdió el enlace después de migraciones o ediciones.
		</p>
		<%= button_to "Restaurar vínculos de SO Line en Inventario", backfill_inventory_sale_order_item_id_admin_settings_path,
			method: :post,
			class: "btn btn-outline-primary",
			data: { controller: 'confirm', action: 'click->confirm#ask', confirm_message: "¿Ejecutar backfill de sale_order_item_id en inventario?" } %>
	</div>
</div>

<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-calculator"></i>
		<span>Backfill de totales en Sale Orders</span>
	</div>
	<div class="card-body">
		<p class="mb-3">
			Recalcula <code>total_tax</code> y <code>total_order_value</code> para órdenes con total nulo o en 0.
		</p>
		<%= button_to "Iniciar backfill de Sale Orders", backfill_sale_orders_totals_admin_settings_path,
									method: :post,
									class: "btn btn-outline-primary",
									data: { controller: 'confirm', action: 'click->confirm#ask', confirm_message: '¿Confirmas iniciar el backfill de Sale Orders?' } %>
	</div>
</div>

<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-search"></i>
		<span>Auditoría de SO Delivered con Adeudo</span>
	</div>
	<div class="card-body">
		<p class="mb-3">Analiza órdenes en estado Delivered que aún presentan adeudo (pagos incompletos) y opcionalmente crea los pagos faltantes.</p>
		<%= link_to "Abrir auditoría", delivered_orders_debt_audit_admin_settings_path, class: "btn btn-outline-danger" %>
	</div>
</div>

<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-percentage"></i>
		<span>Configuración de Impuestos</span>
	</div>
	<div class="card-body">
		<% tax_enabled = SiteSetting.get('tax_enabled', true) %>
		<% tax_rate_percent = SiteSetting.get('tax_rate_percent', 16) %>
		<p class="small text-muted">Controla si se calculan impuestos en el carrito/checkout y el porcentaje aplicado.</p>
		<%= form_with url: admin_settings_path, method: :post, data: { turbo: false }, class: 'row gy-2 gx-3 align-items-end' do %>
			<div class="col-md-4">
				<label class="form-label">Impuestos activados</label>
				<select name="tax_enabled" class="form-select form-select-sm">
					<option value="true" <%= 'selected' if tax_enabled.to_s == 'true' %>>Sí</option>
					<option value="false" <%= 'selected' if tax_enabled.to_s == 'false' %>>No</option>
				</select>
			</div>
			<div class="col-md-4">
				<label class="form-label">Porcentaje (%)</label>
				<input type="number" step="0.01" name="tax_rate_percent" class="form-control form-control-sm" value="<%= tax_rate_percent %>">
			</div>
			<div class="col-md-4">
				<button class="btn btn-primary btn-sm" name="save_tax" value="1">Guardar</button>
			</div>
		<% end %>
	</div>
</div>

<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-globe"></i>
		<span>Interfaz (Idioma / Tema)</span>
	</div>
	<div class="card-body">
		<% lang_enabled = SiteSetting.get('language_switcher_enabled', false) %>
		<% dark_enabled = SiteSetting.get('dark_mode_enabled', false) %>
		<p class="small text-muted">Activa o desactiva componentes UI opcionales en la navegación pública.</p>
		<%= form_with url: admin_settings_path, method: :post, data: { turbo: false }, class: 'row gy-2 gx-3 align-items-end' do %>
			<div class="col-md-4">
				<label class="form-label">Selector de idioma</label>
				<select name="language_switcher_enabled" class="form-select form-select-sm">
					<option value="true" <%= 'selected' if lang_enabled.to_s == 'true' %>>Mostrar</option>
					<option value="false" <%= 'selected' if lang_enabled.to_s == 'false' %>>Ocultar</option>
				</select>
			</div>
			<div class="col-md-4">
				<label class="form-label">Botón Dark Mode</label>
				<select name="dark_mode_enabled" class="form-select form-select-sm">
					<option value="true" <%= 'selected' if dark_enabled.to_s == 'true' %>>Activado</option>
					<option value="false" <%= 'selected' if dark_enabled.to_s == 'false' %>>Desactivado</option>
				</select>
			</div>
			<div class="col-md-4">
				<button class="btn btn-primary btn-sm" name="save_ui" value="1">Guardar</button>
			</div>
		<% end %>
	</div>
</div>

<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-clock"></i>
		<span>Tiempos estimados (Preorden / Sobre pedido)</span>
	</div>
	<div class="card-body">
		<% preorder_days = SiteSetting.get('preorder_eta_days', 60).to_i %>
		<% backorder_days = SiteSetting.get('backorder_eta_days', 60).to_i %>
		<p class="small text-muted">Estos días se usan en tooltips y badges como estimado tras la confirmación manual. Si un producto no tiene fecha de lanzamiento conocida se asumirá 90 días (preorden).</p>
		<%= form_with url: admin_settings_path, method: :post, data: { turbo: false }, class: 'row gy-2 gx-3 align-items-end' do %>
			<div class="col-md-5">
				<label class="form-label">Preorden ETA (días)</label>
				<input type="number" min="1" name="preorder_eta_days" class="form-control form-control-sm" value="<%= preorder_days %>">
			</div>
			<div class="col-md-5">
				<label class="form-label">Sobre pedido ETA (días)</label>
				<input type="number" min="1" name="backorder_eta_days" class="form-control form-control-sm" value="<%= backorder_days %>">
			</div>
			<div class="col-md-2">
				<button class="btn btn-primary btn-sm w-100" name="save_eta" value="1">Guardar</button>
			</div>
		<% end %>
	</div>
</div>

<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-ruler-combined"></i>
		<span>Reset Dimensiones/Peso de Productos</span>
	</div>
	<div class="card-body">
		<p class="mb-3 small">
			Actualiza TODAS las dimensiones y peso de productos a los valores por defecto <code>50g / 8x4x4 cm</code> y recalcula los costos proporcionales de TODOS los Purchase Orders.
			<br>
			<strong>Advertencia:</strong> Operación intensiva (lee y recalcula cada PO). Úsala solo si requieres un reseteo global.
		</p>
		<%= button_to "Iniciar reset de dimensiones y recálculo", reset_product_dimensions_admin_settings_path,
			method: :post,
			class: "btn btn-outline-warning",
			data: { controller: 'confirm', action: 'click->confirm#ask', confirm_message: "¿Confirmas el reset global de dimensiones/peso y recálculo de costos?" } %>
	</div>
</div>

<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-cubes"></i>
		<span>Recalcular Alpha / Compose Costs (PO)</span>
	</div>
	<div class="card-body">
		<p class="mb-3 small">
			Redistribuye costos adicionales (shipping/tax/other) y recalcula <em>unit_additional_cost</em>, unit compose y totales para <strong>todas</strong> las Purchase Orders.
			Úsalo si cambiaste dimensiones globalmente después de haber creado POs y los valores no se actualizaron.
		</p>
		<%= button_to "Recalcular alpha/compose costs (todas las POs)", recalc_all_po_alpha_costs_admin_settings_path,
			method: :post,
			class: "btn btn-outline-danger",
			data: { controller: 'confirm', action: 'click->confirm#ask', confirm_message: "¿Confirmas recalcular alpha/compose costs de TODAS las Purchase Orders?" } %>
	</div>
</div>

<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-tags"></i>
		<span>Marcar POs con Costos Distribuidos</span>
	</div>
	<div class="card-body">
		<p class="mb-3 small">
			Detecta Purchase Orders que ya tienen costos distribuidos (líneas con <code>total_line_cost</code> y suma coincide con totales) y marca el timestamp <code>costs_distributed_at</code>.
			Esto evita doble suma de shipping/tax/other al reabrir POs antiguas.
			<br>
			<strong>Recomendación:</strong> Ejecuta primero un <strong>Dry Run</strong> para ver cuántas POs serían marcadas.
		</p>
		<%= form_with url: mark_distributed_costs_admin_settings_path, method: :post, local: true, class: 'row gy-2 gx-3 align-items-end' do %>
			<div class="col-md-3">
				<label class="form-label small">Modo</label>
				<select name="dry_run" class="form-select form-select-sm">
					<option value="true">Dry Run (solo reporte)</option>
					<option value="false">Aplicar cambios</option>
				</select>
			</div>
			<div class="col-md-3">
				<label class="form-label small">Tolerancia ($)</label>
				<input type="number" step="0.01" name="tolerance" class="form-control form-control-sm" value="0.01" placeholder="0.01">
			</div>
			<div class="col-md-6">
				<button type="submit" class="btn btn-outline-warning btn-sm"
					data-controller="confirm"
					data-action="click->confirm#ask"
					data-confirm-message="¿Confirmas ejecutar la detección de costos distribuidos?">
					Ejecutar
				</button>
			</div>
		<% end %>
	</div>
</div>

<div class="card mb-4">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-warehouse"></i>
		<span>Auditoría de Inventario (PO ↔ Inventory)</span>
	</div>
	<div class="card-body">
		<p class="mb-3 small">
			Accede al panel de auditoría para ejecutar reconciliaciones entre piezas de inventario y líneas de Purchase Orders.
			Primero realiza un <strong>Dry Run</strong> antes de aplicar cambios.
		</p>
		<% if @last_reconciliation_event %>
			<p class="mb-2 small text-muted">
				Última actividad: <strong><%= @last_reconciliation_event.created_at.strftime('%Y-%m-%d %H:%M:%S') %></strong>
				(<%= @last_reconciliation_event.event_type %>)
			</p>
		<% end %>
		<p class="mb-2 small text-muted">Últimas 24h: eliminados <strong><%= @recon_24_orphans || 0 %></strong>, creados <strong><%= @recon_24_created || 0 %></strong>.</p>
		<div class="d-flex flex-wrap gap-2">
			<%= link_to 'Abrir Inventory Audit', admin_inventory_audit_path, class: 'btn btn-outline-secondary btn-sm' %>
			<%= link_to 'Ver Inventory Events', admin_inventory_events_path, class: 'btn btn-outline-primary btn-sm' %>
		</div>
	</div>
</div>


<div class="card">
	<div class="card-header d-flex align-items-center gap-2">
		<i class="fa fa-list"></i>
		<span>Ejecuciones recientes (todas)</span>
	</div>
	<div class="card-body p-0">
		<div class="table-responsive">
			<table class="table table-sm mb-0 align-middle">
				<thead>
					<tr>
						<th>ID</th>
						<th>Job</th>
						<th>Estado</th>
						<th>Inicio</th>
						<th>Fin</th>
						<th>Duración</th>
						<th>Stats</th>
						<th>Error</th>
					</tr>
				</thead>
				<tbody>
					<% if @runs.present? %>
						<% @runs.each do |r| %>
							<tr>
								<td>#<%= r.id %></td>
								<td><code><%= r.job_name %></code></td>
								<td>
									<% badge_class = case r.status.to_s
													 when 'queued' then 'bg-secondary'
													 when 'running' then 'bg-info'
													 when 'completed' then 'bg-success'
													 when 'failed' then 'bg-danger'
													 else 'bg-light text-dark border'
													 end %>
								<span class="badge <%= badge_class %>"><%= r.status %></span>
								</td>
								<td><%= r.started_at&.strftime('%Y-%m-%d %H:%M:%S') || '-' %></td>
								<td><%= r.finished_at&.strftime('%Y-%m-%d %H:%M:%S') || '-' %></td>
								<td><%= r.duration_seconds ? "#{r.duration_seconds}s" : '-' %></td>
								<td class="text-break" style="max-width: 320px;">
									<% if r.stats.present? %>
										<pre class="mb-0 small"><%= JSON.pretty_generate(r.stats) %></pre>
									<% else %>
										-
									<% end %>
								</td>
								<td class="text-break" style="max-width: 280px;">
									<%= r.error.presence || '-' %>
								</td>
							</tr>
						<% end %>
					<% else %>
						<tr>
							<td colspan="8" class="text-center text-muted">Sin ejecuciones registradas.</td>
						</tr>
					<% end %>
				</tbody>
			</table>
		</div>
	</div>
	<%# Paginación global %>
	<% if @runs.respond_to?(:current_page) %>
		<div class="card-footer py-2">
			<%= paginate @runs %>
		</div>
	<% end %>
</div>