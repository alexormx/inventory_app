<% if shipment.errors.any? %>
  <div class="alert alert-danger">
    <ul>
      <% shipment.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<%= turbo_frame_tag "shipment_modal" do %>
  <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog">
      <div class="modal-content">
  <%= form_with model: [:admin, sale_order, shipment], 
          data: { turbo_frame: "shipment_modal", controller: "shipment-guard", 
            shipment_guard_paid_value: (sale_order.total_paid.to_d >= sale_order.total_order_value.to_d).to_s,
            shipment_guard_credit_value: ((sale_order.user&.respond_to?(:credit_enabled) && sale_order.user.credit_enabled) || sale_order.credit_override).to_s },
          local: false do |f| %>
          <div class="modal-header position-relative">
            <h5 class="modal-title"><%= shipment.persisted? ? "Edit Shipment" : "Add Shipment" %></h5>
            <div class="modal-close-container">
              <button type="button" class="custom-close" id="closeShipmentModal" aria-label="Close" title="Cerrar" role="button" onclick="document.getElementById('shipment_modal').innerHTML = ''">&times;</button>
            </div>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <%= f.label :tracking_number %>
              <%= f.text_field :tracking_number, class: "form-control", required: true %>
            </div>
            <div class="mb-3">
              <%= f.label :carrier %>
              <%= f.text_field :carrier, class: "form-control", required: true %>
            </div>
            <div class="mb-3">
              <%= f.label :status %>
              <%= f.select :status, Shipment.statuses.keys.map { |s| [s.humanize, s] }, {}, class: "form-select", data: { action: "change->shipment-guard#onStatusChange" } %>
              <div class="form-text text-danger d-none" data-shipment-guard-target="warning">No puedes marcar "Shipped" o "Delivered" sin pago completo o sin crédito habilitado.</div>
            </div>
            <div class="mb-3">
              <%= f.label :estimated_delivery %>
              <%= f.date_field :estimated_delivery, class: "form-control", required: true %>
            </div>
            <div class="mb-3">
              <%= f.label :actual_delivery %>
              <%= f.date_field :actual_delivery, class: "form-control" %>
            </div>
            <div class="mb-3">
              <%= f.label :shipping_cost, "Shipping Cost (MXN)" %>
              <%= f.number_field :shipping_cost, class: "form-control", step: 0.01, min: 0, placeholder: "0.00" %>
              <small class="text-muted">Se sumará al total de la orden.</small>
            </div>
          </div>
          <div class="modal-footer">
            <%= f.submit shipment.persisted? ? "Update" : "Create", class: "btn btn-primary" %>
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('shipment_modal').innerHTML = ''">Cancel</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
