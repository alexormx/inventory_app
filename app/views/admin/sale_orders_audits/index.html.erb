<div class="container mt-4">
  <h2>Auditoría de Sales Orders</h2>
  <p class="text-muted">
    Verifica que cada línea esté cubierta por inventario asignado (reserved/sold/pre_reserved/pre_sold) o por cantidades en preventa/sobre pedido.
  </p>

  <div class="alert alert-info d-flex justify-content-between align-items-center">
    <div>
      <strong>Resumen:</strong>
      Líneas totales: <%= @summary[:total_lines] %> ·
      Con faltantes: <span class="text-danger"><%= @summary[:lines_with_gap] %></span> ·
      Unidades faltantes: <span class="text-danger"><%= @summary[:missing_units] %></span>
    </div>
    <div class="d-inline-flex gap-2">
      <%= link_to 'Simular corrección (dry run)',
                  admin_sale_orders_audit_fix_path(dry_run: true),
                  data: { turbo_method: :post },
                  class: 'btn btn-sm btn-outline-primary' %>
      <%= link_to 'Corregir faltantes',
                  admin_sale_orders_audit_fix_path,
                  data: { turbo_method: :post, controller: 'confirm', confirm_message: '¿Asignar inventario disponible y crear preventas para el resto?' },
                  class: 'btn btn-sm btn-danger' %>
    </div>
  </div>

  <div class="card">
    <div class="card-header">Líneas con faltantes</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>SO</th>
              <th>Producto</th>
              <th class="text-end">Qty</th>
              <th class="text-end">Asignado (inv)</th>
              <th class="text-end">Preventa</th>
              <th class="text-end">Backorder</th>
              <th class="text-end">Faltante</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @lines_with_gap.each do |li| %>
              <% assigned = li.attributes['assigned_inv_count'].to_i %>
              <% preorder = li.preorder_quantity.to_i %>
              <% backord = li.backordered_quantity.to_i %>
              <% missing = [li.quantity.to_i - (assigned + preorder + backord), 0].max %>
              <tr>
                <td><%= link_to li.sale_order_id, admin_sale_order_path(li.sale_order_id) %></td>
                <td><%= li.product&.product_name %> (<code><%= li.product&.product_sku %></code>)</td>
                <td class="text-end"><%= li.quantity %></td>
                <td class="text-end"><%= assigned %></td>
                <td class="text-end"><%= preorder %></td>
                <td class="text-end"><%= backord %></td>
                <td class="text-end <%= missing > 0 ? 'text-danger' : '' %>"><strong><%= missing %></strong></td>
                <td class="text-end">
                  <%= link_to 'Ver SO', admin_sale_order_path(li.sale_order_id), class: 'btn btn-sm btn-outline-secondary' %>
                </td>
              </tr>
            <% end %>
            <% if @lines_with_gap.blank? %>
              <tr><td colspan="8" class="text-center text-muted">Todas las líneas están cubiertas por inventario o preventa.</td></tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
