<%= form_with model: [:admin, @inventory_adjustment], local: true do |f| %>
  <% if @inventory_adjustment.errors.any? %>
    <div class="alert alert-danger">
      <strong>No se pudo guardar:</strong>
      <ul class="mb-0">
        <% @inventory_adjustment.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <div class="row g-3">
    <div class="col-md-3">
      <%= f.label :adjustment_type %>
      <%= f.select :adjustment_type, InventoryAdjustment.adjustment_types.keys, {}, class: 'form-select' %>
    </div>
    <div class="col-md-3">
      <%= f.label :found_at %>
      <%= f.datetime_field :found_at, class: 'form-control' %>
    </div>
    <div class="col-md-6">
      <%= f.label :note %>
      <%= f.text_field :note, class: 'form-control' %>
    </div>
  </div>

  <hr>
  <h5>Lines</h5>
  <div class="mb-3">
    <label class="form-label">Add product</label>
    <input type="text" id="inventory-adjustment-product-search" class="form-control" placeholder="Type at least 3 letters..." autocomplete="off" />
    <div id="inventory-adjustment-product-results" class="list-group mt-1"></div>
    <small class="text-muted">Search by name or SKU. Click to add line.</small>
  </div>

  <div class="table-responsive">
    <table class="table table-sm align-middle" id="inventory-adjustment-lines-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Direction</th>
          <th>Qty</th>
          <th>Condition</th>
          <th>Reason</th>
          <th>Unit cost</th>
          <th>Sell price</th>
          <th>Note</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="inventory-adjustment-lines-body">
        <% if @inventory_adjustment.inventory_adjustment_lines.empty? %>
          <tr class="text-muted" id="no-lines-placeholder">
            <td colspan="9"><em>No lines yet. Use the search box above to add products.</em></td>
          </tr>
        <% end %>
        <%= f.fields_for :inventory_adjustment_lines do |lf| %>
          <tr class="line-row" data-product-id="<%= lf.object.product_id %>">
            <td>
              <% if lf.object.persisted? %>
                <%= lf.hidden_field :product_id, class: 'product-id-input' %>
                <span class="small text-muted"><%= lf.object.product&.product_name %></span><br>
                <small class="text-muted"><%= lf.object.product&.product_sku %></small>
              <% else %>
                <%= lf.collection_select :product_id, Product.order(:product_name).limit(100), :id, :product_name, {}, class: 'form-select product-id-input' %>
              <% end %>
            </td>
            <td><%= lf.select :direction, [['Increase','increase'],['Decrease','decrease']], {}, class: 'form-select direction-select' %></td>
            <td style="width:80px"><%= lf.number_field :quantity, min: 1, class: 'form-control quantity-input' %></td>
            <td style="width:150px">
              <%= lf.select :item_condition,
                  Inventory::CONDITION_LABELS.map { |k, v| [v, k] },
                  {},
                  class: "form-select condition-select #{'d-none' if lf.object.direction == 'decrease'}" %>
            </td>
            <td>
              <%= lf.select :reason, options_for_select(InventoryAdjustmentLine::ALLOWED_DECREASE_REASONS.map { |r| [r.titleize, r] }, lf.object.reason), { include_blank: 'Select' }, class: "form-select reason-select #{'d-none' unless lf.object.direction == 'decrease'}" %>
            </td>
            <td style="width:100px"><%= lf.number_field :unit_cost, step: '0.01', class: "form-control unit-cost-input #{'d-none' if lf.object.direction == 'decrease'}" %></td>
            <td style="width:100px"><%= lf.number_field :selling_price, step: '0.01', class: "form-control selling-price-input #{'d-none' if lf.object.direction == 'decrease'}", placeholder: 'Optional' %></td>
            <td><%= lf.text_field :note, class: 'form-control note-input', style: 'min-width:100px' %></td>
            <td>
              <% if lf.object&.persisted? %>
                <label class="small">Remove <%= lf.check_box :_destroy, class: 'form-check-input ms-1 item-destroy-flag' %></label>
              <% else %>
                <button type="button" class="btn btn-sm btn-outline-danger remove-line">&times;</button>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="mt-3 d-flex gap-2">
    <%= f.submit class: 'btn btn-primary' %>
    <%= link_to 'Back', admin_inventory_adjustments_path, class: 'btn btn-outline-secondary' %>
  </div>
<% end %>
