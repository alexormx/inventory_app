<h1 class="h4 mb-3">Auditoría de Inventario</h1>

<div class="mb-3">
  <% Inventory.statuses.each do |name, val| %>
    <span class="badge text-bg-secondary me-1"><%= name %>: <%= @status_counts[name] || 0 %></span>
  <% end %>
</div>

<div class="d-flex gap-2 mb-3">
  <%= link_to 'Corregir inconsistencias',
              admin_inventory_audit_fix_path,
              data: { turbo_method: :post, controller: 'confirm', confirm_message: '¿Corregir estatus de inventario con SO ligada? available→reserved/sold, in_transit→pre_reserved/pre_sold.' },
              class: 'btn btn-sm btn-danger' %>
  <%= link_to 'Simular corrección (dry run)',
              admin_inventory_audit_fix_path(dry_run: true),
              data: { turbo_method: :post },
              class: 'btn btn-sm btn-outline-secondary' %>
  <%= link_to 'Volver', admin_dashboard_path, class: 'btn btn-sm btn-outline-secondary' %>
  <div class="ms-auto"></div>
</div>

<div class="card">
  <div class="card-header">Inconsistencias: Inventario ligado a SO con estado asignable</div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Producto</th>
            <th>SO</th>
            <th>Status actual</th>
            <th>Status sugerido</th>
          </tr>
        </thead>
        <tbody>
          <% @inconsistencies.each do |inv| %>
            <% so = SaleOrder.find_by(id: inv.sale_order_id) %>
            <% suggested = if inv.status == 'available'
                             so&.status == 'Confirmed' ? 'sold' : 'reserved'
                           elsif inv.status == 'in_transit'
                             so&.status == 'Confirmed' ? 'pre_sold' : 'pre_reserved'
                           end %>
            <tr>
              <td><%= inv.id %></td>
              <td><%= inv.product&.product_name %> (<code><%= inv.product_id %></code>)</td>
              <td><%= link_to so&.id, admin_sale_order_path(so) if so %></td>
              <td><span class="badge text-bg-warning"><%= inv.status %></span></td>
              <td><span class="badge text-bg-info"><%= suggested || '—' %></span></td>
            </tr>
          <% end %>
          <% if @inconsistencies.blank? %>
            <tr><td colspan="5" class="text-center text-muted">Sin inconsistencias</td></tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer small text-muted">Reglas: con SO ligada no debe estar en available/in_transit.</div>
  </div>
