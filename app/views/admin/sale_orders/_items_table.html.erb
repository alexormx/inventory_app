<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
    <h6 class="mb-0"><i class="fa fa-boxes text-muted me-2"></i>Productos (<%= sale_order.sale_order_items.count %>)</h6>
    <span class="badge bg-light text-dark border">
      <i class="fa fa-weight me-1"></i><%= number_with_precision(sale_order.total_weight_gr/1000.0, precision: 2) %> kg |
      <i class="fa fa-cube me-1"></i><%= number_with_precision(sale_order.total_volume_cm3, precision: 0) %> cm³
    </span>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 50px;"></th>
            <th>Producto</th>
            <th class="text-center">Cantidad</th>
            <th class="text-end">Precio Unit.</th>
            <th class="text-end">Descuento</th>
            <th class="text-end">Precio Final</th>
            <th class="text-end">Total Línea</th>
            <th class="text-center" style="min-width: 200px;">Inventario</th>
          </tr>
        </thead>
        <tbody>
          <% sale_order.sale_order_items.includes(product: { product_images_attachments: :blob }).each do |item| %>
            <tr>
              <%# Thumbnail %>
              <td class="text-center">
                <% if item.product&.product_images&.attached? %>
                  <%= link_to admin_product_path(item.product), title: "Ver producto" do %>
                    <%= image_tag item.product.product_images.first.variant(resize_to_fill: [40, 40]), class: "rounded border", style: "width: 40px; height: 40px; object-fit: cover;" %>
                  <% end %>
                <% else %>
                  <div class="rounded bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="fa fa-image text-muted"></i>
                  </div>
                <% end %>
              </td>

              <%# Producto %>
              <td>
                <div class="fw-medium">
                  <% if item.product %>
                    <%= link_to item.product.product_name, admin_product_path(item.product), class: "text-decoration-none" %>
                  <% else %>
                    <span class="text-muted">—</span>
                  <% end %>
                </div>
                <div class="small text-muted">
                  <span class="me-2"><i class="fa fa-barcode me-1"></i><%= item.product&.product_sku || '—' %></span>
                </div>
              </td>

              <%# Cantidad %>
              <td class="text-center">
                <span class="badge bg-light text-dark border fs-6"><%= item.quantity %></span>
              </td>

              <%# Precio unitario %>
              <td class="text-end">
                <%= number_to_currency(item.unit_cost, unit: '$', precision: 2) %>
              </td>

              <%# Descuento %>
              <td class="text-end">
                <% if item.unit_discount.to_f > 0 %>
                  <span class="text-danger">-<%= number_to_currency(item.unit_discount, unit: '$', precision: 2) %></span>
                <% else %>
                  <span class="text-muted">—</span>
                <% end %>
              </td>

              <%# Precio final %>
              <td class="text-end fw-medium">
                <%= number_to_currency(item.unit_final_price, unit: '$', precision: 2) %>
              </td>

              <%# Total línea %>
              <td class="text-end fw-bold text-success">
                <%= number_to_currency(item.total_line_cost, unit: '$', precision: 2) %>
              </td>

              <%# Inventario %>
              <td>
                <% invs = item.inventory_units.limit(50) %>
                <% if invs.any? %>
                  <div class="d-flex flex-wrap gap-1 justify-content-center" style="max-width: 200px; margin: 0 auto;">
                    <% invs.each do |inv| %>
                      <% badge_class = case inv.status.to_s
                        when 'available' then 'bg-secondary'
                        when 'reserved' then 'bg-warning text-dark'
                        when 'in_transit' then 'bg-info'
                        when 'sold' then 'bg-success'
                        when 'damaged' then 'bg-danger'
                        when 'lost' then 'bg-dark'
                        when 'returned' then 'bg-primary'
                        when 'scrap' then 'bg-danger-subtle text-danger'
                        when 'pre_reserved' then 'bg-warning-subtle text-warning-emphasis'
                        when 'pre_sold' then 'bg-success-subtle text-success-emphasis'
                        when 'marketing' then 'bg-info-subtle text-info-emphasis'
                        else 'bg-light text-dark border'
                      end %>
                      <span class="badge <%= badge_class %>" title="ID: <%= inv.id %> - <%= inv.status.humanize %>">
                        <%= inv.status.to_s.first(3).upcase %>
                      </span>
                    <% end %>
                  </div>
                  <div class="small text-center mt-1">
                    <span class="text-muted"><%= invs.size %>/<%= item.quantity %></span>
                    <% if item.missing_inventory_units > 0 %>
                      <span class="text-danger ms-1">
                        <i class="fa fa-exclamation-triangle"></i> Faltan <%= item.missing_inventory_units %>
                      </span>
                    <% end %>
                  </div>
                <% else %>
                  <div class="text-center">
                    <span class="badge bg-light text-muted border">0/<%= item.quantity %></span>
                    <div class="small text-danger mt-1">
                      <i class="fa fa-exclamation-triangle"></i> Sin asignar
                    </div>
                  </div>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
        <tfoot class="table-light">
          <tr class="fw-bold">
            <td colspan="2">Totales</td>
            <td class="text-center"><%= sale_order.sale_order_items.sum(:quantity) %></td>
            <td colspan="3"></td>
            <td class="text-end text-success"><%= number_to_currency(sale_order.subtotal, unit: '$', precision: 2) %></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>
