<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title d-flex justify-content-between align-items-center">
      <span>Sale Order Items</span>
      <small class="text-muted">Vol: <%= number_with_precision(sale_order.total_volume_cm3, precision: 2) %> cm³ | Peso: <%= number_with_precision(sale_order.total_weight_gr/1000.0, precision: 3) %> kg</small>
    </h5>
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>Product</th>
            <th>Qty</th>
            <th>Unit Cost</th>
            <th>Discount</th>
            <th>Final Price</th>
            <th>Volume</th>
            <th>Weight</th>
            <th>Total Line Cost</th>
            <th class="text-center">Inventory Status (per unit)</th>
          </tr>
        </thead>
        <tbody>
          <% sale_order.sale_order_items.each do |item| %>
            <tr>
              <td><%= item.product&.product_name || "—" %></td>
              <td><%= item.quantity %></td>
              <td><%= number_with_precision(item.unit_cost, precision: 2) %></td>
              <td><%= number_with_precision(item.unit_discount, precision: 2) %></td>
              <td><%= number_with_precision(item.unit_final_price, precision: 2) %></td>
              <td><%= number_with_precision(item.volume_cm3, precision: 2) %></td>
              <td><%= number_with_precision(item.weight_gr, precision: 2) %></td>
              <td><%= number_with_precision(item.total_line_cost, precision: 2) %></td>
              <td>
                <% invs = item.inventory_units.limit(50) %>
                <% if invs.any? %>
                  <div class="d-flex flex-wrap gap-1" style="max-width:280px">
                    <% invs.each do |inv| %>
                      <% badge_class = case inv.status.to_s
                        when 'available' then 'bg-secondary'
                        when 'reserved' then 'bg-warning text-dark'
                        when 'in_transit' then 'bg-info'
                        when 'sold' then 'bg-success'
                        when 'damaged' then 'bg-danger'
                        when 'lost' then 'bg-dark'
                        when 'returned' then 'bg-primary'
                        when 'scrap' then 'bg-danger-subtle text-danger'
                        when 'pre_reserved' then 'bg-warning-subtle text-warning-emphasis'
                        when 'pre_sold' then 'bg-success-subtle text-success-emphasis'
                        when 'marketing' then 'bg-info-subtle text-info-emphasis'
                        else 'bg-light text-dark border'
                      end %>
                      <span class="badge <%= badge_class %>" title="Inventory ID: <%= inv.id %>"><%= inv.status.first(3) %></span>
                    <% end %>
                  </div>
                  <small class="text-muted d-block mt-1">Asignados: <%= invs.size %> / <%= item.quantity %> <% if item.missing_inventory_units > 0 %> | Faltan: <span class="text-danger"><%= item.missing_inventory_units %></span><% end %></small>
                <% else %>
                  <span class="text-muted small">0 / <%= item.quantity %> asignados</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
