<!-- app/views/admin/sale_orders/show.html.erb -->
<div class="container mt-4">
  <%= turbo_stream_from ["sale_order", @sale_order.id] %>
  <h2 class="d-flex align-items-center gap-2">Sale Order ##<%= @sale_order.id %>
    <span class="ms-auto d-flex gap-2">
      <%= link_to 'Vista compacta', summary_admin_sale_order_path(@sale_order), class: 'btn btn-sm btn-outline-primary' %>
      <% unless @sale_order.status == "Canceled" %>
        <%= button_to 'Cancel Order',
                      cancel_admin_sale_order_path(@sale_order),
                      method: :post,
                      class: 'btn btn-sm btn-outline-danger',
                      data: {
                        controller: 'confirm',
                        action: 'click->confirm#ask',
                        confirm_message: '쮼st치s seguro? Esta acci칩n liberar치 todos los inventarios reservados/vendidos y marcar치 la orden como cancelada.'
                      } %>
      <% end %>
    </span>
  </h2>

  <!-- Order Info -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <strong>Customer:</strong>
      <p><%= @sale_order.user&.name || "N/A" %></p>
    </div>
    <div class="col-md-3">
      <strong>Status:</strong>
      <turbo-frame id="sale_order_status">
        <%= render "admin/sale_orders/status_badge", sale_order: @sale_order %>
      </turbo-frame>
    </div>
    <div class="col-md-3">
      <strong>Order Date:</strong>
      <p><%= @sale_order.order_date %></p>
    </div>
  </div>

  <!-- Financial Summary -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <strong>Subtotal:</strong>
      <p>$<%= number_with_precision(@sale_order.subtotal, precision: 2) %></p>
    </div>
    <div class="col-md-3">
      <strong>Tax Rate:</strong>
      <p><%= @sale_order.tax_rate.to_i %>%</p>
    </div>
    <div class="col-md-3">
      <strong>Tax Total:</strong>
      <p>$<%= number_with_precision(@sale_order.total_tax, precision: 2) %></p>
    </div>
    <div class="col-md-3">
      <strong>Shipping Cost:</strong>
      <p>$<%= number_with_precision(@sale_order.shipping_cost || 0, precision: 2) %></p>
    </div>
    <div class="col-md-3">
      <strong>Total Order Value:</strong>
      <p>$<%= number_with_precision(@sale_order.total_order_value, precision: 2) %></p>
    </div>
    <div class="col-md-3">
      <strong>Total Volume (cm췁):</strong>
      <p><%= number_with_precision(@sale_order.total_volume_cm3, precision: 2) %></p>
    </div>
    <div class="col-md-3">
      <strong>Total Weight (kg):</strong>
      <p><%= number_with_precision(@sale_order.total_weight_gr / 1000.0, precision: 3) %></p>
    </div>
  </div>
  <%# Credit info %>
  <% credit_allowed = (@sale_order.user&.respond_to?(:credit_enabled) && @sale_order.user.credit_enabled) || @sale_order.credit_override %>
  <% credit_terms = (@sale_order.credit_terms || @sale_order.user&.default_credit_terms).to_s %>
  <% if credit_allowed && credit_terms != 'none' %>
    <div class="alert alert-warning d-flex justify-content-between align-items-center py-2">
      <div>
        <strong>On Credit:</strong>
        <span class="badge bg-warning text-dark"><%= credit_terms.titleize %></span>
        <% if @sale_order.due_date.present? %>
          <span class="ms-2">Due: <%= @sale_order.due_date %></span>
        <% end %>
      </div>
      <% if @sale_order.due_date.present? && (@sale_order.total_order_value.to_d - @sale_order.total_paid.to_d) > 0 && Date.today > @sale_order.due_date %>
        <span class="text-danger fw-bold">Overdue</span>
      <% end %>
    </div>
  <% end %>
  <turbo-frame id="payment_balance">
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <strong>Total Paid:</strong>
        <p>$<%= number_with_precision(@sale_order.total_paid, precision: 2) %></p>
      </div>

      <div class="col-md-3">
        <strong>Balance Due:</strong>
        <p class="<%= @sale_order.fully_paid? ? 'text-success' : 'text-danger' %>">
          $<%= number_with_precision(@sale_order.total_order_value - @sale_order.total_paid, precision: 2) %>
        </p>
      </div>
    </div>
  </turbo-frame>

  <!-- Items Table -->
  <turbo-frame id="sale_order_items">
    <%= render 'admin/sale_orders/items_table', sale_order: @sale_order %>
  </turbo-frame>

  <!-- Add Payment Button -->
  <%= link_to "Add Payment",
      new_admin_sale_order_payment_path(@sale_order),
      data: { turbo_frame: "modal_frame" },
      class: "btn btn-outline-primary mb-3" %>

  <!-- Payment Modal -->
  <turbo-frame id="modal_frame"></turbo-frame>

  <turbo-frame id="payments_table">
    <%= render "admin/payments/payment_table", payments: @sale_order.payments %>
  </turbo-frame>

  <!-- 游닍 Shipment Section -->
  <turbo-frame id="shipment_modal"></turbo-frame>

  <turbo-frame id="shipment_info">
    <% if @sale_order.shipment.present? %>
      <%= render "admin/shipments/info", sale_order: @sale_order %>
    <% else %>
      <p class="text-muted">No shipment assigned.</p>
    <% end %>
  </turbo-frame>

  <turbo-frame id="shipment_button">
    <%= render "admin/shipments/button", sale_order: @sale_order %>
  </turbo-frame>

  <!-- Notes -->
  <% if @sale_order.notes.present? %>
    <div class="card mb-3">
      <div class="card-body">
        <strong>游닇 Notes:</strong>
        <% @sale_order.notes.to_s.split("\n").each do |line| %>
          <p class="mb-1 text-danger"><%= line %></p>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Metadata -->
  <div class="text-muted small">
    Created at: <%= @sale_order.created_at.strftime("%F %T") %> |
    Updated at: <%= @sale_order.updated_at.strftime("%F %T") %>
  </div>
</div>
