<h2 class="mb-3 d-flex align-items-center gap-2"><i class="fa fa-shopping-cart"></i> Sales Orders
  <span class="ms-auto d-inline-flex gap-2">
    <%= link_to "Export CSV", admin_sale_orders_path(request.query_parameters.merge(format: :csv)), class: "btn btn-sm btn-outline-secondary" %>
  </span>
</h2>

<%= render partial: "admin/shared/status_counters", locals: {
  counts: @counts_global,
  items: [
    ["Pending",   "Pending",   "bg-warning text-dark"],
    ["Confirmed", "Confirmed", "bg-info"],
    ["Shipped",   "Shipped",   "bg-primary"],
    ["Delivered", "Delivered", "bg-success"],
    ["Canceled",  "Canceled",  "bg-danger"],
  ],
  title: "Resumen",
  cta_label: "New Sale Order",
  cta_path: new_admin_sale_order_path
} %>

<%# Barra de búsqueda + filtros por estatus (estilo Inventario) %>
<div class="card mb-4">
  <div class="card-body py-2">
    <%= form_with url: admin_sale_orders_path, method: :get, local: true, class: "row g-2 align-items-center" do %>
      <%= hidden_field_tag :sort, params[:sort] %>
      <%= hidden_field_tag :dir, params[:dir] %>
      <div class="col-12 col-md-6">
        <div class="input-group input-group-sm">
          <%= text_field_tag :q, @q, class: "form-control", placeholder: "Buscar por ID o cliente…", aria: { label: "Buscar sale orders" } %>
          <button class="btn btn-outline-secondary btn-clear-search" type="button" title="Limpiar búsqueda">Limpiar</button>
          <button class="btn btn-primary" type="submit" name="commit" value="search" title="Buscar">Buscar</button>
        </div>
      </div>
  <div class="col-12 col-md-6 text-md-end">
        <% current_status = @status_filter.presence || "all" %>
        <% outline_for = ->(s) do
             case s
             when "Pending" then "warning text-dark"
             when "Confirmed" then "info"
             when "Shipped" then "primary"
             when "Delivered" then "success"
             when "Canceled" then "danger"
             else "secondary"
             end
           end %>
        <% btnc = ->(s, cur) { ["btn", "btn-outline-#{outline_for.call(s)}", (cur == s ? "active" : nil)].compact.join(" ") } %>
        <div class="btn-group btn-group-sm me-2" role="group" aria-label="Filtro de status">
          <%= button_tag "Todos", name: :status, value: "all", class: btnc.call("all", current_status) %>
          <%= button_tag "Pending", name: :status, value: "Pending", class: btnc.call("Pending", current_status) %>
          <%= button_tag "Confirmed", name: :status, value: "Confirmed", class: btnc.call("Confirmed", current_status) %>
          <%= button_tag "Shipped", name: :status, value: "Shipped", class: btnc.call("Shipped", current_status) %>
          <%= button_tag "Delivered", name: :status, value: "Delivered", class: btnc.call("Delivered", current_status) %>
          <%= button_tag "Canceled", name: :status, value: "Canceled", class: btnc.call("Canceled", current_status) %>
        </div>
        <%= hidden_field_tag :current_status, current_status %>
        <div class="form-check form-check-inline align-middle ms-2">
          <%= check_box_tag :due, 1, @due_filter, class: "form-check-input", id: "dueFilter" %>
          <label class="form-check-label" for="dueFilter">Con adeudo</label>
        </div>
  <%= link_to "Limpiar filtros", admin_sale_orders_path(request.query_parameters.slice(:sort, :dir)), class: "btn btn-sm btn-outline-secondary ms-2", title: "Quitar búsqueda y status" %>
      </div>
    <% end %>
  </div>
</div>

<%# Contadores inferiores dependientes de búsqueda+filtro (ocultando ceros) %>
<%= render partial: "admin/shared/status_counters", locals: {
  counts: @counts,
  items: [
    ["Pending",   "Pending",   "bg-warning text-dark"],
    ["Confirmed", "Confirmed", "bg-info"],
    ["Shipped",   "Shipped",   "bg-primary"],
    ["Delivered", "Delivered", "bg-success"],
    ["Canceled",  "Canceled",  "bg-danger"],
  ],
  hide_zero: true,
  extra_class: "mb-2",
  title: "Resultados"
} %>

<table class="table table-sm table-hover align-middle">
  <thead class="table-light">
    <tr>
      <th scope="col">#</th>
  <th scope="col"><%= sort_link('Customer', :customer) %></th>
  <th scope="col"><%= sort_link('Order Date', :date) %></th>
  <th scope="col">Status</th>
  <th scope="col" class="text-end"><%= sort_link('Items', :items) %></th>
  <th scope="col" class="text-end"><%= sort_link('Total', :total_mxn) %></th>
  <th scope="col" class="text-end"><%= sort_link('Pagado', :paid) %></th>
  <th scope="col" class="text-end"><%= sort_link('Adeudo', :balance) %></th>
      <th scope="col" class="text-end">Discount</th>
      <th scope="col" class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
    <% @sale_orders.each do |so| %>
      <tr>
        <td><%= so.id %></td>
  <td><%= so.user&.name || "—" %></td>
        <td><%= l(so.order_date, format: :short) %></td>
  <td>
          <span class="badge <%= status_badge_class(so.status) %>">
            <%= so.status %>
          </span>
        </td>
  <td class="text-end"><%= so.attributes["items_count"].to_i %></td>
  <td class="text-end"><%= number_to_currency(so.total_order_value, unit: "$") %></td>
  <td class="text-end"><%= number_to_currency(so.attributes["total_paid_value"].to_d, unit: "$") %></td>
        <% balance = so.attributes["balance_due_value"].to_d %>
        <td class="text-end">
          <% if balance > 0 %>
            <span class="badge bg-danger"> <%= number_to_currency(balance, unit: "$") %> </span>
          <% else %>
            <span class="badge bg-success"> <%= number_to_currency(0, unit: "$") %> </span>
          <% end %>
        </td>
        <td class="text-end"><%= "#{so.discount}%" if so.discount.present? %></td>
        <td class="text-end">
          <%= link_to admin_sale_order_path(so), class: "btn btn-sm btn-outline-secondary" do %>
            <i class="fa fa-eye"></i>
          <% end %>
          <%= link_to edit_admin_sale_order_path(so), class: "btn btn-sm btn-outline-primary" do %>
            <i class="fa fa-edit"></i>
          <% end %>
          <%= button_to admin_sale_order_path(so),
                        method: :delete,
                        form: { data: { turbo_confirm: "Are you sure?" }, class: "d-inline" },
                        class: "btn btn-sm btn-outline-danger" do %>
            <i class="fa fa-trash"></i>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<div class="d-flex justify-content-center mt-3">
  <%= paginate @sale_orders %>
  </div>
