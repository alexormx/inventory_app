<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h5 mb-0">Direcciones de <%= @user.name %></h1>
  <div>
    <%= link_to 'Regresar a usuarios', admin_users_path, class: 'btn btn-outline-secondary btn-sm' %>
    <%= link_to 'Editar Usuario', edit_admin_user_path(@user), class: 'btn btn-outline-primary btn-sm' %>
  </div>
</div>

<script type="module">
  import { setupAddressAutofill } from '/assets/custom/address_autofill.js';
  document.addEventListener('turbo:load', () => {
    setupAddressAutofill({
      cpInput: '#admin_addr_cp',
      coloniaSelect: '#admin_addr_colonia',
      municipioInput: '#admin_addr_municipio',
      estadoInput: '#admin_addr_estado'
    });
  });
</script>

<div class="row">
  <div class="col-md-6">
    <h5 class="mb-2">Guardadas</h5>
    <% if @addresses.any? %>
      <ul class="list-group mb-4">
        <% @addresses.each do |addr| %>
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div>
              <strong><%= addr.label %></strong>
              <% if addr.default? %><span class="badge bg-success ms-1">Default</span><% end %><br>
              <small><%= addr.full_name %></small><br>
              <small class="text-muted"><%= addr.to_one_line %></small>
            </div>
            <div class="ms-2 d-flex flex-column gap-1 align-items-end">
              <%= link_to 'Editar', edit_admin_user_shipping_address_path(@user, addr), class: 'btn btn-sm btn-outline-secondary' %>
              <% unless addr.default? %>
                <%= button_to 'Default', make_default_admin_user_shipping_address_path(@user, addr), method: :patch, class: 'btn btn-sm btn-outline-primary' %>
              <% end %>
              <%= button_to 'Eliminar', admin_user_shipping_address_path(@user, addr), method: :delete, data: { turbo_confirm: '¿Eliminar dirección?' }, class: 'btn btn-sm btn-outline-danger' %>
            </div>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="text-muted">No hay direcciones guardadas.</p>
    <% end %>
  </div>

  <div class="col-md-6">
    <h5 class="mb-2">Agregar nueva</h5>
    <%= form_with model: [:admin, @user, @address], local: true do |f| %>
      <div class="row g-2">
        <div class="col-6">
          <%= f.label :label, 'Etiqueta' %>
          <%= f.text_field :label, class: 'form-control', placeholder: 'Casa / Oficina' %>
        </div>
        <div class="col-6">
          <%= f.label :full_name, 'Nombre' %>
          <%= f.text_field :full_name, class: 'form-control', required: true %>
        </div>
        <div class="col-12">
          <%= f.label :line1, 'Dirección (línea 1)' %>
          <%= f.text_field :line1, class: 'form-control', required: true %>
        </div>
        <div class="col-12">
          <%= f.label :line2, 'Dirección (línea 2)' %>
          <%= f.text_field :line2, class: 'form-control' %>
        </div>
        <div class="col-6">
          <%= f.label :city, 'Ciudad' %>
          <%= f.text_field :city, class: 'form-control', required: true %>
        </div>
        <div class="col-6">
          <%= f.label :municipality, 'Municipio' %>
          <%= f.text_field :municipality, class: 'form-control', id: 'admin_addr_municipio', readonly: true %>
        </div>
        <div class="col-6">
          <%= f.label :postal_code, 'CP' %>
          <%= f.text_field :postal_code, class: 'form-control', required: true, id: 'admin_addr_cp', maxlength: 5 %>
        </div>
        <div class="col-6">
          <%= f.label :settlement, 'Colonia' %>
          <select class="form-select" id="admin_addr_colonia" name="shipping_address[settlement]"></select>
        </div>
        <div class="col-6">
          <%= f.label :state, 'Estado' %>
          <%= f.text_field :state, class: 'form-control', id: 'admin_addr_estado', readonly: true %>
        </div>
        <div class="col-6">
          <%= f.label :country, 'País' %>
          <%= f.text_field :country, class: 'form-control', value: 'MX', required: true %>
        </div>
        <div class="col-12 form-check mt-1">
          <%= f.check_box :default, class: 'form-check-input', id: 'addr_default' %>
          <%= f.label :default, 'Establecer como predeterminada', class: 'form-check-label' %>
        </div>
        <div class="col-12 text-end">
          <%= f.submit 'Guardar', class: 'btn btn-primary' %>
        </div>
      </div>
    <% end %>
  </div>
</div>
