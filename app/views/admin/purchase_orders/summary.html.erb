<%# Resumen compacto de Purchase Order %>
<h1 class="h5 mb-3">PO <%= @purchase_order.id %> (Compacto)</h1>
<div class="mb-2 small text-muted">Fecha: <%= l(@purchase_order.order_date, format: :long) %> • Esperada: <%= l(@purchase_order.expected_delivery_date, format: :long) %></div>
<div class="compact-summary-wrapper po-wrapper mx-auto">
<table class="table table-sm table-bordered align-middle mb-2 po-summary-table">
  <thead class="table-primary text-dark">
    <tr>
      <th style="width:42px">Cantid.</th>
      <th style="width:264px">Producto</th>
      <th style="width:60px" class="text-end">Costo Unit</th>
      <th style="width:66px" class="text-end">Costo Línea</th>
    </tr>
  </thead>
  <tbody>
    <% subtotal = 0.to_d %>
    <% @purchase_order.purchase_order_items.includes(:product).each do |item| %>
      <% prod = item.product %>
      <%# ✅ CORRECCIÓN: line_total solo con costo base, sin extras %>
      <% line_total = (item.quantity.to_d * item.unit_cost.to_d).round(2) %>
      <% subtotal += line_total %>
      <tr>
        <td class="text-center"><%= item.quantity %></td>
        <td>
          <div class="d-flex align-items-center gap-2">
            <% if prod&.respond_to?(:product_images) && prod.product_images.attached? %>
              <% image = prod.product_images.first %>
              <%= image_tag image.variant(resize_to_fill: [36,36]).processed, class: "rounded border bg-white", alt: prod.product_name %>
            <% else %>
              <div class="placeholder rounded border bg-light d-flex align-items-center justify-content-center" style="width:36px;height:36px;font-size:.55rem;">N/A</div>
            <% end %>
            <div class="flex-grow-1 product-info">
              <strong class="small d-block text-truncate" title="<%= prod&.product_name %>"><%= prod&.product_name || 'Producto eliminado' %></strong>
              <span class="text-muted extra-small text-truncate d-block" title="SKU: <%= prod&.product_sku %>"><%= prod&.product_sku %></span>
            </div>
          </div>
        </td>
        <td class="text-end"><%= number_to_currency(item.unit_cost) %></td>
        <td class="text-end"><%= number_to_currency(line_total) %></td>
      </tr>
    <% end %>
    <tr class="table-primary fw-semibold">
      <td></td>
      <td class="text-end">Sub-Total</td>
      <td></td>
      <td class="text-end"><%= number_to_currency(subtotal) %></td>
    </tr>
    <% shipping = (@purchase_order.shipping_cost || 0).to_d %>
    <% other    = (@purchase_order.other_cost || 0).to_d %>
    <% tax      = (@purchase_order.tax_cost || 0).to_d %>
    <% if shipping.positive? %>
      <tr class="table-primary fw-semibold">
        <td></td>
        <td class="text-end">Envío</td>
        <td></td>
        <td class="text-end"><%= number_to_currency(shipping) %></td>
      </tr>
    <% end %>
    <% if other.positive? %>
      <tr class="table-primary fw-semibold">
        <td></td>
        <td class="text-end">Otros</td>
        <td></td>
        <td class="text-end"><%= number_to_currency(other) %></td>
      </tr>
    <% end %>
    <% if tax.positive? %>
      <tr class="table-primary fw-semibold">
        <td></td>
        <td class="text-end">Impuestos</td>
        <td></td>
        <td class="text-end"><%= number_to_currency(tax) %></td>
      </tr>
    <% end %>
    <% grand_total = (subtotal + shipping + other + tax).round(2) %>
    <tr class="table-primary fw-bold">
      <td></td>
      <td class="text-end">Total</td>
      <td></td>
      <td class="text-end"><%= number_to_currency(grand_total) %></td>
    </tr>
  </tbody>
</table>
  <div class="d-flex gap-2 mt-3">
    <%= link_to 'Ver detalle completo', admin_purchase_order_path(@purchase_order), class: 'btn btn-outline-secondary btn-sm' %>
    <%= link_to 'Volver a listado', admin_purchase_orders_path, class: 'btn btn-outline-primary btn-sm' %>
  </div>
</div>
<style>
.po-summary-table thead th { font-size:.72rem; letter-spacing:.4px; padding:.35rem .45rem; }
.po-summary-table tbody td { font-size:.75rem; padding:.35rem .45rem; }
.po-summary-table tbody td:first-child { font-weight:600; }
.po-summary-table .extra-small { font-size:.6rem; }
.po-summary-table .product-info { min-width:0; }
.po-summary-table .product-info .text-truncate { max-width:185px; }
.compact-summary-wrapper.po-wrapper { width:60%; min-width:320px; }
@media (max-width: 992px){ .compact-summary-wrapper.po-wrapper { width:100%; } }
</style>
