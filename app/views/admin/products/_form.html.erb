<%= form_with model: [:admin, @product], local: false, class: "row g-3" do |f| %>
  <% req = ->(text){ raw("#{text} <span class=\"text-danger\">*</span>") } %>
  <div class="col-md-3">
    <%= f.label :product_name, req.call('Product name') %>
    <%= f.text_field :product_name, class: "form-control", required: true %>
  </div>

  <div class="col-md-3">
  <%= f.label :product_sku, req.call('SKU') %>
  <%= f.text_field :product_sku, class: "form-control", required: true %>
  </div>

  <div class="col-md-3">
    <%= f.label :barcode %>
    <%= f.text_field :barcode, class: "form-control" %>
  </div>

  <div class="col-md-3">
    <%= f.label :supplier_product_code, "Supplier Product Code" %>
    <%= f.text_field :supplier_product_code, class: "form-control" %>
  </div>

  <div class="col-md-3">
    <%= f.label :brand %>
    <%= f.text_field :brand, class: "form-control" %>
  </div>

  <div class="col-md-3">
    <%= f.label :category %>
    <%= f.text_field :category, class: "form-control" %>
  </div>

  <div class="col-md-2">
    <%= f.label :reorder_point %>
    <%= f.number_field :reorder_point, class: "form-control" %>
  </div>

  <div class="col-md-2">
  <%= f.label :selling_price, req.call('Selling price') %>
  <%= f.number_field :selling_price, step: 0.01, class: "form-control", required: true, min: 0 %>
  </div>

  <div class="col-md-2">
    <%= f.label :maximum_discount %>
    <%= f.number_field :maximum_discount, step: 0.01, class: "form-control" %>
  </div>

  <div class="col-md-2">
    <%= f.label :minimum_price %>
    <%= f.number_field :minimum_price, step: 0.01, class: "form-control" %>
  </div>

  <div class="col-md-2">
    <%= f.label :discount_limited_stock %>
    <%= f.number_field :discount_limited_stock, class: "form-control" %>
  </div>

  <div class="col-md-2">
    <%= f.label :status %>
    <%= f.select :status,
        Product.statuses.keys.map { |s| [s.titleize, s] },
        {},
        class: "form-select" %>
  </div>

  <div class="col-md-2">
    <%= f.label :weight_grams, "Weight (grams)" %>
    <%= f.number_field :weight_gr, class: "form-control", min: 0 %>
  </div>

  <div class="col-md-2">
    <%= f.label :length_cm, "Length (cm)" %>
    <%= f.number_field :length_cm, class: "form-control", min: 0 %>
  </div>

  <div class="col-md-2">
    <%= f.label :width_cm, "Width (cm)" %>
    <%= f.number_field :width_cm, class: "form-control", min: 0 %>
  </div>

  <div class="col-md-2">
    <%= f.label :height_cm, "Height (cm)" %>
    <%= f.number_field :height_cm, class: "form-control", min: 0 %>
  </div>

  <div class="col-md-2">
    <%= f.label :backorder_allowed %>
    <%= f.check_box :backorder_allowed %>
  </div>

  <div class="col-md-2">
    <%= f.label :preorder_available %>
    <%= f.check_box :preorder_available %>
  </div>

  <div class="col-md-12">
    <%= f.label :description %>
    <%= f.text_area :description, class: "form-control", rows: 2, placeholder: "Agregar o modificar la descripcion" %>
  </div>

  <div class="col-md-12">
    <%= f.label :product_images, req.call('Fotos (requerido)') %>
    <div class="border border-2 border-dashed rounded p-4 text-center bg-light" 
         data-controller="dropzone" 
         data-dropzone-accept-value="image/*"
         data-dropzone-max-files-value="10">
      <div class="mb-2 text-muted">
        <i class="fa-regular fa-images me-1"></i>
        Seleccionar o arrastrar los archivos aquí
      </div>
      <small class="text-muted d-block">Sube máximo 10 fotos JPG, JPEG, PNG o WEBP. Recomendado: > 500px por lado, máximo 10MB.</small>
      <%= f.file_field :product_images, multiple: true, direct_upload: true, class: "d-none", data: { dropzone_target: "input" }, accept: "image/*" %>
      <ul class="list-group list-group-flush mt-3 text-start" data-dropzone-target="preview"></ul>
    </div>
  </div>

  <% if @product.persisted? && @product.product_images.attached? %>
    <div class="col-md-12">
      <label class="form-label">Current Images</label>
      <div class="row g-2">
        <% @product.product_images.each do |image| %>
          <div id="image_<%= image.id %>" class="col-4 col-sm-3 col-md-2 position-relative">
            <div class="border rounded p-1 text-center bg-light">
              <%= image_tag image.variant(resize_to_limit: [100, 100]), class: "img-fluid rounded" %>

              <%= link_to admin_product_purge_image_path(@product, image_id: image.id),
                          method: :delete,
                          data: { turbo_confirm: "Remove this image?",
                                 turbo_method: :delete },
                          class: "btn btn-sm btn-danger position-absolute top-0 end-0 m-1" do %>
                <i class="fa-solid fa-xmark"></i>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="col-md-12" data-controller="kv-editor"
       data-kv-editor-initial-value-value='<%= (@product.parsed_custom_attributes || {}).to_json %>'>
    <%= f.label :custom_attributes, "Custom attributes" %>
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-2">
        <thead>
          <tr>
            <th style="width: 35%">Key</th>
            <th>Value</th>
            <th style="width: 60px"></th>
          </tr>
        </thead>
        <tbody data-kv-editor-target="rows"></tbody>
      </table>
    </div>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-primary btn-sm" data-action="kv-editor#addRow">Agregar atributo</button>
      <button type="button" class="btn btn-outline-secondary btn-sm" data-action="kv-editor#importJson">Importar JSON</button>
    </div>
    <%= f.hidden_field :custom_attributes, value: (@product.parsed_custom_attributes || {}).to_json, data: { kv_editor_target: "hidden" } %>
    <small class="text-muted d-block mt-1">Se guardará como JSON. Las claves se normalizan en minúsculas.</small>
  </div>

  <div class="col-12">
    <%= f.submit class: "btn btn-success" %>
    <%= link_to "Cancel", admin_products_path, class: "btn btn-secondary" %>
  </div>
<% end %>
