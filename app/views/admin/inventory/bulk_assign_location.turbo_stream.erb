<%# Flash message %>
<%= turbo_stream.replace "flash-messages" do %>
  <div id="flash-messages" class="container mt-3">
    <% if flash[:notice] %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle"></i> <%= flash[:notice] %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% end %>
    <% if flash[:alert] %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle"></i> <%= flash[:alert] %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% end %>
  </div>
<% end %>

<%# Actualizar badges del header con los nuevos totales %>
<%= turbo_stream.replace "unlocated-header-badges" do %>
  <span id="unlocated-header-badges">
    <span class="badge bg-warning text-dark ms-2">
      <i class="fas fa-box"></i> <%= @total_unlocated %> piezas sin ubicar
    </span>
    <span class="badge bg-secondary ms-1">
      <%= @total_products %> productos
    </span>
  </span>
<% end %>

<%# Actualizar cada producto afectado: actualizar contador o remover fila %>
<% @affected_products.each do |product_id, data| %>
  <% if data[:remaining] == 0 %>
    <%# Remover la fila del producto y su fila de detalle %>
    <%= turbo_stream.remove "product-row-#{product_id}" %>
    <%= turbo_stream.remove "product-detail-row-#{product_id}" %>
  <% else %>
    <%# Actualizar el badge de cantidad sin ubicar %>
    <%= turbo_stream.replace "product-unlocated-count-#{product_id}" do %>
      <span id="product-unlocated-count-<%= product_id %>" class="badge bg-warning text-dark"><%= data[:remaining] %></span>
    <% end %>
  <% end %>
<% end %>

<%# Resetear el contador del carrito %>
<%= turbo_stream.replace "bulk-assign-counter" do %>
  <span class="fw-bold fs-5 text-muted" data-bulk-location-assign-target="counter" id="bulk-assign-counter">0</span>
<% end %>

<%# Si no quedan productos, mostrar mensaje de éxito en la tabla %>
<% if @total_products == 0 %>
  <%= turbo_stream.replace "unlocated-products-frame" do %>
    <turbo-frame id="unlocated-products-frame">
      <div class="card-body text-center py-5">
        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
        <h5>¡Todo el inventario tiene ubicación!</h5>
        <p class="text-muted small">No hay piezas de inventario pendientes de asignar ubicación.</p>
        <%= link_to 'Ver Inventario', admin_inventory_path, class: 'btn btn-primary btn-sm' %>
        <%= link_to 'Ver Ubicaciones', admin_inventory_locations_path, class: 'btn btn-outline-secondary btn-sm' %>
      </div>
    </turbo-frame>
  <% end %>
<% end %>
