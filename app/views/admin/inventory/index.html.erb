<%
  # Calcular métricas destacadas
  available_count = @inventory_counts_global[:available] || 0
  reserved_count = @inventory_counts_global[:reserved] || 0
  in_transit_count = @inventory_counts_global[:in_transit] || 0
  sold_count = @inventory_counts_global[:sold] || 0
  total_count = @inventory_counts_global.values.sum

  # Calcular valores estimados del inventario por estado
  available_value = Inventory.where(status: :available).sum(:purchase_cost) rescue 0
  reserved_value = Inventory.where(status: :reserved).sum(:purchase_cost) rescue 0
  in_transit_value = Inventory.where(status: :in_transit).sum(:purchase_cost) rescue 0
  total_value = Inventory.sum(:purchase_cost) rescue 0

  status_icons = {
    'available' => 'check-circle', 'reserved' => 'bookmark', 'in_transit' => 'truck',
    'sold' => 'shopping-cart', 'pre_reserved' => 'clock', 'pre_sold' => 'hourglass-half',
    'marketing' => 'bullhorn', 'returned' => 'undo', 'damaged' => 'exclamation-triangle',
    'lost' => 'question-circle', 'scrap' => 'trash'
  }
  status_labels = {
    'available' => 'Disponible', 'reserved' => 'Apartado', 'in_transit' => 'En Tránsito',
    'sold' => 'Vendido', 'pre_reserved' => 'Pre-Apartado', 'pre_sold' => 'Pre-Vendido',
    'marketing' => 'Marketing', 'returned' => 'Devuelto', 'damaged' => 'Dañado',
    'lost' => 'Perdido', 'scrap' => 'Scrap'
  }
%>

<%# Header con navegación %>
<div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
  <h2 class="mb-0 d-flex align-items-center gap-2">
    <i class="fa fa-archive text-primary"></i> Inventario
  </h2>
  <div class="d-flex gap-2 flex-wrap">
    <%= link_to admin_inventory_path(request.query_parameters.merge(format: :csv)), class: "btn btn-outline-secondary btn-sm" do %>
      <i class="fa fa-download"></i> Exportar CSV
    <% end %>
    <%= link_to admin_inventory_adjustments_path, class: "btn btn-outline-info btn-sm" do %>
      <i class="fa fa-sliders-h"></i> Ajustes
    <% end %>
  </div>
</div>

<%# Cards de métricas destacadas %>
<div class="row g-3 mb-4">
  <div class="col-md-3 col-sm-6">
    <div class="card border-0 shadow-sm h-100 border-start border-success border-4">
      <div class="card-body py-3">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="text-muted small text-uppercase">Disponible</div>
            <div class="h4 mb-0 text-success"><%= number_with_delimiter(available_count) %></div>
            <div class="small text-muted"><%= number_to_currency(available_value, unit: '$', precision: 0) %> valor</div>
          </div>
          <div class="rounded-circle bg-success bg-opacity-10 p-2">
            <i class="fa fa-check-circle text-success"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="card border-0 shadow-sm h-100 border-start border-info border-4">
      <div class="card-body py-3">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="text-muted small text-uppercase">Reservado</div>
            <div class="h4 mb-0 text-info"><%= number_with_delimiter(reserved_count) %></div>
            <div class="small text-muted"><%= number_to_currency(reserved_value, unit: '$', precision: 0) %> valor</div>
          </div>
          <div class="rounded-circle bg-info bg-opacity-10 p-2">
            <i class="fa fa-bookmark text-info"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="card border-0 shadow-sm h-100 border-start border-primary border-4">
      <div class="card-body py-3">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="text-muted small text-uppercase">En Tránsito</div>
            <div class="h4 mb-0 text-primary"><%= number_with_delimiter(in_transit_count) %></div>
            <div class="small text-muted"><%= number_to_currency(in_transit_value, unit: '$', precision: 0) %> valor</div>
          </div>
          <div class="rounded-circle bg-primary bg-opacity-10 p-2">
            <i class="fa fa-truck text-primary"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="card border-0 shadow-sm h-100 border-start border-secondary border-4">
      <div class="card-body py-3">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="text-muted small text-uppercase">Total Piezas</div>
            <div class="h4 mb-0"><%= number_with_delimiter(total_count) %></div>
            <div class="small text-muted"><%= number_to_currency(total_value, unit: '$', precision: 0) %> valor</div>
          </div>
          <div class="rounded-circle bg-secondary bg-opacity-10 p-2">
            <i class="fa fa-cubes text-secondary"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%# Filtros y búsqueda %>
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body py-3">
    <%= form_with url: admin_inventory_path, method: :get, local: true, class: "row g-2 align-items-center" do %>
      <div class="col-12 col-lg-4">
        <div class="input-group input-group-sm">
          <span class="input-group-text bg-light border-end-0"><i class="fa fa-search text-muted"></i></span>
          <%= text_field_tag :q, @q, class: "form-control border-start-0 inventory-search-input", placeholder: "Buscar por nombre o SKU…" %>
          <button class="btn btn-primary" type="submit"><i class="fa fa-search"></i></button>
        </div>
      </div>

      <div class="col-12 col-lg-8">
        <div class="d-flex flex-wrap gap-2 justify-content-lg-end align-items-center">
          <% current_status = @status_filter.presence || "all" %>

          <%# Filter chips con scroll horizontal en móvil %>
          <div class="d-flex gap-1 flex-wrap" style="max-width: 100%;">
            <%
              chip_styles = {
                'all' => 'outline-secondary',
                'available' => 'outline-success',
                'reserved' => 'outline-info',
                'in_transit' => 'outline-primary',
                'sold' => 'outline-secondary',
                'pre_reserved' => 'outline-info',
                'pre_sold' => 'outline-secondary',
                'marketing' => 'outline-dark',
                'damaged' => 'outline-warning',
                'lost' => 'outline-dark',
                'scrap' => 'outline-danger'
              }
              # Estados principales (mostrar siempre)
              main_statuses = ['all', 'available', 'reserved', 'in_transit', 'sold']
              # Estados secundarios (en dropdown)
              other_statuses = ['pre_reserved', 'pre_sold', 'marketing', 'damaged', 'lost', 'scrap']
            %>

            <%# Chips principales %>
            <% main_statuses.each do |st| %>
              <% is_active = current_status == st %>
              <% count = st == 'all' ? total_count : (@inventory_counts_global[st.to_sym] || 0) %>
              <%= button_tag name: :status, value: st,
                  class: "btn btn-sm btn-#{chip_styles[st]} #{'active' if is_active}",
                  title: st == 'all' ? 'Todos' : status_labels[st] do %>
                <% if st != 'all' %><i class="fa fa-<%= status_icons[st] %> me-1"></i><% end %>
                <%= st == 'all' ? 'Todos' : status_labels[st] %>
                <span class="badge bg-light text-dark ms-1"><%= count %></span>
              <% end %>
            <% end %>

            <%# Dropdown para otros estados %>
            <div class="dropdown d-inline-block" data-controller="dropdown">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                      data-dropdown-target="button"
                      data-action="click->dropdown#toggle"
                      aria-expanded="false">
                <i class="fa fa-ellipsis-h"></i> Otros
              </button>
              <ul class="dropdown-menu dropdown-menu-end" data-dropdown-target="menu">
                <% other_statuses.each do |st| %>
                  <% count = @inventory_counts_global[st.to_sym] || 0 %>
                  <li>
                    <%= button_tag name: :status, value: st,
                        class: "dropdown-item d-flex justify-content-between align-items-center #{'active bg-primary text-white' if current_status == st}" do %>
                      <span><i class="fa fa-<%= status_icons[st] %> me-2"></i><%= status_labels[st] %></span>
                      <span class="badge bg-light text-dark"><%= count %></span>
                    <% end %>
                  </li>
                <% end %>
              </ul>
            </div>
          </div>

          <%= hidden_field_tag :current_status, current_status %>

          <% if @q.present? || (current_status != 'all') %>
            <%= link_to admin_inventory_path, class: "btn btn-sm btn-outline-secondary" do %>
              <i class="fa fa-times"></i> Limpiar
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<%# Contadores filtrados (solo si hay filtro activo) %>
<% if @q.present? || (@status_filter.present? && @status_filter != 'all') %>
  <div class="d-flex flex-wrap gap-2 mb-3 small">
    <span class="text-muted me-2"><i class="fa fa-filter"></i> Resultados:</span>
    <% @inventory_counts.each do |status, count| %>
      <% next if count == 0 %>
      <span class="badge bg-<%= inventory_status_color(status.to_s) %>">
        <%= status_labels[status.to_s] || status.to_s.humanize %>
        <span class="fw-bold"><%= count %></span>
      </span>
    <% end %>
  </div>
<% end %>

<%# Lista de productos con inventario %>
<div id="inventory-list">
  <% @products_with_inventory.each do |product| %>
    <% filtered_status = @status_filter.presence || "all" %>
    <% total_items = if filtered_status.present? && filtered_status != "all"
        product.inventories.where(status: filtered_status).size
      else
        product.inventories.size
      end %>
    <% cache_buster = product.updated_at&.to_i || Time.now.to_i %>

    <div class="card border-0 shadow-sm mb-3 inventory-card"
         data-controller="toggle-inventory"
         data-toggle-inventory-url-value="<%= items_admin_inventory_path(product, status: filtered_status, _ts: cache_buster) %>"
         data-toggle-inventory-count-value="<%= total_items %>">

      <%# Header de la card %>
      <div class="card-header bg-transparent border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
          <%# Producto info %>
          <div class="d-flex align-items-center gap-3">
            <% if product.product_images.attached? %>
              <%= link_to admin_product_path(product), title: "Ver producto" do %>
                <%= image_tag product.product_images.first.variant(resize_to_fill: [50, 50]), class: "rounded border", style: "width: 50px; height: 50px; object-fit: cover;" %>
              <% end %>
            <% else %>
              <div class="rounded bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                <i class="fa fa-image text-muted"></i>
              </div>
            <% end %>
            <div>
              <div class="fw-semibold">
                <%= link_to product.product_name, admin_product_path(product), class: "text-decoration-none text-dark" %>
              </div>
              <div class="small text-muted">
                <span class="me-3"><i class="fa fa-barcode me-1"></i><%= product.product_sku %></span>
                <% if product.average_purchase_cost.to_f > 0 %>
                  <span><i class="fa fa-tag me-1"></i>Costo: <%= number_to_currency(product.average_purchase_cost, unit: '$', precision: 2) %></span>
                <% end %>
              </div>
            </div>
          </div>

          <%# Acciones y toggle %>
          <div class="d-flex align-items-center gap-2">
            <% if total_items > 0 %>
              <button type="button"
                      data-toggle-inventory-target="button"
                      data-action="click->toggle-inventory#toggle"
                      class="btn btn-sm btn-outline-primary inventory-toggle">
                <i class="fa fa-eye me-1"></i> Ver piezas
                <span class="badge bg-primary text-white ms-1"><%= total_items %></span>
              </button>
            <% else %>
              <span class="badge bg-light text-muted border">Sin piezas</span>
            <% end %>

            <%= link_to admin_product_path(product), class: "btn btn-sm btn-outline-secondary", title: "Ver producto" do %>
              <i class="fa fa-external-link-alt"></i>
            <% end %>
          </div>
        </div>
      </div>

      <%# Summary badges %>
      <div class="card-body py-2 border-top bg-light">
        <% counts = product.inventories.group_by(&:status).transform_values(&:size) %>
        <div class="d-flex flex-wrap gap-2 small">
          <% ['available', 'reserved', 'in_transit', 'sold', 'pre_reserved', 'pre_sold', 'marketing', 'damaged', 'lost', 'scrap'].each do |key| %>
            <% count = counts[key] || 0 %>
            <% next if count == 0 %>
            <span class="badge rounded-pill bg-<%= inventory_status_color(key) %>" title="<%= status_labels[key] %>">
              <i class="fa fa-<%= status_icons[key] %> me-1"></i>
              <%= status_labels[key] %>
              <span class="fw-bold"><%= count %></span>
            </span>
          <% end %>
          <% total = product.inventories.size %>
          <span class="badge rounded-pill bg-secondary ms-auto">
            Total: <span class="fw-bold"><%= total %></span>
          </span>
        </div>
      </div>

      <%# Frame para items (carga bajo demanda) %>
      <turbo-frame id="inventory-items-frame-<%= product.id %>"
                   data-toggle-inventory-target="frame"
                   class="collapse">
        <div class="inventory-loader d-none text-center text-muted py-4">
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
          <span class="ms-2">Cargando piezas…</span>
        </div>
      </turbo-frame>
    </div>
  <% end %>
</div>

<%# Empty state %>
<% if @products_with_inventory.none? %>
  <div class="card border-0 shadow-sm">
    <div class="card-body text-center py-5">
      <i class="fa fa-archive fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">No hay productos con inventario</h5>
      <p class="text-muted mb-3">Ajusta los filtros o la búsqueda para ver resultados</p>
      <%= link_to admin_inventory_path, class: "btn btn-outline-primary" do %>
        <i class="fa fa-times"></i> Limpiar filtros
      <% end %>
    </div>
  </div>
<% end %>

<%# Paginación %>
<% if @products_with_inventory.total_pages > 1 %>
  <div class="d-flex justify-content-center mt-4">
    <%= paginate @products_with_inventory %>
  </div>
<% end %>
