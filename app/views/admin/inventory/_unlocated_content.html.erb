<div class="container mt-3" data-controller="bulk-location-assign">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3><i class="fas fa-map-marker-alt"></i> Inventario Sin Ubicación</h3>
      <p class="text-muted mb-0">
        Asigna ubicación a piezas de inventario que aún no tienen ubicación asignada.
        <span class="badge bg-warning text-dark ms-2">
          <i class="fas fa-box"></i> <%= @total_unlocated %> piezas sin ubicar
        </span>
        <span class="badge bg-secondary ms-1">
          <%= @total_products %> productos
        </span>
      </p>
    </div>
    <div>
      <%= link_to admin_inventory_path, class: 'btn btn-outline-secondary' do %>
        <i class="fas fa-arrow-left"></i> Volver a Inventario
      <% end %>
    </div>
  </div>

  <!-- Filtros y ordenación -->
  <div class="card mb-3">
    <div class="card-body py-2">
      <%= form_with url: admin_inventory_unlocated_path, method: :get, local: true, class: "row g-2 align-items-center" do %>
        <div class="col-md-5">
          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <%= text_field_tag :q, @q, class: 'form-control', placeholder: 'Buscar por nombre o SKU...' %>
            <% if @q.present? %>
              <%= link_to admin_inventory_unlocated_path(sort: @sort), class: 'btn btn-outline-secondary' do %>
                <i class="fas fa-times"></i>
              <% end %>
            <% end %>
          </div>
        </div>
        <div class="col-md-4">
          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="fas fa-sort"></i> Ordenar</span>
            <%= select_tag :sort, options_for_select([
              ['Por nombre A-Z', 'name'],
              ['Más piezas primero', 'count_desc'],
              ['Menos piezas primero', 'count_asc']
            ], @sort), class: 'form-select', onchange: 'this.form.submit()' %>
          </div>
        </div>
        <div class="col-md-3 text-end">
          <button type="submit" class="btn btn-sm btn-primary">
            <i class="fas fa-filter"></i> Filtrar
          </button>
        </div>
      <% end %>
    </div>
  </div>

  <% if @products.any? %>
    <%= form_with url: admin_inventory_bulk_assign_location_path, method: :post, data: { action: "submit->bulk-location-assign#prepareSubmit" } do |f| %>
      <!-- Panel de ubicación destino -->
      <div class="card mb-3">
        <div class="card-header bg-primary text-white py-2">
          <i class="fas fa-crosshairs"></i> Ubicación Destino
        </div>
        <div class="card-body py-3">
          <div class="row align-items-end">
            <div class="col-md-8">
              <label class="form-label fw-bold small">Buscar ubicación por código o nombre:</label>
              <div class="position-relative"
                   data-controller="location-suggest"
                   data-location-suggest-url-value="<%= search_admin_inventory_locations_path %>">
                <input type="text"
                       class="form-control"
                       placeholder="Ej: PRINCIPAL, ESTANTE-A, BOD..."
                       data-location-suggest-target="input"
                       data-action="input->location-suggest#input keydown->location-suggest#keydown"
                       autocomplete="off">
                <input type="hidden"
                       name="inventory_location_id"
                       data-location-suggest-target="hidden"
                       data-bulk-location-assign-target="locationInput"
                       data-action="change->bulk-location-assign#locationSelected">
                <div data-location-suggest-target="results" class="position-relative"></div>
                <div data-location-suggest-target="hint" class="form-text mt-1"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex align-items-center justify-content-between bg-light p-2 rounded">
                <div>
                  <small class="text-muted d-block">Piezas a asignar:</small>
                  <span class="fs-4 fw-bold" data-bulk-location-assign-target="counter">0</span>
                </div>
                <button type="submit"
                        class="btn btn-success"
                        data-bulk-location-assign-target="submitBtn"
                        disabled>
                  <i class="fas fa-check"></i> Asignar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de productos -->
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
          <div>
            <i class="fas fa-cubes"></i>
            <strong><%= @products.respond_to?(:total_count) ? @products.total_count : @products.size %></strong> productos
            <% if @q.present? %>
              <small class="text-muted">(filtrado)</small>
            <% end %>
          </div>
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-secondary" data-action="click->bulk-location-assign#expandAll">
              <i class="fas fa-expand-alt"></i> Expandir
            </button>
            <button type="button" class="btn btn-outline-secondary" data-action="click->bulk-location-assign#collapseAll">
              <i class="fas fa-compress-alt"></i> Colapsar
            </button>
          </div>
        </div>

        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th width="40">
                  <input type="checkbox"
                         class="form-check-input"
                         data-bulk-location-assign-target="selectAll"
                         data-action="change->bulk-location-assign#toggleSelectAll">
                </th>
                <th width="40"></th>
                <th>Producto</th>
                <th width="120" class="text-center">Sin Ubicar</th>
                <th width="200" class="text-center">Cantidad a Asignar</th>
              </tr>
            </thead>
            <tbody>
              <% @products.each do |product| %>
                <% unlocated_count = @products_data[product.id] || 0 %>
                <tr data-bulk-location-assign-target="productGroup" data-product-id="<%= product.id %>">
                  <td>
                    <input type="checkbox"
                           class="form-check-input"
                           data-bulk-location-assign-target="checkbox"
                           data-action="change->bulk-location-assign#checkboxChanged">
                  </td>
                  <td>
                    <button type="button"
                            class="btn btn-sm btn-link p-0 toggle-btn"
                            data-action="click->bulk-location-assign#toggleGroup"
                            data-url="<%= admin_inventory_unlocated_items_path(product_id: product.id) %>">
                      <i class="fas fa-chevron-right toggle-icon"></i>
                    </button>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <% if product.product_images.attached? %>
                        <%= image_tag product.product_images.first.variant(resize_to_limit: [40, 40]), class: 'me-2 rounded' %>
                      <% else %>
                        <div class="me-2 bg-secondary rounded d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                          <i class="fas fa-image text-white"></i>
                        </div>
                      <% end %>
                      <div>
                        <strong><%= product.product_name %></strong>
                        <br><small class="text-muted"><%= product.product_sku %></small>
                      </div>
                    </div>
                  </td>
                  <td class="text-center">
                    <span class="badge bg-warning text-dark fs-6"><%= unlocated_count %></span>
                  </td>
                  <td class="text-center">
                    <div class="input-group input-group-sm" style="max-width: 180px; margin: 0 auto;">
                      <button type="button"
                              class="btn btn-outline-secondary"
                              title="Limpiar"
                              data-action="click->bulk-location-assign#clearQuantity">
                        <i class="fas fa-times"></i>
                      </button>
                      <input type="number"
                             name="assignments[<%= product.id %>]"
                             class="form-control text-center"
                             min="0"
                             max="<%= unlocated_count %>"
                             value="0"
                             data-bulk-location-assign-target="quantityInput"
                             data-action="input->bulk-location-assign#quantityChanged">
                      <button type="button"
                              class="btn btn-outline-primary"
                              title="Asignar todo"
                              data-action="click->bulk-location-assign#assignAll">
                        <i class="fas fa-check-double"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <!-- Fila colapsable con detalles del inventario (carga diferida) -->
                <tr class="detail-row" style="display: none;">
                  <td colspan="5" class="p-0 border-0">
                    <div class="product-group-content ms-4">
                      <div class="detail-content p-2 text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Cargando...
                      </div>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <% if @total_pages && @total_pages > 1 %>
          <div class="card-footer bg-light">
            <nav aria-label="Paginación">
              <ul class="pagination pagination-sm justify-content-center mb-0">
                <% if @current_page > 1 %>
                  <li class="page-item">
                    <%= link_to admin_inventory_unlocated_path(page: @current_page - 1, q: @q, sort: @sort), class: 'page-link' do %>
                      <i class="fas fa-chevron-left"></i>
                    <% end %>
                  </li>
                <% end %>

                <% start_page = [1, @current_page - 2].max %>
                <% end_page = [@total_pages, @current_page + 2].min %>

                <% if start_page > 1 %>
                  <li class="page-item">
                    <%= link_to '1', admin_inventory_unlocated_path(page: 1, q: @q, sort: @sort), class: 'page-link' %>
                  </li>
                  <% if start_page > 2 %>
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                  <% end %>
                <% end %>

                <% (start_page..end_page).each do |page| %>
                  <li class="page-item <%= 'active' if page == @current_page %>">
                    <%= link_to page, admin_inventory_unlocated_path(page: page, q: @q, sort: @sort), class: 'page-link' %>
                  </li>
                <% end %>

                <% if end_page < @total_pages %>
                  <% if end_page < @total_pages - 1 %>
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                  <% end %>
                  <li class="page-item">
                    <%= link_to @total_pages, admin_inventory_unlocated_path(page: @total_pages, q: @q, sort: @sort), class: 'page-link' %>
                  </li>
                <% end %>

                <% if @current_page < @total_pages %>
                  <li class="page-item">
                    <%= link_to admin_inventory_unlocated_path(page: @current_page + 1, q: @q, sort: @sort), class: 'page-link' do %>
                      <i class="fas fa-chevron-right"></i>
                    <% end %>
                  </li>
                <% end %>
              </ul>
            </nav>
          </div>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <div class="card">
      <div class="card-body text-center py-5">
        <% if @q.present? %>
          <i class="fas fa-search fa-4x text-muted mb-3"></i>
          <h4>No se encontraron productos</h4>
          <p class="text-muted">No hay productos que coincidan con "<%= @q %>"</p>
          <%= link_to 'Limpiar búsqueda', admin_inventory_unlocated_path, class: 'btn btn-outline-primary' %>
        <% else %>
          <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
          <h4>¡Todo el inventario tiene ubicación!</h4>
          <p class="text-muted">No hay piezas de inventario pendientes de asignar ubicación.</p>
          <%= link_to 'Ver Inventario', admin_inventory_path, class: 'btn btn-primary' %>
          <%= link_to 'Ver Ubicaciones', admin_inventory_locations_path, class: 'btn btn-outline-secondary' %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
