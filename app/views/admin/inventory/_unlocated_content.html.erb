<div class="container mt-3"
     data-controller="bulk-location-assign"
     data-bulk-location-assign-location-contents-url-value="<%= admin_inventory_location_contents_path(location_id: '__ID__') %>">

  <%# ═══ HEADER ═══ %>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3><i class="fas fa-map-marker-alt"></i> Asignación de Ubicación</h3>
      <p class="text-muted mb-0">
        Selecciona una ubicación, agrega piezas al carrito y asigna todo de una vez.
        <span id="unlocated-header-badges">
          <span class="badge bg-warning text-dark ms-2">
            <i class="fas fa-box"></i> <%= @total_unlocated %> piezas sin ubicar
          </span>
          <span class="badge bg-secondary ms-1">
            <%= @total_products %> productos
          </span>
        </span>
      </p>
    </div>
    <div>
      <%= link_to admin_inventory_path, class: 'btn btn-outline-secondary' do %>
        <i class="fas fa-arrow-left"></i> Volver
      <% end %>
    </div>
  </div>

  <%# ═══ PASO 1: SELECCIONAR UBICACIÓN ═══ %>
  <div class="card mb-3 border-primary">
    <div class="card-header bg-primary text-white py-2">
      <i class="fas fa-crosshairs me-1"></i>
      <strong>Paso 1:</strong> Seleccionar Ubicación Destino
    </div>
    <div class="card-body py-3">
      <div class="row align-items-end">
        <div class="col-md-8">
          <label class="form-label fw-bold small mb-1">Buscar ubicación por código o nombre:</label>
          <div class="position-relative"
               data-controller="location-suggest"
               data-location-suggest-url-value="<%= search_admin_inventory_locations_path %>">
            <input type="text"
                   class="form-control"
                   placeholder="Ej: PRINCIPAL, ESTANTE-A, BOD..."
                   data-location-suggest-target="input"
                   data-action="input->location-suggest#input keydown->location-suggest#keydown"
                   autocomplete="off">
            <input type="hidden"
                   id="selected-location-id"
                   data-location-suggest-target="hidden"
                   data-bulk-location-assign-target="locationInput"
                   data-action="change->bulk-location-assign#locationSelected">
            <div data-location-suggest-target="results" class="position-relative"></div>
            <div data-location-suggest-target="hint" class="form-text mt-1"></div>
          </div>
        </div>
        <div class="col-md-4">
          <div id="location-selected-indicator" data-bulk-location-assign-target="locationIndicator"
               class="bg-light rounded p-2 text-center text-muted small" style="min-height: 58px; display: flex; align-items: center; justify-content: center;">
            <span><i class="fas fa-arrow-left me-1"></i> Selecciona una ubicación para comenzar</span>
          </div>
        </div>
      </div>

      <%# Panel de piezas existentes en la ubicación (se carga dinámicamente) %>
      <div id="location-contents-panel" data-bulk-location-assign-target="locationContents"
           class="mt-3" style="display: none;">
        <div class="border rounded">
          <div class="bg-light px-3 py-2 d-flex justify-content-between align-items-center border-bottom">
            <small class="fw-bold text-muted">
              <i class="fas fa-boxes me-1"></i> Piezas actualmente en esta ubicación
            </small>
            <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-2"
                    data-action="click->bulk-location-assign#toggleLocationContents">
              <i class="fas fa-chevron-up" data-bulk-location-assign-target="locationContentsIcon"></i>
            </button>
          </div>
          <div id="location-contents-body" data-bulk-location-assign-target="locationContentsBody">
            <div class="text-center py-3 text-muted">
              <i class="fas fa-spinner fa-spin"></i> Cargando...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# ═══ PASO 2 y 3: BUSCAR PIEZAS + CARRITO ═══ %>
  <div class="row">
    <%# ── COLUMNA IZQUIERDA: Búsqueda de piezas ── %>
    <div class="col-lg-8 mb-3">
      <div class="card h-100">
        <div class="card-header bg-light py-2">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <i class="fas fa-search me-1"></i>
              <strong>Paso 2:</strong> Buscar y agregar piezas
            </div>
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn btn-outline-secondary" data-action="click->bulk-location-assign#expandAll">
                <i class="fas fa-expand-alt"></i>
              </button>
              <button type="button" class="btn btn-outline-secondary" data-action="click->bulk-location-assign#collapseAll">
                <i class="fas fa-compress-alt"></i>
              </button>
            </div>
          </div>
        </div>

        <%# Filtros de búsqueda dentro de turbo frame %>
        <div class="card-body py-2 border-bottom">
          <turbo-frame id="unlocated-search-frame" target="_top">
            <%= form_with url: admin_inventory_unlocated_path, method: :get, local: true,
                          class: "row g-2 align-items-center",
                          data: { turbo_frame: "unlocated-products-frame" } do %>
              <div class="col-md-6">
                <div class="input-group input-group-sm">
                  <span class="input-group-text"><i class="fas fa-search"></i></span>
                  <%= text_field_tag :q, @q, class: 'form-control', placeholder: 'Buscar por nombre o SKU...' %>
                  <% if @q.present? %>
                    <%= link_to admin_inventory_unlocated_path(sort: @sort), class: 'btn btn-outline-secondary',
                                data: { turbo_frame: "unlocated-products-frame" } do %>
                      <i class="fas fa-times"></i>
                    <% end %>
                  <% end %>
                </div>
              </div>
              <div class="col-md-4">
                <div class="input-group input-group-sm">
                  <span class="input-group-text"><i class="fas fa-sort"></i></span>
                  <%= select_tag :sort, options_for_select([
                    ['Nombre A-Z', 'name'],
                    ['Más piezas ↓', 'count_desc'],
                    ['Menos piezas ↑', 'count_asc']
                  ], @sort), class: 'form-select', onchange: 'this.form.requestSubmit()' %>
                </div>
              </div>
              <div class="col-md-2 text-end">
                <button type="submit" class="btn btn-sm btn-primary w-100">
                  <i class="fas fa-filter"></i> Filtrar
                </button>
              </div>
            <% end %>
          </turbo-frame>
        </div>

        <%# Tabla de productos (turbo frame para búsqueda sin recargar) %>
        <turbo-frame id="unlocated-products-frame">
          <div class="card-body p-0">
            <% if @products.any? %>
              <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                <table class="table table-hover mb-0">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th width="40"></th>
                      <th>Producto</th>
                      <th width="100" class="text-center">Sin Ubicar</th>
                      <th width="200" class="text-center">Agregar al Carrito</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @products.each do |product| %>
                      <% unlocated_count = @products_data[product.id] || 0 %>
                      <tr id="product-row-<%= product.id %>"
                          data-bulk-location-assign-target="productGroup"
                          data-product-id="<%= product.id %>"
                          data-product-name="<%= product.product_name %>"
                          data-product-sku="<%= product.product_sku %>"
                          data-unlocated-count="<%= unlocated_count %>">
                        <td>
                          <button type="button"
                                  class="btn btn-sm btn-link p-0 toggle-btn"
                                  data-action="click->bulk-location-assign#toggleGroup"
                                  data-url="<%= admin_inventory_unlocated_items_path(product_id: product.id) %>">
                            <i class="fas fa-chevron-right toggle-icon"></i>
                          </button>
                        </td>
                        <td>
                          <div class="d-flex align-items-center">
                            <% if product.product_images.attached? %>
                              <%= image_tag product.product_images.first.variant(resize_to_limit: [36, 36]), class: 'me-2 rounded' %>
                            <% else %>
                              <div class="me-2 bg-secondary rounded d-flex align-items-center justify-content-center" style="width:36px;height:36px;">
                                <i class="fas fa-image text-white small"></i>
                              </div>
                            <% end %>
                            <div>
                              <strong class="small"><%= product.product_name %></strong>
                              <br><small class="text-muted"><%= product.product_sku %></small>
                            </div>
                          </div>
                        </td>
                        <td class="text-center">
                          <span id="product-unlocated-count-<%= product.id %>"
                                class="badge bg-warning text-dark"><%= unlocated_count %></span>
                        </td>
                        <td class="text-center">
                          <div class="input-group input-group-sm" style="max-width: 170px; margin: 0 auto;">
                            <input type="number"
                                   class="form-control form-control-sm text-center"
                                   min="1"
                                   max="<%= unlocated_count %>"
                                   value="<%= unlocated_count %>"
                                   data-bulk-location-assign-target="quantityInput">
                            <button type="button"
                                    class="btn btn-outline-success btn-sm"
                                    title="Agregar al carrito"
                                    data-action="click->bulk-location-assign#addToCart">
                              <i class="fas fa-plus"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr id="product-detail-row-<%= product.id %>" class="detail-row" style="display: none;">
                        <td colspan="4" class="p-0 border-0">
                          <div class="product-group-content ms-4">
                            <div class="detail-content p-2 text-center text-muted">
                              <i class="fas fa-spinner fa-spin"></i> Cargando...
                            </div>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>

              <%# Paginación %>
              <% if @total_pages && @total_pages > 1 %>
                <div class="card-footer bg-light py-2">
                  <nav>
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                      <% if @current_page > 1 %>
                        <li class="page-item">
                          <%= link_to admin_inventory_unlocated_path(page: @current_page - 1, q: @q, sort: @sort),
                                      class: 'page-link', data: { turbo_frame: "unlocated-products-frame" } do %>
                            <i class="fas fa-chevron-left"></i>
                          <% end %>
                        </li>
                      <% end %>

                      <% start_page = [1, @current_page - 2].max %>
                      <% end_page = [@total_pages, @current_page + 2].min %>

                      <% if start_page > 1 %>
                        <li class="page-item">
                          <%= link_to '1', admin_inventory_unlocated_path(page: 1, q: @q, sort: @sort),
                                      class: 'page-link', data: { turbo_frame: "unlocated-products-frame" } %>
                        </li>
                        <% if start_page > 2 %>
                          <li class="page-item disabled"><span class="page-link">...</span></li>
                        <% end %>
                      <% end %>

                      <% (start_page..end_page).each do |page| %>
                        <li class="page-item <%= 'active' if page == @current_page %>">
                          <%= link_to page, admin_inventory_unlocated_path(page: page, q: @q, sort: @sort),
                                      class: 'page-link', data: { turbo_frame: "unlocated-products-frame" } %>
                        </li>
                      <% end %>

                      <% if end_page < @total_pages %>
                        <% if end_page < @total_pages - 1 %>
                          <li class="page-item disabled"><span class="page-link">...</span></li>
                        <% end %>
                        <li class="page-item">
                          <%= link_to @total_pages, admin_inventory_unlocated_path(page: @total_pages, q: @q, sort: @sort),
                                      class: 'page-link', data: { turbo_frame: "unlocated-products-frame" } %>
                        </li>
                      <% end %>

                      <% if @current_page < @total_pages %>
                        <li class="page-item">
                          <%= link_to admin_inventory_unlocated_path(page: @current_page + 1, q: @q, sort: @sort),
                                      class: 'page-link', data: { turbo_frame: "unlocated-products-frame" } do %>
                            <i class="fas fa-chevron-right"></i>
                          <% end %>
                        </li>
                      <% end %>
                    </ul>
                  </nav>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-5">
                <% if @q.present? %>
                  <i class="fas fa-search fa-3x text-muted mb-3"></i>
                  <h5>No se encontraron productos</h5>
                  <p class="text-muted small">No hay productos que coincidan con "<%= @q %>"</p>
                  <%= link_to 'Limpiar búsqueda', admin_inventory_unlocated_path,
                              class: 'btn btn-sm btn-outline-primary',
                              data: { turbo_frame: "unlocated-products-frame" } %>
                <% else %>
                  <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                  <h5>¡Todo ubicado!</h5>
                  <p class="text-muted small">No hay piezas pendientes de asignar ubicación.</p>
                <% end %>
              </div>
            <% end %>
          </div>
        </turbo-frame>
      </div>
    </div>

    <%# ── COLUMNA DERECHA: Carrito de asignación ── %>
    <div class="col-lg-4 mb-3">
      <div class="card border-success h-100">
        <div class="card-header bg-success text-white py-2">
          <i class="fas fa-shopping-cart me-1"></i>
          <strong>Paso 3:</strong> Carrito de Asignación
          <span id="cart-badge" data-bulk-location-assign-target="cartBadge"
                class="badge bg-white text-success ms-1">0</span>
        </div>
        <div class="card-body p-0">
          <%# Lista de items en el carrito %>
          <div id="cart-items" data-bulk-location-assign-target="cartList"
               style="max-height: 50vh; overflow-y: auto;">
            <div class="text-center text-muted py-4" id="cart-empty-state"
                 data-bulk-location-assign-target="cartEmpty">
              <i class="fas fa-cart-plus fa-2x mb-2 d-block"></i>
              <small>Agrega piezas desde la tabla de la izquierda</small>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-muted">Total piezas:</small>
            <span class="fw-bold fs-5" data-bulk-location-assign-target="counter" id="bulk-assign-counter">0</span>
          </div>
          <button type="button"
                  class="btn btn-success w-100"
                  data-bulk-location-assign-target="submitBtn"
                  data-action="click->bulk-location-assign#submitAssignment"
                  disabled>
            <i class="fas fa-check me-1"></i> Asignar Todo a Ubicación
          </button>
          <button type="button"
                  class="btn btn-outline-secondary w-100 mt-1 btn-sm"
                  data-action="click->bulk-location-assign#clearCart"
                  data-bulk-location-assign-target="clearCartBtn"
                  style="display: none;">
            <i class="fas fa-trash me-1"></i> Vaciar Carrito
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
