<div class="container mt-3" data-controller="bulk-location-assign">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3><i class="fas fa-map-marker-alt"></i> Inventario Sin Ubicación</h3>
      <p class="text-muted mb-0">
        Asigna ubicación a piezas de inventario que aún no tienen ubicación asignada.
        <span class="badge bg-warning text-dark ms-2">
          <i class="fas fa-box"></i> <%= @total_unlocated %> piezas sin ubicar
        </span>
      </p>
    </div>
    <div>
      <%= link_to admin_inventory_path, class: 'btn btn-outline-secondary' do %>
        <i class="fas fa-arrow-left"></i> Volver a Inventario
      <% end %>
    </div>
  </div>

  <% if @products.any? %>
    <%= form_with url: admin_inventory_bulk_assign_location_path, method: :post, data: { action: "submit->bulk-location-assign#prepareSubmit" } do |f| %>
      <!-- Panel de ubicación destino -->
      <div class="card mb-3">
        <div class="card-header bg-primary text-white">
          <i class="fas fa-crosshairs"></i> Ubicación Destino
        </div>
        <div class="card-body">
          <div class="row align-items-end">
            <div class="col-md-8">
              <label class="form-label fw-bold">Buscar ubicación por código o nombre:</label>
              <div class="position-relative"
                   data-controller="location-suggest"
                   data-location-suggest-url-value="<%= search_admin_inventory_locations_path %>">
                <input type="text"
                       class="form-control form-control-lg"
                       placeholder="Ej: PRINCIPAL, ESTANTE-A, BOD..."
                       data-location-suggest-target="input"
                       data-action="input->location-suggest#input keydown->location-suggest#keydown"
                       autocomplete="off">
                <input type="hidden"
                       name="inventory_location_id"
                       data-location-suggest-target="hidden"
                       data-bulk-location-assign-target="locationInput"
                       data-action="change->bulk-location-assign#locationSelected">
                <div data-location-suggest-target="results" class="position-relative"></div>
                <div data-location-suggest-target="hint" class="form-text mt-2"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex align-items-center justify-content-between bg-light p-3 rounded">
                <div>
                  <small class="text-muted d-block">Piezas a asignar:</small>
                  <span class="fs-3 fw-bold" data-bulk-location-assign-target="counter">0</span>
                </div>
                <button type="submit"
                        class="btn btn-success btn-lg"
                        data-bulk-location-assign-target="submitBtn"
                        disabled>
                  <i class="fas fa-check"></i> Asignar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de productos -->
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <div>
            <i class="fas fa-cubes"></i>
            <strong><%= @products.count %></strong> productos con inventario sin ubicar
          </div>
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-secondary" data-action="click->bulk-location-assign#expandAll">
              <i class="fas fa-expand-alt"></i> Expandir
            </button>
            <button type="button" class="btn btn-outline-secondary" data-action="click->bulk-location-assign#collapseAll">
              <i class="fas fa-compress-alt"></i> Colapsar
            </button>
          </div>
        </div>

        <div class="card-body p-0">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th width="40">
                  <input type="checkbox"
                         class="form-check-input"
                         data-bulk-location-assign-target="selectAll"
                         data-action="change->bulk-location-assign#toggleSelectAll">
                </th>
                <th width="40"></th>
                <th>Producto</th>
                <th width="120" class="text-center">Sin Ubicar</th>
                <th width="200" class="text-center">Cantidad a Asignar</th>
              </tr>
            </thead>
            <tbody>
              <% @products.each do |product| %>
                <% unlocated_count = @products_data[product.id] || 0 %>
                <tr data-bulk-location-assign-target="productGroup" data-product-id="<%= product.id %>">
                  <td>
                    <input type="checkbox"
                           class="form-check-input"
                           data-bulk-location-assign-target="checkbox"
                           data-action="change->bulk-location-assign#checkboxChanged">
                  </td>
                  <td>
                    <button type="button"
                            class="btn btn-sm btn-link p-0"
                            data-action="click->bulk-location-assign#toggleGroup">
                      <i class="fas fa-chevron-right toggle-icon"></i>
                    </button>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <% if product.product_images.attached? %>
                        <%= image_tag product.product_images.first.variant(resize_to_limit: [40, 40]), class: 'me-2 rounded' %>
                      <% else %>
                        <div class="me-2 bg-secondary rounded d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                          <i class="fas fa-image text-white"></i>
                        </div>
                      <% end %>
                      <div>
                        <strong><%= product.product_name %></strong>
                        <br><small class="text-muted"><%= product.product_sku %></small>
                      </div>
                    </div>
                  </td>
                  <td class="text-center">
                    <span class="badge bg-warning text-dark fs-6"><%= unlocated_count %></span>
                  </td>
                  <td class="text-center">
                    <div class="input-group input-group-sm" style="max-width: 180px; margin: 0 auto;">
                      <button type="button"
                              class="btn btn-outline-secondary"
                              title="Limpiar"
                              data-action="click->bulk-location-assign#clearQuantity">
                        <i class="fas fa-times"></i>
                      </button>
                      <input type="number"
                             name="assignments[<%= product.id %>]"
                             class="form-control text-center"
                             min="0"
                             max="<%= unlocated_count %>"
                             value="0"
                             data-bulk-location-assign-target="quantityInput"
                             data-action="input->bulk-location-assign#quantityChanged">
                      <button type="button"
                              class="btn btn-outline-primary"
                              title="Asignar todo"
                              data-action="click->bulk-location-assign#assignAll">
                        <i class="fas fa-check-double"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <!-- Fila colapsable con detalles del inventario -->
                <tr>
                  <td colspan="5" class="p-0 border-0">
                    <div class="product-group-content collapsed" style="display: none;">
                      <div class="bg-light p-3 ms-5">
                        <h6 class="text-muted mb-2">
                          <i class="fas fa-list"></i> Detalle de piezas sin ubicar
                        </h6>
                        <% items = product.inventories.includes(:purchase_order).where(status: %i[available reserved], inventory_location_id: nil).order(:created_at).limit(20) %>
                        <div class="table-responsive">
                          <table class="table table-sm table-bordered mb-0">
                            <thead>
                              <tr>
                                <th>ID</th>
                                <th>Status</th>
                                <th>Costo</th>
                                <th>Orden de Compra</th>
                                <th>Fecha Creación</th>
                              </tr>
                            </thead>
                            <tbody>
                              <% items.each do |inv| %>
                                <tr>
                                  <td><code>#<%= inv.id %></code></td>
                                  <td>
                                    <span class="badge bg-<%= inv.status == 'available' ? 'success' : 'info' %>">
                                      <%= inv.status %>
                                    </span>
                                  </td>
                                  <td><%= number_to_currency(inv.purchase_cost, unit: '$') %></td>
                                  <td>
                                    <% if inv.purchase_order %>
                                      <%= link_to inv.purchase_order.order_number, admin_purchase_order_path(inv.purchase_order), target: '_blank' %>
                                    <% else %>
                                      <span class="text-muted">-</span>
                                    <% end %>
                                  </td>
                                  <td><%= inv.created_at.strftime('%d/%m/%Y %H:%M') %></td>
                                </tr>
                              <% end %>
                            </tbody>
                          </table>
                        </div>
                        <% if unlocated_count > 20 %>
                          <small class="text-muted mt-2 d-block">
                            Mostrando 20 de <%= unlocated_count %> piezas
                          </small>
                        <% end %>
                      </div>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
        <h4>¡Todo el inventario tiene ubicación!</h4>
        <p class="text-muted">No hay piezas de inventario pendientes de asignar ubicación.</p>
        <%= link_to 'Ver Inventario', admin_inventory_path, class: 'btn btn-primary' %>
        <%= link_to 'Ver Ubicaciones', admin_inventory_locations_path, class: 'btn btn-outline-secondary' %>
      </div>
    </div>
  <% end %>
</div>
