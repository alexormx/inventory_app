<div class="container-fluid px-0">
  <!-- Fallback CSS si no está Bootstrap JS -->
  <style>
    [data-controller="simple-tabs"] .tab-pane { display:none; }
    [data-controller="simple-tabs"] .tab-pane.active { display:block; }
  </style>
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <h1 class="h5 mb-0 d-flex align-items-center">
      <i class="fa fa-sliders me-2 text-secondary"></i>
      <span>System Introspection</span>
    </h1>
    <div class="d-flex gap-2">
      <span class="badge text-bg-light align-self-center">Schema tables: <%= @schema_report[:tables].size %></span>
      <span class="badge text-bg-light align-self-center">Models: <%= @model_report[:models].size %></span>
  <%= link_to 'Settings', admin_settings_path, class: 'btn btn-outline-secondary btn-sm' %>
  <%= button_to 'Regenerar Schema Docs', admin_system_variables_generate_schema_docs_path, method: :post, class: 'btn btn-warning btn-sm', data: { controller: 'confirm', action: 'click->confirm#ask', confirm_message: '¿Regenerar placeholders en schema_docs.yml? (No borra descripciones existentes)' } %>
    </div>
  </div>

  <!-- Instrucciones de mantenimiento / actualización de la información -->
  <div class="alert alert-info py-2 px-3 small mb-4" role="alert">
    <strong>Cómo actualizar esta información</strong>
    <details class="mt-1">
      <summary class="pointer">Ver pasos</summary>
      <div class="mt-2">
        <ol class="mb-2 ps-3">
          <li><strong>Agregar / cambiar columnas o tablas:</strong> crea la migración normalmente.</li>
          <li><strong>Regenerar placeholders del diccionario:</strong> <code>bin/rails introspection:generate_schema_docs</code></li>
          <li><strong>Editar descripciones:</strong> abrir <code>db/schema_docs.yml</code> y reemplazar los <code>TODO:</code>.</li>
          <li><strong>Ver progreso:</strong> <code>bin/rails introspection:dictionary_progress</code></li>
          <li><strong>(Opcional Postgres) Aplicar comentarios a la BD:</strong> <code>bin/rails introspection:apply_comments</code></li>
          <li><strong>Refrescar esta página:</strong> simplemente recarga (no necesita reinicio si cambiaste sólo el YAML).</li>
          <li><strong>ENV Usage:</strong> se recalcula al recargar; elimina claves obsoletas del código para que desaparezcan.</li>
        </ol>
        <p class="mb-1">Prioriza describir: tablas de negocio crítico (orders, products), campos monetarios (unidades / cents) y flags lógicos.</p>
        <p class="mb-0">Precaución: no guardes secretos en <code>schema_docs.yml</code> (repositorio).</p>
      </div>
    </details>
  </div>

  <div data-controller="simple-tabs">
  <ul class="nav nav-tabs small" id="sysVarsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button id="tab-overview-btn" class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-overview" type="button" role="tab" aria-controls="tab-overview" aria-selected="true" data-simple-tabs-target="button">Overview</button>
    </li>
    <li class="nav-item" role="presentation">
      <button id="tab-schema-btn" class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-schema" type="button" role="tab" aria-controls="tab-schema" aria-selected="false" data-simple-tabs-target="button">DB Schema</button>
    </li>
    <li class="nav-item" role="presentation">
      <button id="tab-models-btn" class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-models" type="button" role="tab" aria-controls="tab-models" aria-selected="false" data-simple-tabs-target="button">Models</button>
    </li>
    <li class="nav-item" role="presentation">
      <button id="tab-envusage-btn" class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-envusage" type="button" role="tab" aria-controls="tab-envusage" aria-selected="false" data-simple-tabs-target="button">ENV Usage</button>
    </li>
    <li class="nav-item" role="presentation">
      <button id="tab-settings-btn" class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-settings" type="button" role="tab" aria-controls="tab-settings" aria-selected="false" data-simple-tabs-target="button">Settings & Flags</button>
    </li>
  </ul>
  <div class="tab-content border border-top-0 p-3 bg-white rounded-bottom" id="sysVarsTabsContent">
    <!-- Overview Tab -->
  <div class="tab-pane fade show active" id="tab-overview" role="tabpanel" aria-labelledby="tab-overview-btn" data-simple-tabs-target="panel">
      <div class="row g-3 row-cols-1 row-cols-xl-2 align-items-stretch">
        <div class="col">
          <div class="card h-100 shadow-sm">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
              <strong>ENV (filtrado)</strong>
              <span class="badge text-bg-light"><%= @env_vars.size %></span>
            </div>
            <div class="card-body p-0 small" style="max-height:300px; overflow:auto;">
              <table class="table table-sm table-hover mb-0 align-middle">
                <tbody>
                  <% @env_vars.each do |k,v| %>
                    <tr>
                      <th scope="row" class="text-nowrap"><code><%= k %></code></th>
                      <td class="text-muted"><div class="text-truncate" style="max-width:380px"><%= v %></div></td>
                    </tr>
                  <% end %>
                  <% if @env_vars.blank? %>
                    <tr><td colspan="2" class="text-center text-muted">Sin variables</td></tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card h-100 shadow-sm">
            <div class="card-header py-2"><strong>Runtime Info</strong></div>
            <div class="card-body p-0 small">
              <table class="table table-sm mb-0">
                <tbody>
                  <% @runtime_info.each do |k,v| %>
                    <tr><th class="text-nowrap"><%= k %></th><td><%= v %></td></tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-12">
          <div class="card shadow-sm mt-3">
            <div class="card-header py-2"><strong>Rails Config (subset)</strong></div>
            <div class="card-body p-0 small">
              <table class="table table-sm mb-0">
                <tbody>
                  <% @rails_config.each do |k,v| %>
                    <tr><th class="text-nowrap"><%= k %></th><td><%= v %></td></tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Schema Tab -->
    <div class="tab-pane fade" id="tab-schema" role="tabpanel" aria-labelledby="tab-schema-btn" data-simple-tabs-target="panel">
      <div class="accordion" id="schemaAccordion" data-controller="simple-accordion">
        <% @schema_report[:tables].each_with_index do |t, idx| %>
          <div class="accordion-item mb-2 border rounded">
            <h2 class="accordion-header mb-0" id="heading-schema-<%= idx %>">
              <button class="accordion-button collapsed py-2 w-100 text-start bg-light" type="button" data-action="click->simple-accordion#toggle" data-simple-accordion-target="button" data-target-id="collapse-schema-<%= idx %>">
                <code><%= t[:name] %></code>
                <span class="ms-2 badge text-bg-light"><%= t[:columns]&.size %> cols</span>
              </button>
            </h2>
            <div id="collapse-schema-<%= idx %>" class="accordion-collapse" data-simple-accordion-target="panel">
              <div class="accordion-body small p-3">
                <% if t[:error] %>
                  <p class="text-danger">Error: <%= t[:error] %></p>
                <% else %>
                  <strong>Columns</strong>
                  <% if t[:comment].present? %>
                    <p class="text-muted small mb-1"><em><%= t[:comment] %></em></p>
                  <% end %>
                  <table class="table table-sm mb-3">
                    <thead><tr><th>name</th><th>type</th><th>null</th><th>default</th><th>idx</th><th>fk</th><th>comment</th></tr></thead>
                    <tbody>
                      <% t[:columns].each do |c| %>
                        <tr>
                          <td><code><%= c[:name] %></code></td>
                          <td><%= c[:type] %></td>
                          <td><%= c[:null] %></td>
                          <td><%= c[:default].inspect %></td>
                          <td><%= c[:indexed] ? '✔' : '' %></td>
                          <td><%= c[:foreign_key] ? c[:foreign_key] : '' %></td>
                          <td class="text-muted"><%= c[:comment] %></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <strong>Indexes</strong>
                      <% if t[:indexes].blank? %><p class="text-muted">(none)</p><% else %>
                        <ul class="list-unstyled mb-0">
                          <% t[:indexes].each do |ix| %>
                            <li>
                              <code><%= ix[:name] %></code> → <%= Array(ix[:columns]).join(', ') %>
                              <%= '(unique)' if ix[:unique] %>
                            </li>
                          <% end %>
                        </ul>
                      <% end %>
                    </div>
                    <div class="col-md-6">
                      <strong>Foreign Keys</strong>
                      <% if t[:foreign_keys].blank? %><p class="text-muted">(none)</p><% else %>
                        <ul class="list-unstyled mb-0">
                          <% t[:foreign_keys].each do |fk| %>
                            <li><code><%= fk[:column] %></code> → <%= fk[:to_table] %> (<%= fk[:on_delete] || 'no action' %>)</li>
                          <% end %>
                        </ul>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Models Tab -->
    <div class="tab-pane fade" id="tab-models" role="tabpanel" aria-labelledby="tab-models-btn" data-simple-tabs-target="panel">
      <div class="accordion" id="modelsAccordion" data-controller="simple-accordion">
        <% @model_report[:models].each_with_index do |m, idx| %>
          <div class="accordion-item mb-2 border rounded">
            <h2 class="accordion-header mb-0" id="heading-model-<%= idx %>">
              <button class="accordion-button collapsed py-2 w-100 text-start bg-light" type="button" data-action="click->simple-accordion#toggle" data-simple-accordion-target="button" data-target-id="collapse-model-<%= idx %>">
                <code><%= m[:name] %></code>
                <span class="ms-2 text-muted small"><%= m[:table] %></span>
              </button>
            </h2>
            <div id="collapse-model-<%= idx %>" class="accordion-collapse" data-simple-accordion-target="panel">
              <div class="accordion-body small p-3">
                <% if m[:error] %>
                  <p class="text-danger">Error: <%= m[:error] %></p>
                <% else %>
                  <div class="mb-2"><strong>Columns</strong></div>
                  <% if m[:table_comment].present? %>
                    <p class="text-muted small mb-1"><em><%= m[:table_comment] %></em></p>
                  <% end %>
                  <table class="table table-sm mb-3">
                    <thead><tr><th>name</th><th>type</th><th>null</th><th>default</th><th>comment</th></tr></thead>
                    <tbody>
                      <% m[:columns].each do |c| %>
                        <tr>
                          <td><code><%= c[:name] %></code></td>
                          <td><%= c[:type] %></td>
                          <td><%= c[:null] %></td>
                          <td><%= c[:default].inspect %></td>
                          <td class="text-muted"><%= c[:comment] %></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <strong>Associations</strong>
                      <% if m[:associations].blank? %><p class="text-muted">(none)</p><% else %>
                        <% m[:associations].each do |macro, refs| %>
                          <div class="mb-2"><em><%= macro %></em>
                            <ul class="list-unstyled ms-2 mb-0">
                              <% refs.each do |r| %>
                                <li><code><%= r[:name] %></code> → <%= r[:class_name] %> <%= "(through: #{r[:options][:through]})" if r[:options][:through] %></li>
                              <% end %>
                            </ul>
                          </div>
                        <% end %>
                      <% end %>
                    </div>
                    <div class="col-md-6">
                      <strong>Validations</strong>
                      <% if m[:validations].blank? %><p class="text-muted">(none)</p><% else %>
                        <ul class="list-unstyled mb-0">
                          <% m[:validations].each do |v| %>
                            <li><code><%= v[:attributes].join(', ') %></code> → <%= v[:kind] %></li>
                          <% end %>
                        </ul>
                      <% end %>
                      <div class="mt-3">
                        <strong>Enums</strong>
                        <% if m[:enums].blank? %><p class="text-muted">(none)</p><% else %>
                          <ul class="list-unstyled mb-0">
                            <% m[:enums].each do |ek, ev| %>
                              <li><code><%= ek %></code>: <%= ev.keys.join(', ') %></li>
                            <% end %>
                          </ul>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- ENV Usage Tab -->
  <div class="tab-pane fade" id="tab-envusage" role="tabpanel" aria-labelledby="tab-envusage-btn" data-simple-tabs-target="panel">
      <div class="d-flex justify-content-between align-items-center mb-2 small">
        <div>
          Referenced keys: <strong><%= @env_usage_report[:total] %></strong> · Missing: <strong><%= @env_usage_report[:missing].size %></strong>
        </div>
      </div>
      <div class="table-responsive" style="max-height:480px;">
        <table class="table table-sm table-hover align-middle mb-0 small">
          <thead class="table-light">
            <tr><th>Key</th><th>Present?</th><th>Value Preview</th><th>Files</th></tr>
          </thead>
          <tbody>
            <% @env_usage_report[:keys].each do |k| %>
              <tr class="<%= 'table-warning' unless k[:present] %>">
                <td><code><%= k[:key] %></code></td>
                <td><%= k[:present] ? '✔' : '✖' %></td>
                <td><%= k[:value_preview] || '-' %></td>
                <td class="text-muted"><div class="text-truncate" style="max-width:320px"><%= k[:referenced_in].join(', ') %></div></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Settings & Flags Tab -->
  <div class="tab-pane fade" id="tab-settings" role="tabpanel" aria-labelledby="tab-settings-btn" data-simple-tabs-target="panel">
      <div class="row g-3 row-cols-1 row-cols-lg-2">
        <div class="col">
          <div class="card h-100 shadow-sm">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
              <strong>Site Settings (DB)</strong>
              <span class="badge text-bg-light"><%= @site_settings.size %></span>
            </div>
            <div class="card-body p-0 small" style="max-height:300px; overflow:auto;">
              <table class="table table-sm mb-0 align-middle">
                <tbody>
                  <% @site_settings.each do |s| %>
                    <tr>
                      <th scope="row" class="text-nowrap"><code><%= s.key %></code></th>
                      <td><span class="badge text-bg-light"><%= s.value %></span></td>
                    </tr>
                  <% end %>
                  <% if @site_settings.blank? %>
                    <tr><td colspan="2" class="text-center text-muted">Sin settings</td></tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card h-100 shadow-sm">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
              <strong>Dynamic Flags</strong>
              <span class="badge text-bg-light"><%= @dynamic_flags.size %></span>
            </div>
            <div class="card-body p-0 small" style="max-height:300px; overflow:auto;">
              <table class="table table-sm mb-0">
                <tbody>
                  <% @dynamic_flags.each do |k,v| %>
                    <tr><th class="text-nowrap"><%= k %></th><td><code><%= v %></code></td></tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <p class="text-muted small mt-3 mb-0">* Valores sensibles omitidos en la lista ENV filtrada y previsualizaciones enmascaradas. Reportes cacheados unos minutos para rendimiento.</p>
</div>
