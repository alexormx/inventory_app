<%# Partial de fila de item en carrito - locals: product, quantity, cart %>
<tr id="cart_item_<%= product.id %>" data-controller="cart-item" data-cart-item-product-id-value="<%= product.id %>">
  <th scope="row">
    <div class="d-flex align-items-center gap-2">
  <% if product.product_images.attached? %>
    <%= responsive_attachment_image product.product_images.first,
      alt: product.product_name,
      widths: [40,50,64],
      css_class: 'img-thumbnail',
      square: true %>
  <% else %>
        <div class="rounded bg-light border d-flex align-items-center justify-content-center" style="width:50px;height:50px;font-size:.8rem;">ğŸ“¦</div>
      <% end %>
      <div class="d-flex flex-column">
        <strong class="small mb-0"><%= product.product_name %></strong>
  <% on_hand = product.current_on_hand %>
  <div class="small mt-1"><%= stock_badge(product, quantity: quantity, suppress_pending_note: true) %></div>
        <% if (eta = stock_eta(product)) %>
          <div class="small text-muted"><i class="fa fa-clock me-1"></i><%= eta %></div>
        <% end %>
        <% split = product.split_immediate_and_pending(quantity) %>
  <%# Se omite badge adicional de preventa para evitar duplicaciÃ³n; posiciÃ³n podrÃ­a mostrarse en tooltip futuro %>
      </div>
    </div>
  </th>
  <td class="text-center">
    <div class="input-group input-group-sm justify-content-center cart-qty-group" style="max-width: 140px;">
      <button class="btn btn-outline-secondary px-2" type="button" aria-label="Disminuir" data-action="click->cart-item#decrease">âˆ’</button>
      <input type="number" min="1" class="form-control text-center px-1" value="<%= quantity %>" data-cart-item-target="quantity" data-action="change->cart-item#quantityChanged" style="width: 50px;" aria-label="Cantidad">
  <% disabled_increase = (on_hand <= quantity.to_i && !product.oversell_allowed?) %>
  <button class="btn btn-outline-secondary px-2 <%= 'disabled' if disabled_increase %>" type="button" aria-label="Aumentar" data-action="click->cart-item#increase" <%= 'disabled' if disabled_increase %>>+</button>
    </div>
  </td>
  <td class="text-end"><%= number_to_currency(product.selling_price) %></td>
  <td class="text-end" data-cart-item-target="lineTotal" aria-live="polite">
    <% split ||= product.split_immediate_and_pending(quantity) %>
    <%= number_to_currency(product.selling_price * quantity) %>
    <% if split[:pending].positive? %>
      <div class="small text-muted mt-1">
        <%= split[:immediate] %> inmediata(s) Â· <%= split[:pending] %> <%= split[:pending_type] == :preorder ? 'preventa' : 'sobre pedido' %>
      </div>
    <% end %>
  </td>
  <td class="text-end">
  <%= button_to cart_item_path(product), method: :delete, params: { product_id: product.id }, class: 'btn btn-sm btn-link text-danger p-0', title: 'Eliminar', aria: { label: 'Eliminar producto' }, form: { data: { controller: 'confirm', action: 'submit->confirm#ask', confirm_message_value: 'Â¿Eliminar este producto?' }, class: 'd-inline' } do %>
      <i class="fas fa-trash"></i><span class="visually-hidden">Eliminar</span>
    <% end %>
  </td>
</tr>
