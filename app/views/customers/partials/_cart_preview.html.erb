<% cart_obj = (defined?(@cart) && @cart.present?) ? @cart : Cart.new(session) %>
<div id="cart-preview" class="cart-preview" data-cart-preview hidden aria-live="polite" aria-label="Mini vista del carrito" <%= 'data-auto-peek="true"' if local_assigns[:auto_peek] %>>
  <div class="cart-preview-header d-flex justify-content-between align-items-center mb-2">
    <strong>Carrito</strong>
    <a href="<%= cart_path %>" class="small text-decoration-none">Ver todo</a>
  </div>
  <% if cart_obj.items.any? %>
    <ul class="list-unstyled mb-2">
      <% cart_obj.items.first(5).each do |product, qty| %>
        <li class="d-flex align-items-center mb-2 cart-preview-item" id="cart_item_<%= product.id %>">
          <div class="me-2 flex-shrink-0">
            <% if product.product_images.attached? %>
              <%= image_tag product.product_images.first.variant(resize_to_fill: [40,40]), alt: product.product_name, class: 'rounded border cart-preview-thumb' %>
            <% else %>
              <div class="cart-preview-thumb placeholder d-flex align-items-center justify-content-center rounded border"> <i class="fas fa-box-open text-muted"></i></div>
            <% end %>
          </div>
          <div class="flex-grow-1 me-2">
            <div class="fw-medium small line-clamp-1"><%= product.product_name %></div>
            <div class="text-muted small d-flex align-items-center gap-2">
              <%= form_with url: cart_item_path(product), method: :patch, data: { turbo_frame: "_top" }, class: 'd-inline-flex align-items-center cart-mini-qty-form' do %>
                <input type="hidden" name="product_id" value="<%= product.id %>">
                <button class="btn btn-sm btn-outline-secondary px-1 py-0 cart-mini-decrease" name="quantity" value="<%= qty - 1 %>" <%= 'disabled' if qty <= 1 %> aria-label="Disminuir cantidad">−</button>
                <span class="mx-1 small" aria-live="polite"><%= qty %></span>
                <button class="btn btn-sm btn-outline-secondary px-1 py-0 cart-mini-increase" name="quantity" value="<%= qty + 1 %>" aria-label="Aumentar cantidad">+</button>
              <% end %>
              <span>· <%= number_to_currency(product.selling_price * qty) %></span>
            </div>
          </div>
          <div class="d-flex flex-column align-items-end gap-1">
            <div class="small fw-semibold text-nowrap"><%= number_to_currency(product.selling_price) %></div>
            <%= button_to cart_item_path(product), method: :delete, params: { product_id: product.id }, form: { class: 'm-0 p-0' }, class: 'btn btn-sm btn-link text-danger p-0 small', title: 'Eliminar', aria: { label: 'Eliminar producto del carrito' } do %>
              <i class="fas fa-times"></i>
            <% end %>
          </div>
        </li>
      <% end %>
    </ul>
    <% if cart_obj.items.size > 5 %>
      <div class="small text-muted mb-2">+ <%= cart_obj.items.size - 5 %> más</div>
    <% end %>
    <div class="d-flex justify-content-between align-items-center border-top pt-2">
      <span class="small text-muted">Total</span>
      <strong><%= number_to_currency(cart_obj.total) %></strong>
    </div>
    <div class="mt-2">
      <%= link_to 'Ir al carrito / Checkout', cart_path, class: 'btn btn-sm btn-primary w-100', data: { turbo_frame: '_top' } %>
    </div>
  <% else %>
    <div class="text-muted small">Carrito vacío</div>
  <% end %>
</div>
