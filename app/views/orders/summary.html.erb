<%# Resumen compacto de pedido para enviar totales al cliente %>
<h1 class="h5 mb-3">Resumen de Pedido <%= @order.id %></h1>

<div class="mb-2 small text-muted">Fecha: <%= l(@order.order_date, format: :long) %></div>

<table class="table table-sm table-bordered align-middle mb-3 order-summary-table">
  <thead class="table-primary text-dark">
    <tr>
      <th style="width:55px">Cantid.</th>
      <th>Producto</th>
      <th style="width:100px" class="text-end">Costo unit</th>
      <th style="width:110px" class="text-end">Costo Total</th>
    </tr>
  </thead>
  <tbody>
    <% total = 0 %>
    <% @order.sale_order_items.includes(product: [product_images_attachments: :blob]).each do |item| %>
      <% prod = item.product %>
      <% line_total = item.total_line_cost %>
      <% total += line_total %>
      <tr>
        <td class="text-center"><%= item.quantity %></td>
        <td>
          <div class="d-flex align-items-center gap-2">
            <% if prod&.product_images&.attached? %>
              <% image = prod.product_images.first %>
              <%= image_tag image.variant(resize_to_fill: [42,42]).processed, class: "rounded border", alt: prod.product_name %>
            <% else %>
              <div class="placeholder rounded border bg-light d-flex align-items-center justify-content-center" style="width:42px;height:42px;font-size:.6rem;">N/A</div>
            <% end %>
            <div class="flex-grow-1">
              <strong class="small d-block"><%= prod&.product_name || 'Producto eliminado' %></strong>
              <span class="text-muted extra-small"><%= prod&.product_sku %></span>
            </div>
          </div>
        </td>
        <td class="text-end"><%= number_to_currency(item.unit_final_price) %></td>
        <td class="text-end"><%= number_to_currency(line_total) %></td>
      </tr>
    <% end %>
    <tr class="table-primary fw-semibold">
      <td class="text-center"> </td>
      <td class="text-end">Sub-Total</td>
      <td class="text-end"> </td>
      <td class="text-end"><%= number_to_currency(total) %></td>
    </tr>
  </tbody>
</table>

<div class="d-flex gap-2">
  <%= link_to 'Ver detalle completo', order_path(@order), class: 'btn btn-outline-secondary btn-sm' %>
  <%= link_to 'Volver a mis pedidos', orders_path, class: 'btn btn-outline-primary btn-sm' %>
</div>

<style>
.order-summary-table thead th { font-size:.75rem; letter-spacing:.5px; }
.order-summary-table tbody td { font-size:.8rem; }
.order-summary-table .extra-small { font-size:.65rem; }
</style>