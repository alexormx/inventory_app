<div class="checkout-progress mb-3">
  <div class="progress" style="height:6px;">
    <div class="progress-bar bg-primary" style="width:66%"></div>
  </div>
</div>
<h1 class="mb-3">üöö Direcci√≥n y env√≠o</h1>
<div class="mb-3 d-flex justify-content-between align-items-center">
  <h5 class="mb-0">Selecciona una direcci√≥n</h5>
  <%= link_to 'Gestionar direcciones', shipping_addresses_path(return_to: 'checkout_step2'), class: 'btn btn-sm btn-outline-secondary' %>
 </div>
<% addresses = current_user.shipping_addresses.ordered %>
<% previous_info = @shipping_info || {} %>

<%= form_with url: checkout_step2_path, method: :post, local: true, id: 'shipping-step-form' do %>
  <% if addresses.any? %>
    <div class="list-group mb-4">
      <% addresses.each do |a| %>
        <% checked = if params[:selected_address_id].present?
                       params[:selected_address_id].to_s == a.id.to_s
                     elsif previous_info[:address_id]
                       previous_info[:address_id].to_s == a.id.to_s
                     else
                       a.default?
                     end %>
        <label class="list-group-item d-flex justify-content-between align-items-start">
          <span>
            <input type="radio" name="selected_address_id" value="<%= a.id %>" <%= 'checked' if checked %> class="form-check-input me-2" />
            <strong><%= a.label %></strong>
            <% if a.default? %><span class="badge bg-success ms-1">Default</span><% end %><br>
            <small class="text-muted"><%= a.full_name %> ‚Äî <%= a.to_one_line %></small>
          </span>
          <%= link_to 'Editar', edit_shipping_address_path(a), class: 'btn btn-sm btn-outline-secondary' %>
        </label>
      <% end %>
    </div>
  <% else %>
    <div class="alert alert-warning">No tienes direcciones. Agrega una primero.</div>
    <%= link_to 'Agregar direcci√≥n', shipping_addresses_path(return_to: 'checkout_step2'), class: 'btn btn-primary' %>
  <% end %>

<h5 class="mb-2">M√©todo de env√≠o</h5>
<p class="small text-muted">Selecciona el m√©todo de env√≠o que prefieras.</p>
  <% shipping_methods = ShippingMethod.active.ordered %>
  <% selected_method = params[:shipping_method].presence || previous_info[:method].presence || shipping_methods.first&.code %>
  <div class="list-group mb-3">
    <% shipping_methods.each do |sm| %>
      <label class="list-group-item d-flex gap-3 align-items-start">
        <input type="radio" name="shipping_method" value="<%= sm.code %>" class="form-check-input mt-1" <%= 'checked' if selected_method == sm.code %>>
        <div class="flex-grow-1">
          <strong><%= sm.name %></strong>
          <% if sm.base_cost&.positive? %>
            <span class="badge bg-secondary ms-2"><%= number_to_currency(sm.base_cost) %></span>
          <% else %>
            <span class="badge bg-success ms-2">Gratis</span>
          <% end %>
          <% if sm.description.present? %>
            <br><small class="text-muted"><%= sm.description %></small>
          <% end %>
        </div>
      </label>
    <% end %>
  </div>
  <% if shipping_methods.empty? %>
    <div class="alert alert-warning">No hay m√©todos de env√≠o disponibles.</div>
  <% end %>
  <div class="text-end mt-4">
    <button type="submit" class="btn btn-primary">Continuar con el pago ‚û°Ô∏è</button>
  </div>
<% end %>
