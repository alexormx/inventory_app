<%= render 'checkouts/progress_bar', current_step: 2 %>

<div class="row">
  <div class="col-lg-8">
    <% addresses = current_user.shipping_addresses.ordered %>
    <% previous_info = @shipping_info || {} %>

    <%= form_with url: checkout_step2_path, method: :post, local: true, id: 'shipping-step-form' do %>
      <!-- Sección de Direcciones -->
      <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="fa fa-map-marker-alt me-2"></i>Dirección de envío</h6>
          <%= link_to shipping_addresses_path(return_to: 'checkout_step2'), class: 'btn btn-sm btn-outline-primary' do %>
            <i class="fa fa-plus me-1"></i> Nueva dirección
          <% end %>
        </div>
        <div class="card-body">
          <% if addresses.any? %>
            <div class="row g-3">
              <% addresses.each do |a| %>
                <% checked = if params[:selected_address_id].present?
                               params[:selected_address_id].to_s == a.id.to_s
                             elsif previous_info[:address_id]
                               previous_info[:address_id].to_s == a.id.to_s
                             else
                               a.default?
                             end %>
                <div class="col-md-6">
                  <label class="card h-100 cursor-pointer <%= 'border-primary border-2' if checked %>" style="cursor: pointer;">
                    <div class="card-body">
                      <div class="d-flex align-items-start">
                        <input type="radio" name="selected_address_id" value="<%= a.id %>" <%= 'checked' if checked %> class="form-check-input me-3 mt-1" />
                        <div class="flex-grow-1">
                          <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong><%= a.label %></strong>
                            <% if a.default? %><span class="badge bg-success">Principal</span><% end %>
                          </div>
                          <div class="text-muted small">
                            <%= a.full_name %><br>
                            <%= a.line1 %><br>
                            <%= a.city %>, <%= a.state %> <%= a.postal_code %>
                            <% if a.respond_to?(:phone) && a.phone.present? %><br><i class="fa fa-phone me-1"></i><%= a.phone %><% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="card-footer bg-transparent border-top-0 pt-0">
                      <%= link_to 'Editar', edit_shipping_address_path(a, return_to: 'checkout_step2'), class: 'btn btn-sm btn-link p-0' %>
                    </div>
                  </label>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="alert alert-warning mb-0">
              <i class="fa fa-exclamation-triangle me-2"></i>
              No tienes direcciones guardadas.
              <%= link_to 'Agrega una dirección', shipping_addresses_path(return_to: 'checkout_step2'), class: 'alert-link' %> para continuar.
            </div>
          <% end %>
        </div>
      </div>

      <!-- Sección de Métodos de Envío -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-truck me-2"></i>Método de envío</h6>
        </div>
        <div class="card-body">
          <% shipping_methods = ShippingMethod.active.ordered %>
          <% selected_method = params[:shipping_method].presence || previous_info[:method].presence || shipping_methods.first&.code %>

          <% if shipping_methods.any? %>
            <div class="d-flex flex-column gap-2">
              <% shipping_methods.each do |sm| %>
                <label class="list-group-item list-group-item-action d-flex align-items-center rounded border <%= 'border-primary border-2 bg-primary bg-opacity-10' if selected_method == sm.code %>" style="cursor: pointer;">
                  <input type="radio" name="shipping_method" value="<%= sm.code %>" class="form-check-input me-3" <%= 'checked' if selected_method == sm.code %>>
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                      <strong><%= sm.name %></strong>
                      <% if sm.base_cost&.positive? %>
                        <span class="badge bg-secondary"><%= number_to_currency(sm.base_cost) %></span>
                      <% else %>
                        <span class="badge bg-success">Gratis</span>
                      <% end %>
                    </div>
                    <% if sm.description.present? %>
                      <small class="text-muted"><%= sm.description %></small>
                    <% end %>
                  </div>
                </label>
              <% end %>
            </div>
          <% else %>
            <div class="alert alert-warning mb-0">No hay métodos de envío disponibles.</div>
          <% end %>
        </div>
      </div>

      <!-- Botones de navegación -->
      <div class="d-flex justify-content-between align-items-center">
        <%= link_to checkout_step1_path, class: 'btn btn-outline-secondary' do %>
          <i class="fa fa-arrow-left me-1"></i> Volver
        <% end %>
        <button type="submit" class="btn btn-primary btn-lg" <%= 'disabled' unless addresses.any? %>>
          Continuar con el pago →
        </button>
      </div>
    <% end %>
  </div>

  <div class="col-lg-4 mt-4 mt-lg-0">
    <% shipping_methods = ShippingMethod.active.ordered %>
    <% selected_method = params[:shipping_method].presence || (@shipping_info || {})[:method].presence || shipping_methods.first&.code %>
    <% selected_shipping = shipping_methods.find { |sm| sm.code == selected_method } %>
    <%= render 'checkouts/cart_summary',
        cart: @cart,
        show_shipping: true,
        shipping_cost: selected_shipping&.base_cost || 0,
        shipping_method_name: selected_shipping&.name %>
  </div>
</div>

<script>
  // Actualizar visual cuando se selecciona una dirección
  document.querySelectorAll('input[name="selected_address_id"]').forEach(radio => {
    radio.addEventListener('change', function() {
      document.querySelectorAll('input[name="selected_address_id"]').forEach(r => {
        r.closest('.card').classList.remove('border-primary', 'border-2');
      });
      this.closest('.card').classList.add('border-primary', 'border-2');
    });
  });

  // Actualizar visual cuando se selecciona método de envío
  document.querySelectorAll('input[name="shipping_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
      document.querySelectorAll('input[name="shipping_method"]').forEach(r => {
        r.closest('label').classList.remove('border-primary', 'border-2', 'bg-primary', 'bg-opacity-10');
      });
      this.closest('label').classList.add('border-primary', 'border-2', 'bg-primary', 'bg-opacity-10');
    });
  });
</script>
