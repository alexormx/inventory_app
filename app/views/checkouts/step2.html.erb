<h1 class="mb-3">üöö Direcci√≥n y env√≠o</h1>
<div class="mb-3 d-flex justify-content-between align-items-center">
  <h5 class="mb-0">Selecciona una direcci√≥n</h5>
  <%= link_to 'Gestionar direcciones', shipping_addresses_path(return_to: 'checkout_step2'), class: 'btn btn-sm btn-outline-secondary' %>
 </div>
<% addresses = current_user.shipping_addresses.ordered %>
<% previous_info = @shipping_info || {} %>

<%= form_with url: checkout_step2_path, method: :post, local: true, id: 'shipping-step-form' do %>
  <% if addresses.any? %>
    <div class="list-group mb-4">
      <% addresses.each do |a| %>
        <% checked = if params[:selected_address_id].present?
                       params[:selected_address_id].to_s == a.id.to_s
                     elsif previous_info[:address_id]
                       previous_info[:address_id].to_s == a.id.to_s
                     else
                       a.default?
                     end %>
        <label class="list-group-item d-flex justify-content-between align-items-start">
          <span>
            <input type="radio" name="selected_address_id" value="<%= a.id %>" <%= 'checked' if checked %> class="form-check-input me-2" />
            <strong><%= a.label %></strong>
            <% if a.default? %><span class="badge bg-success ms-1">Default</span><% end %><br>
            <small class="text-muted"><%= a.full_name %> ‚Äî <%= a.to_one_line %></small>
          </span>
          <%= link_to 'Editar', edit_shipping_address_path(a), class: 'btn btn-sm btn-outline-secondary' %>
        </label>
      <% end %>
    </div>
  <% else %>
    <div class="alert alert-warning">No tienes direcciones. Agrega una primero.</div>
    <%= link_to 'Agregar direcci√≥n', shipping_addresses_path(return_to: 'checkout_step2'), class: 'btn btn-primary' %>
  <% end %>

<h5 class="mb-2">M√©todo de env√≠o</h5>
<p class="small text-muted">El costo puede variar seg√∫n la direcci√≥n seleccionada (placeholder).</p>
  <div class="row g-3">
    <div class="col-md-6">
      <% selected_method = if params[:shipping_method].present?
                             params[:shipping_method]
                           elsif previous_info[:method].present?
                             previous_info[:method]
                           else
                             'standard'
                           end %>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="shipping_method" id="ship_standard" value="standard" <%= 'checked' if selected_method == 'standard' %>>
        <label class="form-check-label" for="ship_standard">Est√°ndar (3-5 d√≠as) - Gratis</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="shipping_method" id="ship_express" value="express" <%= 'checked' if selected_method == 'express' %>>
        <label class="form-check-label" for="ship_express">Expr√©s (1-2 d√≠as) - $149.00</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="shipping_method" id="ship_pickup" value="pickup" <%= 'checked' if selected_method == 'pickup' %>>
        <label class="form-check-label" for="ship_pickup">Recoger en tienda</label>
      </div>
    </div>
  </div>
  <div class="text-end mt-4">
    <button type="submit" class="btn btn-primary">Continuar con el pago ‚û°Ô∏è</button>
  </div>
<% end %>
