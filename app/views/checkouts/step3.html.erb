<div class="checkout-progress mb-3">
  <div class="progress" style="height:6px;">
    <div class="progress-bar bg-primary" style="width:100%"></div>
  </div>
</div>
<h1 class="mb-3">üí≥ Pago</h1>

<% shipping_info = @shipping_info || {} %>
<% address = @selected_address %>
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Env√≠o</strong>
    <% if address %>
      <% shipping_method_record = ShippingMethod.find_by(code: shipping_info[:method]) %>
      <% method_label = shipping_method_record&.name || shipping_info[:method].to_s.titleize %>
      <small class="text-muted">M√©todo: <%= method_label %></small>
    <% end %>
  </div>
  <div class="card-body">
    <% if address %>
      <p class="mb-1"><strong><%= address.full_name %></strong></p>
      <p class="mb-1 small text-muted"><%= address.to_one_line %></p>
    <% else %>
      <div class="alert alert-warning mb-0">Direcci√≥n no seleccionada.</div>
    <% end %>
  </div>
</div>

<% session[:checkout_token] ||= SecureRandom.urlsafe_base64(32) %>
<%= form_with url: checkout_complete_path, method: :post, local: true, html: { id: 'checkout-complete-form' } do %>
  <%= hidden_field_tag :checkout_token, session[:checkout_token] %>
  <% payment_methods = PaymentMethod.active.ordered %>
  <div class="mb-3">
    <label class="form-label">M√©todo de pago</label>
    <div class="list-group">
      <% payment_methods.each do |pm| %>
        <label class="list-group-item d-flex gap-3 align-items-start">
          <input type="radio" name="payment_method" value="<%= pm.code %>" class="form-check-input mt-1" required>
          <div>
            <strong><%= pm.name %></strong>
            <% if pm.account_number.present? || pm.instructions.present? %>
              <br>
              <% if pm.account_holder.present? && pm.bank_name.present? %>
                <small class="text-muted"><%= pm.bank_name %> - <%= pm.account_holder %></small><br>
              <% end %>
              <% if pm.account_number.present? %>
                <small class="text-muted"><%= pm.clabe_or_card_label %>: <code><%= pm.account_number %></code></small>
              <% end %>
              <% if pm.instructions.present? %>
                <br><small class="text-muted"><%= pm.instructions %></small>
              <% end %>
            <% end %>
          </div>
        </label>
      <% end %>
    </div>
    <% if payment_methods.empty? %>
      <div class="alert alert-warning mt-2">No hay m√©todos de pago disponibles.</div>
    <% end %>
  </div>

  <h5 class="mt-4">üßæ Resumen del pedido:</h5>
  <ul class="list-group mb-3">
    <% pending_present = false %>
    <% @cart.items.each do |product, qty| %>
      <% split = product.split_immediate_and_pending(qty) %>
      <% pending_present ||= split[:pending].positive? %>
      <li class="list-group-item">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong><%= product.product_name %></strong>
            <div class="small text-muted">
              <%= split[:immediate] %> inmediata(s)
              <% if split[:pending].positive? %>
                ‚Ä¢ <%= split[:pending] %> <%= split[:pending_type] == :preorder ? 'preventa' : 'sobre pedido' %>
                <% if split[:pending_type] == :preorder %>
                  <% res = PreorderReservation.where(product: product, user: current_user, status: :pending).order(:reserved_at).first %>
                  <% if res&.position %> (posici√≥n <%= res.position %>)<% end %>
                <% end %>
              <% end %>
            </div>
          </div>
          <span><%= number_to_currency(product.selling_price * qty) %></span>
        </div>
      </li>
    <% end %>
  <% shipping_method_for_cost = ShippingMethod.find_by(code: shipping_info[:method]) %>
  <% shipping_cost = shipping_method_for_cost&.base_cost || 0 %>
    <li class="list-group-item d-flex justify-content-between">
      <span>Subtotal</span>
      <span><%= number_to_currency(@cart.total) %></span>
    </li>
    <li class="list-group-item d-flex justify-content-between">
      <span>Env√≠o<% if shipping_method_for_cost %> (<%= shipping_method_for_cost.name %>)<% end %></span>
      <span><%= shipping_cost.zero? ? 'Gratis' : number_to_currency(shipping_cost) %></span>
    </li>
    <li class="list-group-item d-flex justify-content-between">
      <strong>Total</strong>
      <strong><%= number_to_currency(@cart.total + shipping_cost) %></strong>
    </li>
  </ul>
  <% if pending_present %>
    <div class="alert alert-warning small">
      Algunas unidades no est√°n disponibles de inmediato. Las de <strong>preventa</strong> se surtir√°n cuando el producto se lance y las de <strong>sobre pedido</strong> cuando se reciba nuevo stock. Te notificaremos.
    </div>
    <div class="form-check mb-4">
      <input class="form-check-input" type="checkbox" value="1" id="accept_pending" name="accept_pending" required>
      <label class="form-check-label" for="accept_pending">
  Acepto los tiempos extendidos de entrega para las unidades en preventa / sobre pedido.
      </label>
    </div>
  <% end %>

  <div class="text-end">
    <%= submit_tag "‚úÖ Finalizar compra", class: "btn btn-success", data: { disable_with: 'Procesando‚Ä¶' } %>
  </div>
<% end %>

<script>
  (function(){
    const form = document.getElementById('checkout-complete-form');
    if(!form) return;
    form.addEventListener('submit', function(e){
      const btn = form.querySelector('input[type=submit],button[type=submit]');
      if(btn){ btn.disabled = true; }
    });
  })();
</script>
