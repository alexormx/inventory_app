<%= render 'checkouts/progress_bar', current_step: 3 %>

<% shipping_info = @shipping_info || {} %>
<% address = @selected_address %>
<% shipping_method_record = ShippingMethod.find_by(code: shipping_info[:method]) %>
<% shipping_cost = shipping_method_record&.base_cost || 0 %>

<div class="row">
  <div class="col-lg-8">
    <!-- Resumen de envío (editable) -->
    <div class="card mb-4">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fa fa-truck me-2"></i>Información de envío</h6>
        <%= link_to checkout_step2_path, class: 'btn btn-sm btn-outline-secondary' do %>
          <i class="fa fa-pencil me-1"></i> Modificar
        <% end %>
      </div>
      <div class="card-body">
        <% if address %>
          <div class="row">
            <div class="col-md-6">
              <small class="text-muted text-uppercase">Dirección</small>
              <p class="mb-0">
                <strong><%= address.full_name %></strong><br>
                <%= address.line1 %><br>
                <%= address.city %>, <%= address.state %> <%= address.postal_code %>
                <% if address.respond_to?(:phone) && address.phone.present? %><br><i class="fa fa-phone me-1 text-muted"></i><%= address.phone %><% end %>
              </p>
            </div>
            <div class="col-md-6">
              <small class="text-muted text-uppercase">Método de envío</small>
              <p class="mb-0">
                <strong><%= shipping_method_record&.name || 'No seleccionado' %></strong>
                <% if shipping_method_record&.description.present? %>
                  <br><small class="text-muted"><%= shipping_method_record.description %></small>
                <% end %>
              </p>
            </div>
          </div>
        <% else %>
          <div class="alert alert-warning mb-0">
            <i class="fa fa-exclamation-triangle me-2"></i>
            Dirección no seleccionada. <%= link_to 'Volver al paso anterior', checkout_step2_path %>.
          </div>
        <% end %>
      </div>
    </div>

    <!-- Método de pago -->
    <% session[:checkout_token] ||= SecureRandom.urlsafe_base64(32) %>
    <%= form_with url: checkout_complete_path, method: :post, local: true, html: { id: 'checkout-complete-form' } do %>
      <%= hidden_field_tag :checkout_token, session[:checkout_token] %>

      <div class="card mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-credit-card me-2"></i>Método de pago</h6>
        </div>
        <div class="card-body">
          <% payment_methods = PaymentMethod.active.ordered %>

          <% if payment_methods.any? %>
            <div class="d-flex flex-column gap-2">
              <% payment_methods.each_with_index do |pm, idx| %>
                <label class="list-group-item list-group-item-action rounded border p-3" style="cursor: pointer;">
                  <div class="d-flex align-items-start">
                    <input type="radio" name="payment_method" value="<%= pm.code %>" class="form-check-input me-3 mt-1" required <%= 'checked' if idx == 0 %>>
                    <div class="flex-grow-1">
                      <strong><%= pm.name %></strong>
                      <% if pm.account_number.present? || pm.instructions.present? %>
                        <div class="mt-2 p-2 bg-light rounded small">
                          <% if pm.bank_name.present? && pm.account_holder.present? %>
                            <div class="text-muted mb-1">
                              <i class="fa fa-university me-1"></i><%= pm.bank_name %> • <%= pm.account_holder %>
                            </div>
                          <% end %>
                          <% if pm.account_number.present? %>
                            <div class="d-flex align-items-center gap-2">
                              <span class="text-muted"><%= pm.clabe_or_card_label %>:</span>
                              <code class="bg-white px-2 py-1 rounded border user-select-all"><%= pm.account_number %></code>
                              <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="navigator.clipboard.writeText('<%= pm.account_number %>')" title="Copiar">
                                <i class="fa fa-copy"></i>
                              </button>
                            </div>
                          <% end %>
                          <% if pm.instructions.present? %>
                            <div class="text-muted mt-1"><i class="fa fa-info-circle me-1"></i><%= pm.instructions %></div>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </label>
              <% end %>
            </div>
          <% else %>
            <div class="alert alert-warning mb-0">No hay métodos de pago disponibles.</div>
          <% end %>
        </div>
      </div>

      <!-- Resumen de productos -->
      <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="fa fa-shopping-bag me-2"></i>Productos en tu pedido</h6>
          <%= link_to checkout_step1_path, class: 'btn btn-sm btn-outline-secondary' do %>
            <i class="fa fa-pencil me-1"></i> Modificar
          <% end %>
        </div>
        <div class="card-body p-0">
          <% pending_present = false %>
          <ul class="list-group list-group-flush">
            <% @cart.items.each do |item| %>
              <% product = item[:product] %>
              <% qty = item[:quantity] %>
              <% condition = item[:condition] %>
              <% item_price = item[:price] %>
              <% collectible = item[:collectible] %>
              <% split = collectible ? nil : product.split_immediate_and_pending(qty) %>
              <% pending_present ||= (split && split[:pending].positive?) %>
              <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center gap-3">
                    <% if product.product_images.attached? %>
                      <%= image_tag product.product_images.first.variant(resize_to_limit: [50, 50]), class: "rounded", style: "width: 50px; height: 50px; object-fit: cover;" %>
                    <% end %>
                    <div>
                      <strong><%= product.product_name %></strong>
                      <% if collectible %>
                        <span class="badge bg-warning-subtle text-warning ms-1" title="Pieza coleccionable única">
                          <i class="fas fa-gem me-1"></i><%= item[:label] %>
                        </span>
                      <% end %>
                      <div class="small text-muted">
                        <% if collectible %>
                          <span class="badge bg-success">1 pieza única</span>
                        <% else %>
                          <span class="badge bg-success"><%= split[:immediate] %> disponible(s)</span>
                          <% if split[:pending].positive? %>
                            <span class="badge bg-warning text-dark">
                              <%= split[:pending] %> <%= split[:pending_type] == :preorder ? 'preventa' : 'sobre pedido' %>
                            </span>
                            <% if split[:pending_type] == :preorder %>
                              <% res = PreorderReservation.where(product: product, user: current_user, status: :pending).order(:reserved_at).first %>
                              <% if res&.position %><small>(posición #<%= res.position %>)</small><% end %>
                            <% end %>
                          <% end %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                  <div class="text-end">
                    <div class="text-muted small"><%= qty %> × <%= number_to_currency(item_price) %></div>
                    <strong><%= number_to_currency(item_price * qty) %></strong>
                  </div>
                </div>
              </li>
            <% end %>
          </ul>
        </div>
      </div>

      <!-- Aviso de preventa/backorder -->
      <% if pending_present %>
        <div class="alert alert-warning">
          <div class="d-flex align-items-start gap-2">
            <i class="fa fa-clock fa-lg mt-1"></i>
            <div>
              <strong>Algunos productos tienen tiempos de espera</strong>
              <p class="mb-2 small">
                Las unidades en <strong>preventa</strong> se enviarán cuando el producto se lance.
                Las unidades <strong>sobre pedido</strong> se enviarán cuando llegue nuevo inventario.
              </p>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="accept_pending" name="accept_pending" required>
                <label class="form-check-label" for="accept_pending">
                  Acepto los tiempos extendidos de entrega para estos productos
                </label>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Botones de navegación -->
      <div class="d-flex justify-content-between align-items-center mt-4">
        <%= link_to checkout_step2_path, class: 'btn btn-outline-secondary' do %>
          <i class="fa fa-arrow-left me-1"></i> Volver
        <% end %>
        <button type="submit" class="btn btn-success btn-lg" data-disable-with="Procesando...">
          <i class="fa fa-check me-2"></i>Finalizar compra
        </button>
      </div>
    <% end %>
  </div>

  <div class="col-lg-4 mt-4 mt-lg-0">
    <%= render 'checkouts/cart_summary',
        cart: @cart,
        show_shipping: true,
        shipping_cost: shipping_cost,
        shipping_method_name: shipping_method_record&.name %>

    <!-- Seguridad y confianza -->
    <div class="card mt-3">
      <div class="card-body text-center">
        <div class="text-muted small">
          <i class="fa fa-lock me-1"></i> Pago 100% seguro<br>
          <i class="fa fa-shield-alt me-1"></i> Productos originales garantizados<br>
          <i class="fa fa-undo me-1"></i> Devoluciones sin complicaciones
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    const form = document.getElementById('checkout-complete-form');
    if(!form) return;
    form.addEventListener('submit', function(e){
      const btn = form.querySelector('button[type=submit]');
      if(btn){
        btn.disabled = true;
        btn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Procesando...';
      }
    });

    // Highlight selected payment method
    document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.querySelectorAll('input[name="payment_method"]').forEach(r => {
          r.closest('label').classList.remove('border-primary', 'border-2', 'bg-primary', 'bg-opacity-10');
        });
        this.closest('label').classList.add('border-primary', 'border-2', 'bg-primary', 'bg-opacity-10');
      });
      // Trigger on load for pre-selected
      if(radio.checked) {
        radio.closest('label').classList.add('border-primary', 'border-2', 'bg-primary', 'bg-opacity-10');
      }
    });
  })();
</script>
