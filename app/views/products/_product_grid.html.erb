<%= turbo_frame_tag "products_grid" do %>
  <%# Chips de filtros activos dentro del frame para actualizar en cada request %>
  <%
    selected_categories = Array(params[:categories]).reject(&:blank?)
    selected_brands = Array(params[:brands]).reject(&:blank?)
    price_min = params[:price_min].presence
    price_max = params[:price_max].presence
    in_stock_only = ActiveModel::Type::Boolean.new.cast(params[:in_stock])
    backorder_only = ActiveModel::Type::Boolean.new.cast(params[:backorder])
    preorder_only = ActiveModel::Type::Boolean.new.cast(params[:preorder])
    has_filters = selected_categories.any? || selected_brands.any? || price_min || price_max || in_stock_only || backorder_only || preorder_only
  %>

  <% if @q.present? %>
    <p class="text-muted small mb-2">Resultados para "<strong><%= @q %></strong>": <%= @products.total_count %></p>
  <% else %>
    <p class="text-muted small mb-2">Productos encontrados: <%= @products.total_count %></p>
  <% end %>

  <% if has_filters %>
    <div class="active-filters-chips mb-3 d-flex flex-wrap gap-2 align-items-center" style="position: relative; z-index: 10;">
      <span class="text-muted small fw-semibold">Filtros activos:</span>

      <% selected_categories.each do |cat| %>
        <% clear_url = catalog_path(request.query_parameters.merge(categories: selected_categories - [cat], page: nil)) %>
        <span class="filter-chip">
          <i class="fas fa-tag me-1"></i><%= cat %>
          <%= link_to clear_url, class: "chip-remove", "aria-label": "Remover #{cat}", title: "Remover filtro", data: { turbo_frame: "products_grid" } do %>&times;<% end %>
        </span>
      <% end %>

      <% selected_brands.each do |brand| %>
        <% clear_url = catalog_path(request.query_parameters.merge(brands: selected_brands - [brand], page: nil)) %>
        <span class="filter-chip">
          <i class="fas fa-copyright me-1"></i><%= brand %>
          <%= link_to clear_url, class: "chip-remove", "aria-label": "Remover #{brand}", title: "Remover filtro", data: { turbo_frame: "products_grid" } do %>&times;<% end %>
        </span>
      <% end %>

      <% if price_min || price_max %>
        <% clear_url = catalog_path(request.query_parameters.except(:price_min, :price_max).merge(page: nil)) %>
        <span class="filter-chip">
          <i class="fas fa-dollar-sign me-1"></i>
          <% if price_min && price_max %>
            $<%= price_min %> - $<%= price_max %>
          <% elsif price_min %>
            Desde $<%= price_min %>
          <% else %>
            Hasta $<%= price_max %>
          <% end %>
          <%= link_to clear_url, class: "chip-remove", "aria-label": "Remover filtro de precio", title: "Remover filtro", data: { turbo_frame: "products_grid" } do %>&times;<% end %>
        </span>
      <% end %>

      <% if in_stock_only %>
        <% clear_url = catalog_path(request.query_parameters.except(:in_stock).merge(page: nil)) %>
        <span class="filter-chip">
          <i class="fas fa-check-circle me-1"></i>En stock
          <%= link_to clear_url, class: "chip-remove", "aria-label": "Remover filtro en stock", title: "Remover filtro", data: { turbo_frame: "products_grid" } do %>&times;<% end %>
        </span>
      <% end %>

      <% if backorder_only %>
        <% clear_url = catalog_path(request.query_parameters.except(:backorder).merge(page: nil)) %>
        <span class="filter-chip">
          <i class="fas fa-clock me-1"></i>Backorder
          <%= link_to clear_url, class: "chip-remove", "aria-label": "Remover filtro backorder", title: "Remover filtro", data: { turbo_frame: "products_grid" } do %>&times;<% end %>
        </span>
      <% end %>

      <% if preorder_only %>
        <% clear_url = catalog_path(request.query_parameters.except(:preorder).merge(page: nil)) %>
        <span class="filter-chip">
          <i class="fas fa-calendar-alt me-1"></i>Preventa
          <%= link_to clear_url, class: "chip-remove", "aria-label": "Remover filtro preventa", title: "Remover filtro", data: { turbo_frame: "products_grid" } do %>&times;<% end %>
        </span>
      <% end %>

      <%= link_to catalog_path(sort: @sort, q: @q), class: "btn btn-outline-secondary btn-sm", data: { turbo_frame: "products_grid" } do %>
        <i class="fas fa-times me-1"></i>Limpiar todos
      <% end %>
    </div>
  <% end %>
  <div class="row row-cols-2 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3" id="product-grid-content" role="list">
    <% @products.each do |product| %>
      <div class="col product-card-wrapper" data-product-id="<%= product.id %>" role="listitem">
        <article class="card h-100 border-0 shadow-sm d-flex flex-column catalog-item position-relative hover-lift">
          <!-- Badges de disponibilidad -->
          <% if product.active? %>
            <% on_hand_cached = @on_hand_counts[product.id] || 0 %>
            <span class="position-absolute top-0 start-0 m-1" role="status" aria-live="polite"><%= stock_badge(product, on_hand_override: on_hand_cached) %></span>
          <% else %>
            <span class="badge bg-secondary position-absolute top-0 start-0 m-1" role="status">No disp.</span>
          <% end %>
          <% if product.active? %>
            <%= link_to product_path(product), class: "d-block p-2", aria: { label: "Ver detalles de #{product.product_name}" }, data: { turbo_frame: "_top" } do %>
              <% if product.product_images.attached? %>
                <%= responsive_attachment_image product.product_images.first,
                  alt: product.product_name,
                  widths: [60,96,150,200],
                  css_class: "product-image mx-auto d-block",
                  square: true %>
              <% else %>
                <%= image_tag "placeholder.png", class: "product-image mx-auto d-block", alt: "Imagen no disponible para #{product.product_name}" %>
              <% end %>
            <% end %>
          <% else %>
            <div class="d-block p-2 opacity-50" title="Producto inactivo">
              <% if product.product_images.attached? %>
                <%= responsive_attachment_image product.product_images.first,
                  alt: product.product_name,
                  widths: [60,96,150,200],
                  css_class: "product-image mx-auto d-block",
                  square: true %>
              <% else %>
                <%= image_tag "placeholder.png", class: "product-image mx-auto d-block", alt: "Imagen no disponible" %>
              <% end %>
            </div>
          <% end %>
          <div class="card-body text-center p-2 d-flex flex-column w-100">
            <h2 class="card-title h6 mb-1" title="<%= product.product_name %>">
              <% if product.active? %>
                <%= link_to product.product_name, product_path(product), class: "text-decoration-none text-dark", data: { turbo_frame: "_top" } %>
              <% else %>
                <span class="text-muted" aria-disabled="true"><%= product.product_name %></span>
              <% end %>
            </h2>
            <p class="card-text text-danger fw-bold small mb-2" role="text">
              <span class="visually-hidden">Precio: </span><%= number_to_currency(product.selling_price) %>
            </p>
            <% if (eta = stock_eta(product)) %>
              <p class="text-muted extra-small mb-2"><i class="fa fa-clock me-1" aria-hidden="true"></i><span class="visually-hidden">Disponible: </span><%= eta %></p>
            <% end %>
            <% if product.active? %>
              <% on_hand = @on_hand_counts[product.id] || 0 %>
              <% disabled = (on_hand <= 0 && !product.oversell_allowed?) %>
              <%= button_to cart_items_path,
                            params: { product_id: product.id },
                            method: :post,
                            class: "btn btn-danger btn-sm mt-auto #{'disabled' if disabled}",
                            disabled: disabled,
                            title: (disabled ? 'Sin stock disponible' : 'Agregar al carrito'),
                            aria: { label: (disabled ? 'Sin stock' : "Agregar #{product.product_name} al carrito") } do %>
                <i class="fas fa-cart-plus" aria-hidden="true"></i>
                <span class="visually-hidden"><%= disabled ? 'Sin stock' : 'Agregar al carrito' %></span>
              <% end %>
            <% else %>
              <button class="btn btn-outline-secondary btn-sm mt-auto" disabled title="Producto no disponible" aria-label="Producto no disponible">
                <i class="fas fa-ban" aria-hidden="true"></i>
              </button>
            <% end %>
          </div>
        </article>
      </div>
    <% end %>
  </div>

  <% if @products.empty? %>
    <div class="alert alert-warning mt-4 text-center" role="alert">
      <i class="fas fa-search fa-2x mb-3 text-warning"></i>
      <h5>No se encontraron productos</h5>
      <% if @q.present? %>
        <p class="mb-2">No encontramos productos que coincidan con "<strong><%= @q %></strong>".</p>
        <p class="small text-muted">Intenta con otra búsqueda o limpia los filtros.</p>
      <% else %>
        <p class="mb-2">No hay productos disponibles con los filtros seleccionados.</p>
      <% end %>
      <%= link_to catalog_path, class: "btn btn-outline-secondary btn-sm mt-2", data: { turbo_frame: "products_grid" } do %>
        <i class="fas fa-redo me-1"></i>Ver todos los productos
      <% end %>
    </div>
  <% end %>

  <%# Paginación mejorada con info %>
  <% if @products.total_pages > 1 %>
    <div class="mt-4" id="pagination-container">
      <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-3 mb-3">
        <div class="text-muted small">
          <%= products_range_text(@products) %>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="text-muted small">Página <%= @products.current_page %> de <%= @products.total_pages %></span>
        </div>
      </div>
      <div class="d-flex justify-content-center">
        <%= paginate @products %>
      </div>
    </div>
  <% end %>
<% end %>
