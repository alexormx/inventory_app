<%= turbo_frame_tag "products_grid" do %>
  <div class="row row-cols-2 row-cols-sm-3 row-cols-md-3 row-cols-lg-5 g-3" id="product-grid-content">
    <% @products.each do |product| %>
      <div class="col product-card-wrapper" data-product-id="<%= product.id %>">
        <div class="card h-100 border-0 shadow-sm d-flex flex-column catalog-item position-relative hover-lift">
          <!-- Badges de disponibilidad -->
          <% if product.active? %>
            <% on_hand_cached = @on_hand_counts[product.id] || 0 %>
            <span class="position-absolute top-0 start-0 m-1"><%= stock_badge(product, on_hand_override: on_hand_cached) %></span>
          <% else %>
            <span class="badge bg-secondary position-absolute top-0 start-0 m-1">No disp.</span>
          <% end %>
          <% if product.active? %>
            <%= link_to product_path(product), class: "d-block p-2" do %>
              <% if product.product_images.attached? %>
                <%= responsive_attachment_image product.product_images.first,
                  alt: product.product_name,
                  widths: [60,96,150,200],
                  css_class: "product-image mx-auto d-block",
                  square: true %>
              <% else %>
                <%= image_tag "placeholder.png", class: "product-image mx-auto d-block", alt: "Imagen no disponible" %>
              <% end %>
            <% end %>
          <% else %>
            <div class="d-block p-2 opacity-50" title="Producto inactivo">
              <% if product.product_images.attached? %>
                <%= responsive_attachment_image product.product_images.first,
                  alt: product.product_name,
                  widths: [60,96,150,200],
                  css_class: "product-image mx-auto d-block",
                  square: true %>
              <% else %>
                <%= image_tag "placeholder.png", class: "product-image mx-auto d-block", alt: "Imagen no disponible" %>
              <% end %>
            </div>
          <% end %>
          <div class="card-body text-center p-2 d-flex flex-column w-100">
            <h6 class="card-title mb-1" title="<%= product.product_name %>">
              <% if product.active? %>
                <%= link_to product.product_name, product_path(product), class: "text-decoration-none text-dark" %>
              <% else %>
                <span class="text-muted" aria-disabled="true"><%= product.product_name %></span>
              <% end %>
            </h6>
            <p class="card-text text-danger fw-bold small mb-2">
              <%= number_to_currency(product.selling_price) %>
            </p>
            <% if (eta = stock_eta(product)) %>
              <p class="text-muted extra-small mb-2"><i class="fa fa-clock me-1"></i><%= eta %></p>
            <% end %>
            <% if product.active? %>
              <% on_hand = @on_hand_counts[product.id] || 0 %>
              <% disabled = (on_hand <= 0 && !product.oversell_allowed?) %>
              <%= button_to cart_items_path,
                            params: { product_id: product.id },
                            method: :post,
                            class: "btn btn-danger btn-sm mt-auto #{'disabled' if disabled}",
                            disabled: disabled,
                            title: (disabled ? 'Sin stock disponible' : 'Agregar al carrito'),
                            aria: { label: (disabled ? 'Sin stock' : "Agregar #{product.product_name} al carrito") } do %>
                <i class="fas fa-cart-plus"></i>
              <% end %>
            <% else %>
              <button class="btn btn-outline-secondary btn-sm mt-auto" disabled title="Producto no disponible">
                <i class="fas fa-ban"></i>
              </button>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <% if @products.empty? %>
    <div class="alert alert-warning mt-4" role="alert">
      <% if @q.present? %>
        No encontramos productos que coincidan con "<strong><%= @q %></strong>". Intenta con otra b√∫squeda o limpia los filtros.
      <% else %>
        No hay productos disponibles con los filtros seleccionados.
      <% end %>
    </div>
  <% end %>

  <div class="mt-4 d-flex justify-content-center" id="pagination-container">
    <%= paginate @products %>
  </div>
<% end %>
