<div class="container my-5" id="product-gallery">
  <%# Preload LCP ahora gestionado por helper en layout (lcp_preload_product_image) %>
  <div class="row g-4">

    <!-- Image Gallery -->
    <div class="col-lg-5">
      <% if @product.product_images.attached? %>
        <div data-controller="gallery">
          <div class="position-relative gallery-slides-wrapper" data-gallery-target="slides">
            <div class="gallery-slides-track" data-gallery-target="track">
              <% @product.product_images.each_with_index do |img, idx| %>
                <div class="gallery-slide" data-index="<%= idx %>" aria-hidden="<%= idx == 0 ? 'false' : 'true' %>">
      <%= responsive_attachment_image img,
        alt: @product.product_name,
        widths: [320,480,600],
        css_class: "img-fluid rounded shadow-sm border w-100",
        square: true,
        fetch_priority: (idx == 0 ? 'high' : nil) %>
                </div>
              <% end %>
            </div>

            <button type="button" class="btn btn-light position-absolute top-50 start-0 translate-middle-y shadow-sm" aria-label="Anterior" data-action="click->gallery#prev">&lsaquo;</button>
            <button type="button" class="btn btn-light position-absolute top-50 end-0 translate-middle-y shadow-sm" aria-label="Siguiente" data-action="click->gallery#next">&rsaquo;</button>
          </div>

          <div class="d-flex flex-wrap gap-2 mt-3" data-gallery-target="thumbnails" data-action="keydown->gallery#keydown">
            <% @product.product_images.each_with_index do |img, index| %>
        <button type="button"
            class="p-0 border-0 bg-transparent thumb-btn"
            data-action="click->gallery#show"
            data-index="<%= index %>"
            aria-label="Ver imagen <%= index + 1 %>"
            tabindex="0" role="button">
          <%= responsive_attachment_image img,
            alt: "Miniatura #{index + 1}",
            widths: [40,56,80],
            css_class: "thumbnail-image img-thumbnail #{'border-primary' if index == 0}",
            square: true,
            loading: 'lazy',
            id: nil %>
        </button>
            <% end %>
          </div>
        </div>
      <% else %>
        <%= image_tag "placeholder.png", class: "img-fluid rounded border shadow-sm", alt: "Imagen no disponible" %>
      <% end %>
    </div>

    <!-- Product Info -->
    <div class="col-lg-7">
      <h1 class="fw-bold mb-3"><%= @product.product_name %></h1>
      <p class="text-muted">SKU: <%= @product.product_sku %></p>
      <p class="text-muted">Marca: <%= @product.brand %></p>
      <p class="text-muted">Categoría: <%= @product.category %></p>

      <h3 class="text-success fw-bold"><%= number_to_currency(@product.selling_price) %></h3>

      <% if @product.active? %>
  <% on_hand = @product.current_on_hand %>
        <div class="mb-2">
          <%= stock_badge(@product) %>
          <% if (eta = stock_eta(@product)) %>
            <div class="small text-muted mt-1"><i class="fa fa-clock me-1"></i><%= eta %></div>
          <% end %>
        </div>
  <% disabled = (on_hand <= 0 && !@product.oversell_allowed?) %>
        <%= button_to cart_items_path,
                      params: { product_id: @product.id },
                      method: :post,
                      class: "btn btn-danger btn-lg my-3 w-100 #{'disabled' if disabled}",
                      disabled: disabled,
                      title: (disabled ? 'Sin stock disponible' : 'Agregar al carrito') do %>
          <i class="fas fa-cart-plus"></i> <%= disabled ? 'Sin stock' : 'Agregar al carrito' %>
        <% end %>
      <% else %>
        <span class="badge bg-secondary mb-2">No disponible</span>
        <button class="btn btn-secondary btn-lg my-3 w-100" disabled>
          <i class="fas fa-ban"></i> No disponible
        </button>
      <% end %>
    </div>
  </div>

  <!-- Description -->
  <hr class="my-5">
  <div>
    <h4 class="mb-3"><i class="fas fa-align-left text-primary me-2"></i> Descripción</h4>
    <p class="text-muted">
      <%= @product.description.presence || "Este producto no tiene una descripción disponible por el momento." %>
    </p>
  </div>

  <!-- Details -->
  <div class="mt-4">
    <h4 class="mb-3"><i class="fas fa-list-alt text-primary me-2"></i> Detalles</h4>
    <% if @product.custom_attributes.present? %>
      <table class="table table-hover align-middle">
        <tbody>
          <% @product.parsed_custom_attributes.each do |key, value| %>
            <tr>
              <th class="text-capitalize" style="width: 200px;"><%= key %></th>
              <td><%= value %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="text-muted">No hay detalles adicionales para este producto.</p>
    <% end %>
  </div>
</div>
