<div class="container py-4 product-show" data-controller="productMeta">
  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb mb-0">
      <% product_breadcrumbs(@product).each_with_index do |crumb, index| %>
        <li class="breadcrumb-item <%= 'active' if crumb[:url].nil? %>" <%= 'aria-current="page"'.html_safe if crumb[:url].nil? %>>
          <% if crumb[:url] %>
            <%= link_to crumb[:name], crumb[:url], class: "text-decoration-none" %>
          <% else %>
            <%= crumb[:name] %>
          <% end %>
        </li>
      <% end %>
    </ol>
  </nav>

  <div class="row gy-4">
    <div class="col-lg-6">
      <% if @product.product_images.attached? %>
        <%= render 'products/gallery', product: @product %>
      <% else %>
        <%= image_tag 'placeholder.png', class: 'w-100 rounded shadow-sm', alt: 'Imagen no disponible' %>
      <% end %>
    </div>
    <div class="col-lg-6 col-xl-5 offset-xl-1">
      <%= render 'products/summary_panel', product: @product %>
    </div>
  </div>

  <div class="row mt-5 g-4">
    <div class="col-lg-8">
      <!-- Información básica siempre visible -->
      <div class="card border-0 shadow-sm mb-4" id="info-basica">
        <div class="card-body">
          <h2 class="h5 fw-semibold mb-3"><i class="fas fa-info-circle text-primary me-2"></i>Información del Producto</h2>
          <div class="row g-3">
            <div class="col-sm-6">
              <div class="d-flex align-items-center">
                <i class="fas fa-tag text-muted me-2"></i>
                <div>
                  <small class="text-muted d-block">Categoría</small>
                  <strong><%= @product.category %></strong>
                </div>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="d-flex align-items-center">
                <i class="fas fa-copyright text-muted me-2"></i>
                <div>
                  <small class="text-muted d-block">Marca</small>
                  <strong><%= @product.brand %></strong>
                </div>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="d-flex align-items-center">
                <i class="fas fa-barcode text-muted me-2"></i>
                <div>
                  <small class="text-muted d-block">SKU</small>
                  <strong><%= @product.product_sku %></strong>
                </div>
              </div>
            </div>
            <% if @product.barcode.present? %>
            <div class="col-sm-6">
              <div class="d-flex align-items-center">
                <i class="fas fa-qrcode text-muted me-2"></i>
                <div>
                  <small class="text-muted d-block">Código de Barras</small>
                  <strong><%= @product.barcode %></strong>
                </div>
              </div>
            </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm" id="descripcion" data-product-description>
        <div class="card-body">
          <h2 class="h5 fw-semibold mb-3"><i class="fas fa-align-left text-primary me-2"></i>Descripción</h2>
          <% if @product.description.present? %>
            <p class="text-muted mb-0" style="white-space: pre-line;"><%= @product.description %></p>
          <% else %>
            <div class="alert alert-light border mb-0 text-center py-4">
              <i class="fas fa-info-circle text-muted fa-2x mb-2"></i>
              <p class="text-muted mb-0">Este producto aún no tiene una descripción detallada.</p>
              <p class="text-muted small mb-0">Estamos trabajando para agregarlo pronto.</p>
            </div>
          <% end %>
        </div>
      </div>

      <div class="card border-0 shadow-sm mt-4" id="detalles">
        <div class="card-body">
          <h2 class="h5 fw-semibold mb-3"><i class="fas fa-list-alt text-primary me-2"></i>Detalles del Producto</h2>
          <% if @product.custom_attributes.present? && @product.parsed_custom_attributes.any? %>
            <div class="row row-cols-1 row-cols-sm-2 g-3 small">
              <% @product.parsed_custom_attributes.each do |key, value| %>
                <div class="col d-flex">
                  <div class="w-50 text-muted text-capitalize fw-semibold"><%= key.to_s.humanize %></div>
                  <div class="flex-grow-1"><%= value == true ? "Sí" : (value == false ? "No" : value) %></div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="alert alert-light border mb-0 text-center py-3">
              <i class="fas fa-box-open text-muted fa-lg mb-2"></i>
              <p class="text-muted small mb-0">No hay atributos adicionales disponibles para este producto.</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <%# Productos relacionados %>
      <% if @related_products.present? %>
        <div class="card border-0 shadow-sm sticky-sidebar">
          <div class="card-body">
            <h3 class="h6 fw-semibold mb-3">
              <i class="fas fa-th-large text-danger me-2"></i>También te puede interesar
            </h3>
            <div class="related-products">
              <% @related_products.each do |related| %>
                <div class="related-product-item d-flex align-items-center gap-3 mb-3 pb-3 border-bottom">
                  <%= link_to product_path(related), class: "flex-shrink-0" do %>
                    <% if related.product_images.attached? %>
                      <%= responsive_attachment_image related.product_images.first,
                          alt: related.product_name,
                          widths: [60, 80],
                          css_class: "related-product-image rounded",
                          square: true %>
                    <% else %>
                      <%= image_tag "placeholder.png", class: "related-product-image rounded", width: 60, height: 60, alt: "Imagen no disponible" %>
                    <% end %>
                  <% end %>
                  <div class="flex-grow-1 min-width-0">
                    <%= link_to product_path(related), class: "text-decoration-none" do %>
                      <h6 class="mb-1 text-dark small fw-semibold text-truncate" title="<%= related.product_name %>">
                        <%= related.product_name %>
                      </h6>
                    <% end %>
                    <div class="d-flex align-items-center gap-2">
                      <span class="text-danger fw-bold small"><%= number_to_currency(related.selling_price) %></span>
                      <% on_hand = @related_on_hand[related.id] || 0 %>
                      <% if on_hand > 0 %>
                        <span class="badge bg-success-subtle text-success extra-small">En stock</span>
                      <% elsif related.backorder_allowed? %>
                        <span class="badge bg-warning-subtle text-warning extra-small">Backorder</span>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
            <%= link_to catalog_path(categories: [@product.category]), class: "btn btn-outline-danger btn-sm w-100 mt-2" do %>
              <i class="fas fa-arrow-right me-1"></i>Ver más en <%= @product.category %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
.product-show .product-gallery .gallery-viewport{overflow:hidden;border-radius:.5rem}
.product-show .gallery-track{display:flex;transition:transform .45s cubic-bezier(.4,.1,.2,1)}
.product-show .gallery-slide{flex:0 0 100%;padding:2px}
.product-show .gallery-nav{position:absolute;top:50%;transform:translateY(-50%);background:#fff;border:0;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.15);cursor:pointer;font-size:20px;color:#444}
.product-show .gallery-nav.prev{left:8px}.product-show .gallery-nav.next{right:8px}
.product-show .gallery-thumbs .thumbnail-image{width:72px;height:72px;object-fit:cover}
.product-summary{position:sticky;top:calc(var(--banner-height,0px) + var(--nav-height,60px) + 1rem)}
.product-summary .line-clamp{-webkit-line-clamp:3;-webkit-box-orient:vertical;display:-webkit-box;overflow:hidden}
@media (max-width: 991px){.product-summary{position:static}}

/* Related Products */
.product-show .sticky-sidebar{position:sticky;top:calc(var(--banner-height,0px) + var(--nav-height,60px) + 1rem)}
.product-show .related-product-image{width:60px;height:60px;object-fit:contain;background:#f8f9fa}
.product-show .related-product-item:last-child{border-bottom:0!important;margin-bottom:0!important;padding-bottom:0!important}
.product-show .related-product-item:hover .text-dark{color:#dc3545!important}
.product-show .min-width-0{min-width:0}
.product-show .extra-small{font-size:0.7rem;padding:0.2em 0.5em}
@media (max-width: 991px){.product-show .sticky-sidebar{position:static;margin-top:1.5rem}}
</style>
